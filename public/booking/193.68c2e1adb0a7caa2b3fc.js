(self.webpackChunksymbiose=self.webpackChunksymbiose||[]).push([[193],{3193:(t,n,e)=>{"use strict";e.r(n),e.d(n,{AppInBookingModule:()=>le});var i=e(2458),o=e(521),a=e(7430),s=e(6947),r=e(3423),c=e(7716);let d=(()=>{class t{constructor(t){this.auth=t}ngOnInit(){console.log("BookingComponent init")}}return t.\u0275fac=function(n){return new(n||t)(c.Y36(s.Tq))},t.\u0275cmp=c.Xpm({type:t,selectors:[["booking"]],decls:0,vars:0,template:function(t,n){},encapsulation:2}),t})();var u=e(4762),l=e(2298),p=e(2238),g=e(7001),m=e(5939),h=e(7574),f=e(4395),_=e(8002),v=e(9773),Z=e(8295),b=e(3166),C=e(1554),y=e(8583),k=e(5396),x=e(3679),O=e(1095),A=e(6627);function q(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",12),c.NdJ("click",function(){return c.CHM(t),c.oxw().vm.customer.reset()}),c.TgZ(1,"mat-icon"),c._uU(2,"close"),c.qZA(),c.qZA()}}function T(t,n){if(1&t&&(c.TgZ(0,"mat-option",14),c._uU(1),c.qZA()),2&t){const t=n.$implicit;c.Q6J("value",t),c.xp6(1),c.hij(" ",t.name," ")}}function w(t,n){1&t&&(c.TgZ(0,"mat-option"),c.TgZ(1,"i"),c._uU(2,"pas de r\xe9sultat"),c.qZA(),c.qZA())}function P(t,n){if(1&t&&(c.TgZ(0,"div"),c.YNc(1,T,2,2,"mat-option",13),c.YNc(2,w,3,0,"mat-option",9),c.qZA()),2&t){const t=n.$implicit;c.xp6(1),c.Q6J("ngForOf",t),c.xp6(1),c.Q6J("ngIf",0==t.length)}}function M(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",12),c.NdJ("click",function(){return c.CHM(t),c.oxw(2).vm.payer.reset()}),c.TgZ(1,"mat-icon"),c._uU(2,"close"),c.qZA(),c.qZA()}}function I(t,n){if(1&t&&(c.TgZ(0,"mat-option",14),c._uU(1),c.qZA()),2&t){const t=n.$implicit;c.Q6J("value",t),c.xp6(1),c.hij(" ",t.name," ")}}function U(t,n){1&t&&(c.TgZ(0,"mat-option"),c.TgZ(1,"i"),c._uU(2,"pas de r\xe9sultat"),c.qZA(),c.qZA())}function J(t,n){if(1&t&&(c.TgZ(0,"div"),c.YNc(1,I,2,2,"mat-option",13),c.YNc(2,U,3,0,"mat-option",9),c.qZA()),2&t){const t=n.$implicit;c.xp6(1),c.Q6J("ngForOf",t),c.xp6(1),c.Q6J("ngIf",0==t.length)}}function N(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"div"),c.TgZ(1,"mat-form-field",15),c.TgZ(2,"mat-label"),c._uU(3,"Organisme payeur"),c.qZA(),c.TgZ(4,"input",16),c.NdJ("keyup",function(n){return c.CHM(t),c.oxw().vm.payer.inputChange(n)})("focus",function(){return c.CHM(t),c.oxw().vm.payer.focus()})("blur",function(){return c.CHM(t),c.oxw().vm.payer.restore()}),c.qZA(),c.YNc(5,M,3,0,"button",6),c.TgZ(6,"mat-autocomplete",7,17),c.NdJ("optionSelected",function(n){return c.CHM(t),c.oxw().vm.payer.change(n)}),c.YNc(8,J,3,2,"div",9),c.ALo(9,"async"),c.qZA(),c.TgZ(10,"mat-hint",10),c.TgZ(11,"span"),c._uU(12,"S\xe9lection de l'organisme payeur"),c.qZA(),c.qZA(),c.qZA(),c.TgZ(13,"button",18),c.NdJ("click",function(){return c.CHM(t),c.oxw().selectPayer()}),c._uU(14,"Ajouter un organisme payeur"),c.qZA(),c.qZA()}if(2&t){const t=c.MAs(7),n=c.oxw();c.xp6(4),c.Q6J("matAutocomplete",t)("value",n.vm.payer.name),c.xp6(1),c.Q6J("ngIf",n.vm.payer.name.length),c.xp6(1),c.Q6J("displayWith",n.vm.payer.display),c.xp6(2),c.Q6J("ngIf",c.lcZ(9,6,n.vm.payer.filteredList)),c.xp6(2),c.Q6J("align","start")}}let Q=(()=>{class t{constructor(t,n,e,i){this.api=t,this.dialog=n,this.zone=e,this.context=i,this.customer=null,this.has_payer=!1,this.payer=null,this.vm={customer:{name:"",inputClue:new l.t(1),filteredList:new h.y,inputChange:t=>this.customerInputChange(t),change:t=>this.customerChange(t),focus:()=>this.customerFocus(),restore:()=>this.customerRestore(),reset:()=>this.customerReset(),display:t=>this.customerDisplay(t)},payer:{name:"",inputClue:new l.t(1),filteredList:new h.y,inputChange:t=>this.payerInputChange(t),change:t=>this.payerChange(t),focus:()=>this.payerFocus(),restore:()=>this.payerRestore(),reset:()=>this.payerReset(),display:t=>this.payerDisplay(t)}}}ngOnInit(){this.bookingInput.subscribe(t=>(0,u.mG)(this,void 0,void 0,function*(){this.zone.run(()=>(0,u.mG)(this,void 0,void 0,function*(){try{if(console.log("BookingEditCustomerComponent: received change from parent, updating"),this.booking=t,this.has_payer=t.has_payer_organisation,t.customer_id){let n=yield this.api.read("identity\\Partner",[t.customer_id],["id","name","partner_identity_id"]);if(n&&n.length){let t=n[0];this.customer=t,this.vm.customer.name=t.name}}if(t.payer_organisation_id){let n=yield this.api.read("identity\\Partner",[t.payer_organisation_id],["id","name","partner_identity_id"]);if(n&&n.length){let t=n[0];this.payer=t,this.vm.payer.name=t.name}}}catch(n){}}))})),this.vm.customer.filteredList=this.vm.customer.inputClue.pipe((0,f.b)(300),(0,_.U)(t=>"string"==typeof t?t:null==t?"":t.name),(0,v.zg)(t=>(0,u.mG)(this,void 0,void 0,function*(){return this.filterCustomers(t)}))),this.vm.payer.filteredList=this.vm.payer.inputClue.pipe((0,f.b)(300),(0,_.U)(t=>"string"==typeof t?t:null==t?"":t.name),(0,v.zg)(t=>(0,u.mG)(this,void 0,void 0,function*(){return this.filterPayers(t)})))}customerChange(t){return(0,u.mG)(this,void 0,void 0,function*(){let n=t.option.value;this.customer=n,this.vm.customer.name=n.name,this.bookingOutput.next({customer_id:this.customer.id})})}customerInputChange(t){this.vm.customer.inputClue.next(t.target.value)}customerFocus(){this.vm.customer.inputClue.next("")}customerDisplay(t){return t?t.name:""}customerReset(){setTimeout(()=>{this.vm.customer.name=""},100)}customerRestore(){this.vm.customer.name=this.customer?this.customer.name:""}payerChange(t){if(console.log("BookingEditCustomerComponent::payerChange",t),t&&t.hasOwnProperty("checked"))this.has_payer=t.checked,this.has_payer||this.bookingOutput.next({payer_organisation_id:0});else if(t&&t.option&&t.option.value){let n=t.option.value;this.payer=n,this.vm.payer.name=n.name,this.bookingOutput.next({payer_organisation_id:this.payer.id,has_payer_organisation:this.has_payer})}}payerInputChange(t){this.vm.payer.inputClue.next(t.target.value)}payerFocus(){this.vm.payer.inputClue.next("")}payerDisplay(t){return t?t.name:""}payerReset(){setTimeout(()=>{this.vm.payer.name=""},100)}payerRestore(){this.vm.payer.name=this.payer?this.payer.name:""}selectPayer(){console.log("BookingEditCustomerComponent::selectPayer"),this.context.change({context:{entity:"identity\\Partner",type:"form",name:"payer",domain:[["owner_identity_id","=",this.customer.partner_identity_id],["relationship","=","payer"]],mode:"edit",purpose:"create",target:"#sb-booking-container",callback:t=>{t&&t.objects&&t.objects.length&&this.payerChange({option:{value:t.objects[0]}})}}})}createPayer(){this.dialog.open(Y,{width:"80vw",data:{owner_identity_id:this.customer.partner_identity_id,relationship:"payer"}}).afterClosed().subscribe(t=>{console.log("The dialog was closed")})}filterCustomers(t){return(0,u.mG)(this,void 0,void 0,function*(){let n=[];try{n=yield this.api.collect("identity\\Partner",[["name","ilike","%"+t+"%"],["relationship","=","customer"]],["id","name"],"name","asc",0,5)}catch(e){console.log(e)}return n})}filterPayers(t){return(0,u.mG)(this,void 0,void 0,function*(){let n=[];try{n=yield this.api.collect("identity\\Partner",[["name","ilike","%"+t+"%"],["owner_identity_id","=",this.customer.partner_identity_id],["relationship","=","payer"]],["id","name"],"name","asc",0,5)}catch(e){console.log(e)}return n})}}return t.\u0275fac=function(n){return new(n||t)(c.Y36(s.sM),c.Y36(p.uw),c.Y36(c.R0b),c.Y36(s.Ob))},t.\u0275cmp=c.Xpm({type:t,selectors:[["booking-edit-customer"]],inputs:{bookingInput:"bookingInput",bookingOutput:"bookingOutput"},decls:23,vars:10,consts:[[1,"container"],[2,"font-weight","500"],[2,"display","flex"],[2,"flex","0 1 50%"],[2,"width","350px"],["matInput","","type","text","placeholder","Commencez \xe0 taper le nom","autocomplete","off",3,"matAutocomplete","value","keyup","focus","blur"],["mat-button","","matSuffix","","mat-icon-button","","aria-label","Clear",3,"click",4,"ngIf"],[3,"displayWith","optionSelected"],["customerAutocomplete","matAutocomplete"],[4,"ngIf"],[2,"opacity","1",3,"align"],[3,"ngModel","change"],["mat-button","","matSuffix","","mat-icon-button","","aria-label","Clear",3,"click"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],[2,"width","50%"],["matInput","","type","text","placeholder","Commencez \xe0 taper le nom",3,"matAutocomplete","value","keyup","focus","blur"],["payerAutocomplete","matAutocomplete"],["mat-button","",3,"click"]],template:function(t,n){if(1&t&&(c.TgZ(0,"div",0),c.TgZ(1,"div"),c.TgZ(2,"p",1),c._uU(3,"Informations du client"),c.qZA(),c.qZA(),c.TgZ(4,"div",2),c.TgZ(5,"div",3),c.TgZ(6,"mat-form-field",4),c.TgZ(7,"mat-label"),c._uU(8,"Client"),c.qZA(),c.TgZ(9,"input",5),c.NdJ("keyup",function(t){return n.vm.customer.inputChange(t)})("focus",function(){return n.vm.customer.focus()})("blur",function(){return n.vm.customer.restore()}),c.qZA(),c.YNc(10,q,3,0,"button",6),c.TgZ(11,"mat-autocomplete",7,8),c.NdJ("optionSelected",function(t){return n.vm.customer.change(t)}),c.YNc(13,P,3,2,"div",9),c.ALo(14,"async"),c.qZA(),c.TgZ(15,"mat-hint",10),c.TgZ(16,"span"),c._uU(17,"S\xe9lection du client"),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.TgZ(18,"div",3),c.TgZ(19,"div"),c.TgZ(20,"mat-slide-toggle",11),c.NdJ("change",function(t){return n.vm.payer.change(t)}),c._uU(21,"R\xe9servation pay\xe9e par une autre organisation"),c.qZA(),c.qZA(),c.YNc(22,N,15,8,"div",9),c.qZA(),c.qZA(),c.qZA()),2&t){const t=c.MAs(12);c.xp6(9),c.Q6J("matAutocomplete",t)("value",n.vm.customer.name),c.xp6(1),c.Q6J("ngIf",n.vm.customer.name.length),c.xp6(1),c.Q6J("displayWith",n.vm.customer.display),c.xp6(2),c.Q6J("ngIf",c.lcZ(14,8,n.vm.customer.filteredList)),c.xp6(2),c.Q6J("align","start"),c.xp6(5),c.Q6J("ngModel",n.has_payer),c.xp6(2),c.Q6J("ngIf",n.has_payer)}},directives:[Z.KE,Z.hX,b.Nt,C.ZL,y.O5,C.XC,Z.bx,k.Rr,x.JJ,x.On,O.lW,Z.R9,A.Hw,y.sg,i.ey],pipes:[y.Ov],styles:["[_nghost-%COMP%]{width:100%;height:100%}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]{width:100%;height:100%}[_nghost-%COMP%]   mat-form-field[_ngcontent-%COMP%]{padding:12px}"]}),t})(),Y=(()=>{class t{constructor(t,n){this.dialogRef=t,this.data=n}onNoClick(){this.dialogRef.close()}}return t.\u0275fac=function(n){return new(n||t)(c.Y36(p.so),c.Y36(p.WI))},t.\u0275cmp=c.Xpm({type:t,selectors:[["dialog-booking-edit-customer-create-partner-dialog"]],decls:49,vars:1,consts:[["mat-dialog-title",""],["mat-dialog-content",""],[2,"display","flex","flex-direction","row"],[2,"flex","0 1 49%","display","flex","flex-direction","column","margin","10px"],[2,"font-weight","500"],["matInput","","value",""],["mat-dialog-actions",""],["mat-button","",3,"click"],["mat-button","","cdkFocusInitial","",3,"mat-dialog-close"]],template:function(t,n){1&t&&(c.TgZ(0,"h1",0),c._uU(1,"Nouveau partenaire"),c.qZA(),c.TgZ(2,"div",1),c.TgZ(3,"div",2),c.TgZ(4,"div",3),c.TgZ(5,"p",4),c._uU(6,"Infos"),c.qZA(),c.TgZ(7,"mat-form-field"),c.TgZ(8,"mat-label"),c._uU(9,"Nom l\xe9gal"),c.qZA(),c._UZ(10,"input",5),c.qZA(),c.TgZ(11,"mat-slide-toggle"),c._uU(12,"Assujetti \xe0 la TVA ?"),c.qZA(),c.TgZ(13,"mat-form-field"),c.TgZ(14,"mat-label"),c._uU(15,"Num\xe9ro de TVA"),c.qZA(),c._UZ(16,"input",5),c.qZA(),c.qZA(),c.TgZ(17,"div",3),c.TgZ(18,"p",4),c._uU(19,"Adresse"),c.qZA(),c.TgZ(20,"mat-form-field"),c.TgZ(21,"mat-label"),c._uU(22,"Rue"),c.qZA(),c._UZ(23,"input",5),c.qZA(),c.TgZ(24,"mat-form-field"),c.TgZ(25,"mat-label"),c._uU(26,"Dispatch"),c.qZA(),c._UZ(27,"input",5),c.qZA(),c.TgZ(28,"mat-form-field"),c.TgZ(29,"mat-label"),c._uU(30,"Ville"),c.qZA(),c._UZ(31,"input",5),c.qZA(),c.TgZ(32,"mat-form-field"),c.TgZ(33,"mat-label"),c._uU(34,"Code postal"),c.qZA(),c._UZ(35,"input",5),c.qZA(),c.TgZ(36,"mat-form-field"),c.TgZ(37,"mat-label"),c._uU(38,"Pays"),c.qZA(),c._UZ(39,"input",5),c.qZA(),c.qZA(),c.qZA(),c.TgZ(40,"mat-form-field"),c.TgZ(41,"mat-label"),c._uU(42,"Favorite Animal"),c.qZA(),c._UZ(43,"input",5),c.qZA(),c.qZA(),c.TgZ(44,"div",6),c.TgZ(45,"button",7),c.NdJ("click",function(){return n.onNoClick()}),c._uU(46,"Annuler"),c.qZA(),c.TgZ(47,"button",8),c._uU(48,"Cr\xe9er"),c.qZA(),c.qZA()),2&t&&(c.xp6(47),c.Q6J("mat-dialog-close",n.data))},directives:[p.uh,p.xY,Z.KE,Z.hX,b.Nt,k.Rr,p.H8,O.lW,p.ZT],encapsulation:2}),t})();var D=e(6109),G=e(2789),L=e(7441);function F(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",29),c.NdJ("click",function(){return c.CHM(t),c.oxw().vm.center.reset()}),c.TgZ(1,"mat-icon"),c._uU(2,"close"),c.qZA(),c.qZA()}}function B(t,n){if(1&t&&(c.TgZ(0,"mat-option",31),c._uU(1),c.qZA()),2&t){const t=n.$implicit;c.Q6J("value",t),c.xp6(1),c.hij(" ",t.name," ")}}function E(t,n){1&t&&(c.TgZ(0,"mat-option"),c.TgZ(1,"i"),c._uU(2,"pas de r\xe9sultat"),c.qZA(),c.qZA())}function R(t,n){if(1&t&&(c.TgZ(0,"div"),c.YNc(1,B,2,2,"mat-option",30),c.YNc(2,E,3,0,"mat-option",7),c.qZA()),2&t){const t=n.$implicit;c.xp6(1),c.Q6J("ngForOf",t),c.xp6(1),c.Q6J("ngIf",0==t.length)}}function j(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",29),c.NdJ("click",function(){return c.CHM(t),c.oxw().vm.type.reset()}),c.TgZ(1,"mat-icon"),c._uU(2,"close"),c.qZA(),c.qZA()}}function H(t,n){if(1&t&&(c.TgZ(0,"mat-option",31),c._uU(1),c.qZA()),2&t){const t=n.$implicit;c.Q6J("value",t),c.xp6(1),c.hij(" ",t.name," ")}}function z(t,n){1&t&&(c.TgZ(0,"mat-option"),c.TgZ(1,"i"),c._uU(2,"pas de r\xe9sultat"),c.qZA(),c.qZA())}function S(t,n){if(1&t&&(c.TgZ(0,"div"),c.YNc(1,H,2,2,"mat-option",30),c.YNc(2,z,3,0,"mat-option",7),c.qZA()),2&t){const t=n.$implicit;c.xp6(1),c.Q6J("ngForOf",t),c.xp6(1),c.Q6J("ngIf",0==t.length)}}function W(t,n){1&t&&(c.TgZ(0,"th",32),c._uU(1," Nom "),c.qZA())}function X(t,n){if(1&t&&(c.TgZ(0,"td",33),c._uU(1),c.qZA()),2&t){const t=n.$implicit;c.xp6(1),c.hij(" ",t.name," ")}}function V(t,n){1&t&&(c.TgZ(0,"th",32),c._uU(1," Type "),c.qZA())}function K(t,n){if(1&t&&(c.TgZ(0,"td",33),c._uU(1),c.qZA()),2&t){const t=n.$implicit;c.xp6(1),c.hij(" ",t.type," ")}}function tt(t,n){1&t&&(c.TgZ(0,"th",32),c._uU(1," Email "),c.qZA())}function nt(t,n){if(1&t&&(c.TgZ(0,"td",33),c._uU(1),c.qZA()),2&t){const t=n.$implicit;c.xp6(1),c.hij(" ",t.email," ")}}function et(t,n){1&t&&(c.TgZ(0,"th",32),c._uU(1," T\xe9l "),c.qZA())}function it(t,n){if(1&t&&(c.TgZ(0,"td",33),c._uU(1),c.qZA()),2&t){const t=n.$implicit;c.xp6(1),c.hij(" ",t.phone," ")}}function ot(t,n){1&t&&c._UZ(0,"th",32)}function at(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"td",33),c.TgZ(1,"button",34),c.NdJ("click",function(){const n=c.CHM(t).$implicit;return c.oxw().vm.contacts.remove(n.id)}),c.TgZ(2,"mat-icon"),c._uU(3,"delete"),c.qZA(),c.qZA(),c.qZA()}}function st(t,n){1&t&&c._UZ(0,"tr",35)}function rt(t,n){1&t&&c._UZ(0,"tr",36)}function ct(t,n){1&t&&(c.TgZ(0,"mat-error"),c._uU(1," Ce champ doit \xeatre rempli. "),c.qZA())}function dt(t,n){1&t&&(c.TgZ(0,"mat-error"),c._uU(1," Ce champ doit \xeatre rempli. "),c.qZA())}let ut=(()=>{class t{constructor(t,n,e,i,o){this.api=t,this.auth=n,this.dialog=e,this.zone=i,this.context=o,this.booking=null,this.center=null,this.type=null,this.vm={center:{name:"",inputClue:new l.t(1),filteredList:new h.y,change:t=>this.centerChange(t),inputChange:t=>this.centerInputChange(t),focus:()=>this.centerFocus(),restore:()=>this.centerRestore(),reset:()=>this.centerReset(),display:t=>this.centerDisplay(t)},type:{name:"",inputClue:new l.t(1),filteredList:new h.y,change:t=>this.typeChange(t),inputChange:t=>this.typeInputChange(t),focus:()=>this.typeFocus(),restore:()=>this.typeRestore(),reset:()=>this.typeReset(),display:t=>this.typeDisplay(t)},description:{value:"",change:t=>this.descriptionChange(t)},contacts:{values:[],fields:["name","type","email","phone","_actions"],list:new l.t(1),create:()=>this.createContact(),remove:t=>this.removeContact(t)}}}ngOnInit(){this.vm.contacts.list.subscribe(t=>{console.log("contact list: received new value",t)}),this.bookingInput.subscribe(t=>(0,u.mG)(this,void 0,void 0,function*(){this.zone.run(()=>(0,u.mG)(this,void 0,void 0,function*(){try{if(console.log("BookingEditSojournComponent: received changes from parent",t),this.booking=t,t.customer_id){let n=yield this.api.read("identity\\Partner",[t.customer_id],["id","name","partner_identity_id"]);n&&n.length&&(this.customer=n[0])}if(t.center_id){let n=yield this.api.read("lodging\\identity\\Center",[t.center_id],["id","name","code","organisation_id"]);if(n&&n.length){let t=n[0];this.center=t,this.vm.center.name=t.name}}if(t.type_id){let n=yield this.api.read("sale\\booking\\BookingType",[t.type_id],["id","name","code"]);if(n&&n.length){let t=n[0];this.type=t,this.vm.type.name=t.name}}if(t.description&&t.description.length&&(this.vm.description.value=t.description),t.contacts_ids){let n=yield this.api.read("sale\\booking\\Contact",t.contacts_ids,["id","name","type"]);console.log(t.contacts_ids,n),n&&n.length&&(this.vm.contacts.values=n,this.vm.contacts.list.next(n))}}catch(n){}}))})),this.vm.center.filteredList=this.vm.center.inputClue.pipe((0,f.b)(300),(0,_.U)(t=>"string"==typeof t?t:null==t?"":t.name),(0,v.zg)(t=>(0,u.mG)(this,void 0,void 0,function*(){return this.filterCenters(t)}))),this.vm.type.filteredList=this.vm.type.inputClue.pipe((0,f.b)(300),(0,_.U)(t=>"string"==typeof t?t:null==t?"":t.name),(0,v.zg)(t=>(0,u.mG)(this,void 0,void 0,function*(){return this.filterTypes(t)})))}centerChange(t){return(0,u.mG)(this,void 0,void 0,function*(){let n=t.option.value;this.center=n,this.vm.center.name=n.name,this.bookingOutput.next({center_id:this.center.id})})}centerFocus(){this.vm.center.inputClue.next("")}centerInputChange(t){this.vm.center.inputClue.next(t.target.value)}centerDisplay(t){return t?t.name:""}centerReset(){setTimeout(()=>{this.vm.center.name=""},100)}centerRestore(){this.vm.center.name=this.center?this.center.name:""}descriptionChange(t){console.log("BookingEditCustomerComponent::descriptionChange",t),this.bookingOutput.next({description:t.target.value})}typeChange(t){if(console.log("BookingEditCustomerComponent::typeChange",t),t&&t.option&&t.option.value){let n=t.option.value;this.type=n,this.vm.type.name=n.name,this.bookingOutput.next({type_id:n.id})}}typeInputChange(t){this.vm.type.inputClue.next(t.target.value)}typeFocus(){this.vm.type.inputClue.next("")}typeDisplay(t){return t?t.name:""}typeReset(){setTimeout(()=>{this.vm.type.name=""},100)}typeRestore(){this.vm.type.name=this.type?this.type.name:""}removeContact(t){return(0,u.mG)(this,void 0,void 0,function*(){try{yield this.api.remove("sale\\booking\\Contact",[t],!0);let n=this.vm.contacts.values.findIndex(n=>n.id==t);this.vm.contacts.values.splice(n,1),this.vm.contacts.list.next([...this.vm.contacts.values])}catch(n){console.warn(n)}})}createContact(){this.auth.getUser(),this.context.change({context:{entity:"sale\\booking\\Contact",type:"form",name:"default",domain:[["booking_id","=",this.booking.id],["owner_identity_id","=",this.customer.partner_identity_id],["relationship","=","contact"],["type","=","booking"]],mode:"edit",purpose:"create",target:"#sb-booking-container",callback:t=>{if(t&&t.objects&&t.objects.length){let n=t.objects[0],e=this.vm.contacts.values.map(t=>t.id);e.push(n.id),this.bookingOutput.next({contacts_ids:e})}}}})}alternateCreateContact(){this.dialog.open(lt,{width:"80vw",data:{relationship:"contact",type:"booking"}}).afterClosed().subscribe(t=>(0,u.mG)(this,void 0,void 0,function*(){if(t){console.log(t);try{const e=yield this.api.create("identity\\Identity",{firstname:t.firstname,lastname:t.lastname,email:t.email,phone:t.phone});try{let n=this.auth.getUser();const i=yield this.api.create("sale\\booking\\Contact",{owner_identity_id:n.organisation_id,partner_identity_id:e.id,booking_id:this.booking.id,type:t.type});this.vm.contacts.values.push({id:i.id,name:t.firstname+" "+t.lastname,type:t.type,email:t.email,phone:t.phone}),this.vm.contacts.list.next([...this.vm.contacts.values])}catch(n){console.warn(n)}}catch(n){console.warn(n)}}}))}filterCenters(t){return(0,u.mG)(this,void 0,void 0,function*(){let n=[];try{n=yield this.api.collect("lodging\\identity\\Center",[["name","ilike","%"+t+"%"]],["id","name"],"name","asc",0,5)}catch(e){console.log(e)}return n})}filterTypes(t){return(0,u.mG)(this,void 0,void 0,function*(){let n=[];try{n=yield this.api.collect("sale\\booking\\BookingType",[["name","ilike","%"+t+"%"]],["id","name"],"name","asc",0,25)}catch(e){console.log(e)}return n})}}return t.\u0275fac=function(n){return new(n||t)(c.Y36(s.sM),c.Y36(s.Tq),c.Y36(p.uw),c.Y36(c.R0b),c.Y36(s.Ob))},t.\u0275cmp=c.Xpm({type:t,selectors:[["booking-edit-sojourn"]],inputs:{bookingInput:"bookingInput",bookingOutput:"bookingOutput"},decls:62,vars:22,consts:[[1,"container"],[2,"font-weight","500"],[2,"width","350px"],["matInput","","type","text","placeholder","Commencez \xe0 taper le nom",3,"matAutocomplete","value","keyup","focus","blur"],["mat-button","","matSuffix","","mat-icon-button","","aria-label","Clear",3,"click",4,"ngIf"],[3,"displayWith","optionSelected"],["centerAutocomplete","matAutocomplete"],[4,"ngIf"],[2,"opacity","1",3,"align"],[2,"width","50%"],["typeAutocomplete","matAutocomplete"],[2,"margin-top","20px"],[2,"width","100%"],["label","Description"],[2,"display","flex","flex-direction","column"],[2,"flex","1","width","100%","margin-top","20px"],["matInput","","cdkTextareaAutosize","","cdkAutosizeMinRows","3","cdkAutosizeMaxRows","20","placeholder","Indiquez des d\xe9tails ou sp\xe9cificit\xe9s du s\xe9jour",3,"ngModel","change"],["label","Contacts"],["mat-mini-fab","","color","primary",2,"transform","scale(0.65)",3,"click"],["mat-table","",2,"width","100%",3,"dataSource"],["matColumnDef","name"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","type"],["matColumnDef","email"],["matColumnDef","phone"],["matColumnDef","_actions"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],["mat-button","","matSuffix","","mat-icon-button","","aria-label","Clear",3,"click"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["mat-header-cell",""],["mat-cell",""],["mat-icon-button","","color","primary",3,"click"],["mat-header-row",""],["mat-row",""]],template:function(t,n){if(1&t&&(c.TgZ(0,"div",0),c.TgZ(1,"div"),c.TgZ(2,"p",1),c._uU(3,"Informations de la r\xe9servation"),c.qZA(),c.TgZ(4,"mat-form-field",2),c.TgZ(5,"mat-label"),c._uU(6,"Centre"),c.qZA(),c.TgZ(7,"input",3),c.NdJ("keyup",function(t){return n.vm.center.inputChange(t)})("focus",function(){return n.vm.center.focus()})("blur",function(){return n.vm.center.restore()}),c.qZA(),c.YNc(8,F,3,0,"button",4),c.TgZ(9,"mat-autocomplete",5,6),c.NdJ("optionSelected",function(t){return n.vm.center.change(t)}),c.YNc(11,R,3,2,"div",7),c.ALo(12,"async"),c.qZA(),c.TgZ(13,"mat-hint",8),c.TgZ(14,"span"),c._uU(15,"S\xe9lection du centre"),c.qZA(),c.qZA(),c.qZA(),c.TgZ(16,"mat-form-field",9),c.TgZ(17,"mat-label"),c._uU(18,"Type de r\xe9servation"),c.qZA(),c.TgZ(19,"input",3),c.NdJ("keyup",function(t){return n.vm.type.inputChange(t)})("focus",function(){return n.vm.type.focus()})("blur",function(){return n.vm.type.restore()}),c.qZA(),c.YNc(20,j,3,0,"button",4),c.TgZ(21,"mat-autocomplete",5,10),c.NdJ("optionSelected",function(t){return n.vm.type.change(t)}),c.YNc(23,S,3,2,"div",7),c.ALo(24,"async"),c.qZA(),c.TgZ(25,"mat-hint",8),c.TgZ(26,"span"),c._uU(27,"Type de s\xe9jour de la r\xe9servation"),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.TgZ(28,"div",11),c.TgZ(29,"mat-tab-group",12),c.TgZ(30,"mat-tab",13),c.TgZ(31,"div",14),c.TgZ(32,"div",15),c.TgZ(33,"mat-form-field",12),c.TgZ(34,"mat-label"),c._uU(35,"Description"),c.qZA(),c.TgZ(36,"textarea",16),c.NdJ("change",function(t){return n.vm.description.change(t)}),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.TgZ(37,"mat-tab",17),c.TgZ(38,"p",1),c._uU(39,"Liste des contacts "),c.TgZ(40,"button",18),c.NdJ("click",function(){return n.vm.contacts.create()}),c.TgZ(41,"mat-icon"),c._uU(42,"add"),c.qZA(),c.qZA(),c.qZA(),c.TgZ(43,"table",19),c.ALo(44,"async"),c.ynx(45,20),c.YNc(46,W,2,0,"th",21),c.YNc(47,X,2,1,"td",22),c.BQk(),c.ynx(48,23),c.YNc(49,V,2,0,"th",21),c.YNc(50,K,2,1,"td",22),c.BQk(),c.ynx(51,24),c.YNc(52,tt,2,0,"th",21),c.YNc(53,nt,2,1,"td",22),c.BQk(),c.ynx(54,25),c.YNc(55,et,2,0,"th",21),c.YNc(56,it,2,1,"td",22),c.BQk(),c.ynx(57,26),c.YNc(58,ot,1,0,"th",21),c.YNc(59,at,4,0,"td",22),c.BQk(),c.YNc(60,st,1,0,"tr",27),c.YNc(61,rt,1,0,"tr",28),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.qZA()),2&t){const t=c.MAs(10),e=c.MAs(22);c.xp6(7),c.Q6J("matAutocomplete",t)("value",n.vm.center.name),c.xp6(1),c.Q6J("ngIf",n.vm.center.name.length),c.xp6(1),c.Q6J("displayWith",n.vm.center.display),c.xp6(2),c.Q6J("ngIf",c.lcZ(12,16,n.vm.center.filteredList)),c.xp6(2),c.Q6J("align","start"),c.xp6(6),c.Q6J("matAutocomplete",e)("value",n.vm.type.name),c.xp6(1),c.Q6J("ngIf",n.vm.type.name.length),c.xp6(1),c.Q6J("displayWith",n.vm.type.display),c.xp6(2),c.Q6J("ngIf",c.lcZ(24,18,n.vm.type.filteredList)),c.xp6(2),c.Q6J("align","start"),c.xp6(11),c.Q6J("ngModel",n.vm.description.value),c.xp6(7),c.Q6J("dataSource",c.lcZ(44,20,n.vm.contacts.list)),c.xp6(17),c.Q6J("matHeaderRowDef",n.vm.contacts.fields),c.xp6(1),c.Q6J("matRowDefColumns",n.vm.contacts.fields)}},directives:[Z.KE,Z.hX,b.Nt,C.ZL,y.O5,C.XC,Z.bx,m.SP,m.uX,D.IC,x.Fj,x.JJ,x.On,O.lW,A.Hw,G.BZ,G.w1,G.fO,G.Dz,G.as,G.nj,Z.R9,y.sg,i.ey,G.ge,G.ev,G.XQ,G.Gk],pipes:[y.Ov],styles:["[_nghost-%COMP%]{width:100%;height:100%}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]{height:100%;width:100%}[_nghost-%COMP%]   mat-form-field[_ngcontent-%COMP%]{padding:12px}[_nghost-%COMP%]   .mat-table[_ngcontent-%COMP%]   .mat-column-_actions[_ngcontent-%COMP%]{width:40px!important;padding:0}"]}),t})(),lt=(()=>{class t{constructor(t,n,e){this.dialogRef=t,this.formBuilder=n,this.data=e,this.form=this.formBuilder.group({firstname:[this.data?this.data.firstname:"",x.kI.required],lastname:[this.data?this.data.lastname:"",x.kI.required],type:[this.data?this.data.type:"booking",x.kI.required],email:[this.data?this.data.email:"",[x.kI.required,x.kI.email]],phone:[this.data?this.data.phone:""]})}get f(){return this.form.controls}markFormGroupTouched(t){Object.values(t.controls).forEach(t=>{t.markAsTouched(),t.controls&&this.markFormGroupTouched(t)})}onCancel(){this.dialogRef.close()}onSubmit(){if(this.form.invalid)return this.markFormGroupTouched(this.form);this.dialogRef.close({firstname:this.form.value.firstname,lastname:this.form.value.lastname,type:this.form.value.type,email:this.form.value.email,phone:this.form.value.phone})}}return t.\u0275fac=function(n){return new(n||t)(c.Y36(p.so),c.Y36(x.qu),c.Y36(p.WI))},t.\u0275cmp=c.Xpm({type:t,selectors:[["dialog-booking-edit-customer-create-contact-dialog"]],decls:46,vars:3,consts:[["mat-dialog-title",""],["mat-dialog-content",""],[3,"formGroup","ngSubmit"],[2,"display","flex","flex-direction","row"],[2,"flex","0 1 49%","display","flex","flex-direction","column","margin","10px"],[2,"font-weight","500"],["matInput","","formControlName","firstname"],[4,"ngIf"],["matInput","","formControlName","lastname"],["formControlName","type"],["value","booking"],["value","invoice"],["value","contract"],["value","sojourn"],["matInput","","formControlName","email"],["matInput","","formControlName","phone"],["mat-dialog-actions","",2,"justify-content","flex-end"],["mat-button","",3,"click"],["mat-button","","cdkFocusInitial","",3,"click"]],template:function(t,n){1&t&&(c.TgZ(0,"h1",0),c._uU(1,"Nouveau contact pour la r\xe9servation"),c.qZA(),c.TgZ(2,"div",1),c.TgZ(3,"form",2),c.NdJ("ngSubmit",function(){return n.onSubmit()}),c.TgZ(4,"div",3),c.TgZ(5,"div",4),c.TgZ(6,"p",5),c._uU(7,"Infos"),c.qZA(),c.TgZ(8,"mat-form-field"),c.TgZ(9,"mat-label"),c._uU(10,"Pr\xe9nom"),c.qZA(),c._UZ(11,"input",6),c.YNc(12,ct,2,0,"mat-error",7),c.qZA(),c.TgZ(13,"mat-form-field"),c.TgZ(14,"mat-label"),c._uU(15,"Nom"),c.qZA(),c._UZ(16,"input",8),c.YNc(17,dt,2,0,"mat-error",7),c.qZA(),c.TgZ(18,"mat-form-field"),c.TgZ(19,"mat-label"),c._uU(20,"Type de contact"),c.qZA(),c.TgZ(21,"mat-select",9),c.TgZ(22,"mat-option",10),c._uU(23,"r\xe9servation"),c.qZA(),c.TgZ(24,"mat-option",11),c._uU(25,"facturation"),c.qZA(),c.TgZ(26,"mat-option",12),c._uU(27,"contrats"),c.qZA(),c.TgZ(28,"mat-option",13),c._uU(29,"s\xe9jour"),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.TgZ(30,"div",4),c.TgZ(31,"p",5),c._uU(32,"Coordonn\xe9es"),c.qZA(),c.TgZ(33,"mat-form-field"),c.TgZ(34,"mat-label"),c._uU(35,"Email"),c.qZA(),c._UZ(36,"input",14),c.qZA(),c.TgZ(37,"mat-form-field"),c.TgZ(38,"mat-label"),c._uU(39,"Phone"),c.qZA(),c._UZ(40,"input",15),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.TgZ(41,"div",16),c.TgZ(42,"button",17),c.NdJ("click",function(){return n.onCancel()}),c._uU(43,"Annuler"),c.qZA(),c.TgZ(44,"button",18),c.NdJ("click",function(){return n.onSubmit()}),c._uU(45,"Ok"),c.qZA(),c.qZA()),2&t&&(c.xp6(3),c.Q6J("formGroup",n.form),c.xp6(9),c.Q6J("ngIf",null==n.f.firstname.errors?null:n.f.firstname.errors.required),c.xp6(5),c.Q6J("ngIf",null==n.f.lastname.errors?null:n.f.lastname.errors.required))},directives:[p.uh,p.xY,x._Y,x.JL,x.sg,Z.KE,Z.hX,b.Nt,x.Fj,x.JJ,x.u,y.O5,L.gD,i.ey,p.H8,O.lW,Z.TO],encapsulation:2}),t})();var pt=e(3461),gt=e(3220);function mt(t,n){1&t&&(c.TgZ(0,"mat-error"),c._uU(1," Ne peut \xeatre vide. "),c.qZA())}let ht=(()=>{class t{constructor(t,n,e,i,o){this.api=t,this.auth=n,this.dialog=e,this.zone=i,this.snack=o,this.ready=!1,this.discount={},this.vm={value:{value:0,formControl:new x.NI("",x.kI.required),change:t=>this.valueChange(t)},type:{value:"",formControl:new x.NI("",x.kI.required),change:t=>this.typeChange(t)}}}ngOnInit(){this.discountInput.subscribe(t=>this.load(t)),this.vm.value.formControl.valueChanges.subscribe(t=>{this.vm.value.value=t})}load(t){return(0,u.mG)(this,void 0,void 0,function*(){this.zone.run(()=>{this.ready=!1}),this.zone.run(()=>(0,u.mG)(this,void 0,void 0,function*(){try{console.log("BookingEditBookingsGroupLineDiscountComponent: received changes from parent",t.id,t);for(let n of Object.keys(t))this.discount[n]=t[n];t.hasOwnProperty("type")&&(this.vm.type.value=t.type,this.vm.type.formControl.setValue("percent"!=t.type)),t.hasOwnProperty("value")&&(this.vm.value.value=t.value,this.vm.value.formControl.setValue(t.value))}catch(n){console.warn(n)}this.ready=!0}))})}typeChange(t){console.log(t),this.vm.type.value=t?"amount":"percent",this.vm.value.value&&this.discountOutput.next({id:this.discount.id,type:this.vm.type.value})}valueChange(t){this.vm.value.value&&this.discountOutput.next({id:this.discount.id,value:this.vm.value.value})}}return t.\u0275fac=function(n){return new(n||t)(c.Y36(s.sM),c.Y36(s.Tq),c.Y36(p.uw),c.Y36(c.R0b),c.Y36(g.ux))},t.\u0275cmp=c.Xpm({type:t,selectors:[["booking-edit-bookings-group-line-discount"]],inputs:{lineInput:"lineInput",lineOutput:"lineOutput",discountInput:"discountInput",discountOutput:"discountOutput"},decls:10,vars:3,consts:[[1,"cell"],["floatLabel","always",1,"invisible",2,"max-width","85px"],[3,"formControl","change"],["matInput","","hidden",""],[2,"max-width","90px"],["type","number","placeholder","r\xe9duction","matInput","",3,"formControl","blur"],[4,"ngIf"]],template:function(t,n){1&t&&(c.TgZ(0,"div",0),c.TgZ(1,"mat-form-field",1),c._uU(2," % "),c.TgZ(3,"mat-slide-toggle",2),c.NdJ("change",function(t){return n.vm.type.change(t.checked)}),c._uU(4,"\u20ac"),c.qZA(),c._UZ(5,"textarea",3),c.qZA(),c.qZA(),c.TgZ(6,"div",0),c.TgZ(7,"mat-form-field",4),c.TgZ(8,"input",5),c.NdJ("blur",function(t){return n.vm.value.change(t)}),c.qZA(),c.YNc(9,mt,2,0,"mat-error",6),c.qZA(),c.qZA()),2&t&&(c.xp6(3),c.Q6J("formControl",n.vm.type.formControl),c.xp6(5),c.Q6J("formControl",n.vm.value.formControl),c.xp6(1),c.Q6J("ngIf",!n.vm.value.formControl.hasError("required")))},directives:[Z.KE,k.Rr,x.JJ,x.oH,b.Nt,x.wV,x.Fj,y.O5,Z.TO],styles:["[_nghost-%COMP%]{display:block;width:100%;height:100%;max-height:50px}[_nghost-%COMP%]   .cell[_ngcontent-%COMP%]{display:inline-block}[_nghost-%COMP%]   mat-form-field.invisible[_ngcontent-%COMP%]    .mat-form-field-underline{display:none!important}"]}),t})();function ft(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",19),c.NdJ("click",function(){c.CHM(t),c.oxw();const n=c.MAs(1);return n.identification.folded=!n.identification.folded}),c.TgZ(1,"mat-icon",20),c._uU(2,"keyboard_arrow_up"),c.qZA(),c.qZA()}}function _t(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",19),c.NdJ("click",function(){c.CHM(t),c.oxw();const n=c.MAs(1);return n.identification.folded=!n.identification.folded}),c.TgZ(1,"mat-icon",20),c._uU(2,"keyboard_arrow_right"),c.qZA(),c.qZA()}}function vt(t,n){1&t&&(c.TgZ(0,"mat-icon",21),c._uU(1,"hotel"),c.qZA())}function Zt(t,n){1&t&&(c.TgZ(0,"span"),c._uU(1,"au logement"),c.qZA())}function bt(t,n){1&t&&(c.TgZ(0,"span"),c._uU(1,"\xe0 la personne"),c.qZA())}function Ct(t,n){1&t&&(c.TgZ(0,"span"),c._uU(1,"\xe0 l'unit\xe9"),c.qZA())}function yt(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",22),c.NdJ("click",function(){return c.CHM(t),c.oxw().vm.product.reset()}),c.TgZ(1,"mat-icon"),c._uU(2,"close"),c.qZA(),c.qZA()}}function kt(t,n){if(1&t&&(c.TgZ(0,"mat-option",24),c._uU(1),c.qZA()),2&t){const t=n.$implicit;c.Q6J("value",t),c.xp6(1),c.hij(" ",t.name," ")}}function xt(t,n){1&t&&(c.TgZ(0,"mat-option"),c.TgZ(1,"i"),c._uU(2,"pas de r\xe9sultat"),c.qZA(),c.qZA())}function Ot(t,n){if(1&t&&(c.TgZ(0,"div"),c.YNc(1,kt,2,2,"mat-option",23),c.YNc(2,xt,3,0,"mat-option",11),c.qZA()),2&t){const t=n.$implicit;c.xp6(1),c.Q6J("ngForOf",t),c.xp6(1),c.Q6J("ngIf",0==t.length)}}function At(t,n){if(1&t&&(c.TgZ(0,"span"),c._uU(1),c.qZA()),2&t){const t=c.oxw();c.xp6(1),c.Oqu(t.vm.qty.value)}}function qt(t,n){1&t&&(c.TgZ(0,"mat-error"),c._uU(1," Ne peut \xeatre vide. "),c.qZA())}function Tt(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"mat-form-field"),c.TgZ(1,"mat-label"),c._uU(2,"Quantit\xe9"),c.qZA(),c.TgZ(3,"input",25),c.NdJ("blur",function(){return c.CHM(t),c.oxw().vm.qty.change()}),c.qZA(),c.YNc(4,qt,2,0,"mat-error",11),c.qZA()}if(2&t){const t=c.oxw();c.xp6(3),c.Q6J("formControl",t.vm.qty.formControl),c.xp6(1),c.Q6J("ngIf",!t.vm.qty.formControl.hasError("required"))}}function wt(t,n){if(1&t&&(c.TgZ(0,"span"),c._uU(1),c.qZA()),2&t){const t=c.oxw();c.xp6(1),c.Oqu(t.vm.free_qty.value)}}function Pt(t,n){if(1&t&&(c.TgZ(0,"span"),c._uU(1),c.ALo(2,"number"),c.qZA()),2&t){const t=c.oxw();c.xp6(1),c.hij("",c.xi3(2,1,t.vm.unit_price.value,"1.2-2")," \u20ac")}}function Mt(t,n){if(1&t&&(c.TgZ(0,"span"),c._uU(1),c.ALo(2,"percent"),c.qZA()),2&t){const t=c.oxw();c.xp6(1),c.Oqu(c.lcZ(2,1,t.vm.discount.value))}}function It(t,n){if(1&t&&(c.TgZ(0,"span"),c._uU(1),c.ALo(2,"percent"),c.qZA()),2&t){const t=c.oxw();c.xp6(1),c.Oqu(c.lcZ(2,1,t.vm.vat.value))}}function Ut(t,n){if(1&t&&(c.TgZ(0,"span"),c._uU(1),c.ALo(2,"number"),c.qZA()),2&t){const t=c.oxw();c.xp6(1),c.hij("",c.xi3(2,1,t.vm.total_price.value,"1.2-2")," \u20ac")}}function Jt(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",19),c.NdJ("click",function(){c.CHM(t),c.oxw(2);const n=c.MAs(1);return n.adapters.folded=!n.adapters.folded}),c.TgZ(1,"mat-icon",20),c._uU(2,"keyboard_arrow_up"),c.qZA(),c.qZA()}}function Nt(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",19),c.NdJ("click",function(){c.CHM(t),c.oxw(2);const n=c.MAs(1);return n.adapters.folded=!n.adapters.folded}),c.TgZ(1,"mat-icon",20),c._uU(2,"keyboard_arrow_right"),c.qZA(),c.qZA()}}function Qt(t,n){if(1&t&&(c.TgZ(0,"span"),c._uU(1),c.ALo(2,"number"),c.qZA()),2&t){const t=c.oxw().$implicit;c.xp6(1),c.hij("",c.xi3(2,1,t.value,"1.2-2")," \u20ac")}}function Yt(t,n){if(1&t&&(c.TgZ(0,"span"),c._uU(1),c.ALo(2,"percent"),c.qZA()),2&t){const t=c.oxw().$implicit;c.xp6(1),c.Oqu(c.lcZ(2,1,t.value))}}function Dt(t,n){if(1&t&&(c.TgZ(0,"span"),c._uU(1),c.qZA()),2&t){const t=c.oxw().$implicit;c.xp6(1),c.Oqu(t.value)}}function Gt(t,n){if(1&t&&(c.TgZ(0,"div"),c._uU(1),c.YNc(2,Qt,3,4,"span",11),c.YNc(3,Yt,3,3,"span",11),c.YNc(4,Dt,2,1,"span",11),c.qZA()),2&t){const t=n.$implicit;c.xp6(1),c.hij(" ",t.discount_id.name," : "),c.xp6(1),c.Q6J("ngIf","amount"==t.type),c.xp6(1),c.Q6J("ngIf","percent"==t.type),c.xp6(1),c.Q6J("ngIf","freebie"==t.type)}}function Lt(t,n){if(1&t&&(c.TgZ(0,"div",29),c.TgZ(1,"div"),c.YNc(2,Gt,5,4,"div",30),c.qZA(),c.qZA()),2&t){const t=c.oxw(2);c.xp6(2),c.Q6J("ngForOf",t.adapters)}}function Ft(t,n){if(1&t&&(c.TgZ(0,"div",6),c.TgZ(1,"div",26),c.TgZ(2,"div",3),c.YNc(3,Jt,3,0,"button",4),c.YNc(4,Nt,3,0,"button",4),c.qZA(),c.TgZ(5,"div",5),c.TgZ(6,"div",27),c.TgZ(7,"span"),c._uU(8,"D\xe9tail du prix"),c.qZA(),c.qZA(),c.YNc(9,Lt,3,1,"div",28),c.qZA(),c.qZA(),c.qZA()),2&t){const t=c.oxw(),n=c.MAs(1);c.xp6(1),c.ekj("hidden",!t.ready),c.xp6(2),c.Q6J("ngIf",!n.adapters.folded),c.xp6(1),c.Q6J("ngIf",n.adapters.folded),c.xp6(5),c.Q6J("ngIf",!n.adapters.folded)}}function Bt(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",19),c.NdJ("click",function(){c.CHM(t),c.oxw(2);const n=c.MAs(1);return n.discounts.folded=!n.discounts.folded}),c.TgZ(1,"mat-icon",20),c._uU(2,"keyboard_arrow_up"),c.qZA(),c.qZA()}}function Et(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",19),c.NdJ("click",function(){c.CHM(t),c.oxw(2);const n=c.MAs(1);return n.discounts.folded=!n.discounts.folded}),c.TgZ(1,"mat-icon",20),c._uU(2,"keyboard_arrow_right"),c.qZA(),c.qZA()}}function Rt(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"div",34),c.TgZ(1,"div",35),c.TgZ(2,"button",19),c.NdJ("click",function(){const n=c.CHM(t).$implicit;return c.oxw(3).vm.discounts.remove(n)}),c.TgZ(3,"mat-icon"),c._uU(4,"delete"),c.qZA(),c.qZA(),c.qZA(),c._UZ(5,"booking-edit-bookings-group-line-discount",36),c.qZA()}if(2&t){const t=n.index,e=c.oxw(3);c.xp6(5),c.Q6J("discountInput",e._discountOutput[t])("discountOutput",e._discountInput)("lineInput",e.line)("lineOutput",e.lineOutput)}}function jt(t,n){if(1&t&&(c.TgZ(0,"div",29),c.TgZ(1,"div",32),c.YNc(2,Rt,6,4,"div",33),c.qZA(),c.qZA()),2&t){const t=c.oxw(2);c.xp6(2),c.Q6J("ngForOf",t.discounts)}}function Ht(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"div",6),c.TgZ(1,"div",26),c.TgZ(2,"div",3),c.YNc(3,Bt,3,0,"button",4),c.YNc(4,Et,3,0,"button",4),c.qZA(),c.TgZ(5,"div",5),c.TgZ(6,"div",27),c.TgZ(7,"span"),c._uU(8,"R\xe9ductions "),c.TgZ(9,"button",31),c.NdJ("click",function(){c.CHM(t);const n=c.oxw(),e=c.MAs(1);return n.vm.discounts.add(),e.discounts.folded=!1}),c.TgZ(10,"mat-icon"),c._uU(11,"add"),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.YNc(12,jt,3,1,"div",28),c.qZA(),c.qZA(),c.qZA()}if(2&t){const t=c.oxw(),n=c.MAs(1);c.xp6(1),c.ekj("hidden",!t.ready),c.xp6(2),c.Q6J("ngIf",!n.discounts.folded),c.xp6(1),c.Q6J("ngIf",n.discounts.folded),c.xp6(8),c.Q6J("ngIf",!n.discounts.folded)}}const zt=function(){return{folded:!0}},St=function(t,n,e){return{identification:t,discounts:n,adapters:e}};let $t=(()=>{class t{constructor(t,n,e,i,o){this.api=t,this.auth=n,this.dialog=e,this.zone=i,this.snack=o,this._discountInput=new l.t(1),this._discountOutput=[],this.model_fields={BookingPriceAdapter:["id","type","value","discount_id.name","booking_line_id"]},this.ready=!1,this.line={},this.product=null,this.discounts=[],this.vm={product:{name:"",inputClue:new l.t(1),filteredList:new h.y,change:t=>this.productChange(t),inputChange:t=>this.productInputChange(t),focus:()=>this.productFocus(),restore:()=>this.productRestore(),reset:()=>this.productReset(),display:t=>this.productDisplay(t)},qty:{value:0,formControl:new x.NI("",x.kI.required),change:()=>this.qtyChange()},free_qty:{value:0},unit_price:{value:0},discount:{value:0},vat:{value:0},total_price:{value:0},discounts:{add:()=>this.discountAdd(),remove:t=>this.discountRemove(t)}}}ngOnInit(){this.lineInput.subscribe(t=>this.load(t)),this._discountInput.subscribe(t=>this.updateFromDiscount(t)),this.vm.product.filteredList=this.vm.product.inputClue.pipe((0,f.b)(300),(0,_.U)(t=>"string"==typeof t?t:null==t?"":t.name),(0,v.zg)(t=>(0,u.mG)(this,void 0,void 0,function*(){return this.filterProducts(t)}))),this.vm.qty.formControl.valueChanges.subscribe(t=>{this.vm.qty.value=t})}load(t){return(0,u.mG)(this,void 0,void 0,function*(){this.zone.run(()=>{this.ready=!1}),this.zone.run(()=>(0,u.mG)(this,void 0,void 0,function*(){try{console.log("BookingEditBookingsGroupLineComponent: received changes from parent",t.id,t);for(let n of Object.keys(t))this.line[n]=t[n];if(t.product_id){let n=yield this.api.read("lodging\\sale\\catalog\\Product",[t.product_id],["id","name","sku"]);if(n&&n.length){let t=n[0];this.product=t,this.vm.product.name=t.name+" ("+t.sku+")"}}if(t.hasOwnProperty("price_id")){let n=yield this.api.read("sale\\price\\Price",[t.price_id],["id","price"]);if(n&&n.length){let t=n[0];this.price=t,this.vm.unit_price.value=t.price}else this.price=null,this.vm.unit_price.value=0,this.vm.vat.value=0}if(t.hasOwnProperty("unit_price")&&(this.vm.unit_price.value=t.unit_price),t.hasOwnProperty("vat_rate")&&(this.vm.vat.value=t.vat_rate),t.hasOwnProperty("price")&&(this.vm.total_price.value=t.price),t.hasOwnProperty("qty")&&(this.vm.qty.value=t.qty,this.vm.qty.formControl.setValue(t.qty)),t.manual_discounts_ids){let n=yield this.loadManualDiscounts(t.manual_discounts_ids,this.model_fields.BookingPriceAdapter);if(n){for(let[t,e]of n.entries())if(t>=this.discounts.length){let t=new l.t(1);this._discountOutput.push(t),t.next(e),this.discounts.push(e)}else if(JSON.stringify(this.discounts[t])!=JSON.stringify(e)){let n=new l.t(1);this._discountOutput[t]=n,this.discounts[t]=e,n.next(e)}this.discounts.length>n.length&&(this.discounts.splice(n.length),this._discountOutput.splice(n.length))}let e=0;for(let t of this.discounts)"percent"==t.type&&(e+=t.value);this.vm.discount.value=e}if(t.auto_discounts_ids){let n=0;const e=yield this.loadAutoDiscounts(t.auto_discounts_ids,this.model_fields.BookingPriceAdapter);this.adapters=e;for(let t of this.adapters)"freebie"==t.type&&(n+=t.value);this.vm.free_qty.value=n}}catch(n){console.warn(n)}this.ready=!0}))})}updateFromDiscount(t){return(0,u.mG)(this,void 0,void 0,function*(){console.log("BookingEditBookingsGroupLineComponent: received changes from child",t),console.log(this.discounts);try{let n=!1,e=(this.discounts.findIndex(n=>n.id==t.id),this.discounts.find(n=>n.id==t.id));t.hasOwnProperty("value")&&t.value!=e.value&&(yield this.updateDiscount(t),n=!0),t.hasOwnProperty("type")&&t.type!=e.type&&(yield this.updateDiscount(t),n=!0),n&&this.lineOutput.next({id:this.line.id,price_adapters_ids:!0})}catch(n){console.warn("some changes could not be stored",n),this.snack.open("Erreur - certains changements n'ont pas pu \xeatre enregistr\xe9s.")}})}productInputChange(t){this.vm.product.inputClue.next(t.target.value)}productFocus(){this.vm.product.inputClue.next("")}productDisplay(t){return t?t.name+" ("+t.sku+")":""}productReset(){setTimeout(()=>{this.vm.product.name=""},100)}productRestore(){this.vm.product.name=this.product?this.product.name+" ("+this.product.sku+")":""}productChange(t){if(console.log("BookingEditCustomerComponent::productChange",t),t&&t.option&&t.option.value){let n=t.option.value;this.product=n,this.vm.product.name=n.name+" ("+n.sku+")",this.lineOutput.next({id:this.line.id,product_id:n.id,refresh:{self:["price","vat_rate","unit_price"]}})}}qtyChange(){this.lineOutput.next({id:this.line.id,qty:this.vm.qty.value,refresh:{self:["price"]}})}filterProducts(t){return(0,u.mG)(this,void 0,void 0,function*(){let n=[];try{n=yield this.api.collect("lodging\\sale\\catalog\\Product",[["name","ilike","%"+t+"%"]],["id","name","sku"],"name","asc",0,25)}catch(e){console.log(e)}return n})}loadAutoDiscounts(t,n){return(0,u.mG)(this,void 0,void 0,function*(){return yield this.api.read("lodging\\sale\\booking\\BookingPriceAdapter",t,n)})}loadManualDiscounts(t,n){return(0,u.mG)(this,void 0,void 0,function*(){return yield this.api.read("lodging\\sale\\booking\\BookingPriceAdapter",t,n)})}discountAdd(){return(0,u.mG)(this,void 0,void 0,function*(){try{let t={id:(yield this.api.create("lodging\\sale\\booking\\BookingPriceAdapter",{booking_id:this.line.booking_id,booking_line_group_id:this.line.booking_line_group_id,booking_line_id:this.line.id})).id,type:"percent",value:0},n=new l.t(1);this._discountOutput.push(n),n.next(t),this.discounts.push(t)}catch(t){console.log(t)}})}discountRemove(t){return(0,u.mG)(this,void 0,void 0,function*(){yield this.api.update("lodging\\sale\\booking\\BookingLine",[this.line.id],{price_adapters_ids:[-t.id]},t),this.lineOutput.next({id:this.line.id,price_adapters_ids:!0})})}updateDiscount(t){return(0,u.mG)(this,void 0,void 0,function*(){yield this.api.update("lodging\\sale\\booking\\BookingPriceAdapter",[t.id],t)})}}return t.\u0275fac=function(n){return new(n||t)(c.Y36(s.sM),c.Y36(s.Tq),c.Y36(p.uw),c.Y36(c.R0b),c.Y36(g.ux))},t.\u0275cmp=c.Xpm({type:t,selectors:[["booking-edit-bookings-group-line"]],inputs:{groupInput:"groupInput",lineOutput:"lineOutput",lineInput:"lineInput"},decls:41,vars:37,consts:[[3,"var"],["vProduct","var"],[1,"part"],[1,"part-toggle"],["mat-icon-button","",3,"click",4,"ngIf"],[1,"part-container"],[1,"row","row-first"],[1,"cell"],["matInput","","type","text","placeholder","Commencez \xe0 taper le nom",3,"matAutocomplete","value","keyup","focus","blur"],["matSuffix","","style","vertical-align: sub;",4,"ngIf"],[3,"align"],[4,"ngIf"],["mat-button","","matSuffix","","mat-icon-button","","aria-label","Clear",3,"click",4,"ngIf"],[3,"displayWith","optionSelected"],["productAutocomplete","matAutocomplete"],[1,"cell","cell-right"],[1,"cell","cell-text","cell-right"],[1,"cell","cell-actions"],["class","row row-first",4,"ngIf"],["mat-icon-button","",3,"click"],[2,"font-size","15px"],["matSuffix","",2,"vertical-align","sub"],["mat-button","","matSuffix","","mat-icon-button","","aria-label","Clear",3,"click"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["type","number","matInput","",3,"formControl","blur"],[1,"part","cell"],[1,"row","row-title","row-thin"],["class","row row-thin",4,"ngIf"],[1,"row","row-thin"],[4,"ngFor","ngForOf"],["mat-mini-fab","","color","primary",2,"transform","scale(0.65)",3,"click"],[1,"discounts-list"],["class","discount-item",4,"ngFor","ngForOf"],[1,"discount-item"],[1,"discount-remove"],[3,"discountInput","discountOutput","lineInput","lineOutput"]],template:function(t,n){if(1&t&&(c._UZ(0,"div",0,1),c.TgZ(2,"div",2),c.TgZ(3,"div",3),c.YNc(4,ft,3,0,"button",4),c.YNc(5,_t,3,0,"button",4),c.qZA(),c.TgZ(6,"div",5),c.TgZ(7,"div",6),c.TgZ(8,"div",7),c.TgZ(9,"mat-form-field"),c.TgZ(10,"mat-label"),c._uU(11,"Produit"),c.qZA(),c.TgZ(12,"input",8),c.NdJ("keyup",function(t){return n.vm.product.inputChange(t)})("focus",function(){return n.vm.product.focus()})("blur",function(){return n.vm.product.restore()}),c.qZA(),c.YNc(13,vt,2,0,"mat-icon",9),c.TgZ(14,"mat-hint"),c._uU(15,"Hint"),c.qZA(),c.TgZ(16,"mat-hint",10),c.YNc(17,Zt,2,0,"span",11),c.YNc(18,bt,2,0,"span",11),c.YNc(19,Ct,2,0,"span",11),c.qZA(),c.YNc(20,yt,3,0,"button",12),c.TgZ(21,"mat-autocomplete",13,14),c.NdJ("optionSelected",function(t){return n.vm.product.change(t)}),c.YNc(23,Ot,3,2,"div",11),c.ALo(24,"async"),c.qZA(),c.qZA(),c.qZA(),c.TgZ(25,"div",15),c.YNc(26,At,2,1,"span",11),c.YNc(27,Tt,5,2,"mat-form-field",11),c.qZA(),c.TgZ(28,"div",16),c.YNc(29,wt,2,1,"span",11),c.qZA(),c.TgZ(30,"div",16),c.YNc(31,Pt,3,4,"span",11),c.qZA(),c.TgZ(32,"div",16),c.YNc(33,Mt,3,3,"span",11),c.qZA(),c.TgZ(34,"div",16),c.YNc(35,It,3,3,"span",11),c.qZA(),c.TgZ(36,"div",16),c.YNc(37,Ut,3,4,"span",11),c.qZA(),c._UZ(38,"div",17),c.qZA(),c.YNc(39,Ft,10,5,"div",18),c.YNc(40,Ht,13,5,"div",18),c.qZA(),c.qZA()),2&t){const t=c.MAs(1),e=c.MAs(22);c.Q6J("var",c.kEZ(33,St,c.DdM(30,zt),c.DdM(31,zt),c.DdM(32,zt))),c.xp6(2),c.ekj("hidden",!n.ready),c.xp6(1),c.ekj("hidden",n.groupInput.is_locked),c.xp6(1),c.Q6J("ngIf",!t.identification.folded),c.xp6(1),c.Q6J("ngIf",t.identification.folded),c.xp6(7),c.Q6J("matAutocomplete",e)("value",n.vm.product.name),c.xp6(1),c.Q6J("ngIf","accomodation"==n.line.qty_accounting_method),c.xp6(3),c.Q6J("align","end"),c.xp6(1),c.Q6J("ngIf","accomodation"==n.line.qty_accounting_method),c.xp6(1),c.Q6J("ngIf","person"==n.line.qty_accounting_method),c.xp6(1),c.Q6J("ngIf","unit"==n.line.qty_accounting_method),c.xp6(1),c.Q6J("ngIf",n.vm.product.name.length),c.xp6(1),c.Q6J("displayWith",n.vm.product.display),c.xp6(2),c.Q6J("ngIf",c.lcZ(24,28,n.vm.product.filteredList)),c.xp6(2),c.ekj("cell-text",n.groupInput.is_locked),c.xp6(1),c.Q6J("ngIf",n.groupInput.is_locked),c.xp6(1),c.Q6J("ngIf",!n.groupInput.is_locked),c.xp6(2),c.Q6J("ngIf",!n.groupInput.is_locked),c.xp6(2),c.Q6J("ngIf",!n.groupInput.is_locked),c.xp6(2),c.Q6J("ngIf",!n.groupInput.is_locked),c.xp6(2),c.Q6J("ngIf",!n.groupInput.is_locked),c.xp6(2),c.Q6J("ngIf",!n.groupInput.is_locked),c.xp6(2),c.Q6J("ngIf",!t.identification.folded&&!n.groupInput.is_locked),c.xp6(1),c.Q6J("ngIf",!t.identification.folded&&!n.groupInput.is_locked)}},directives:[s.gC,y.O5,Z.KE,Z.hX,b.Nt,C.ZL,Z.bx,C.XC,O.lW,A.Hw,Z.R9,y.sg,i.ey,x.wV,x.Fj,x.JJ,x.oH,Z.TO,ht],pipes:[y.Ov,y.JJ,y.Zx],styles:["[_nghost-%COMP%]{display:block;width:100%;height:100%}[_nghost-%COMP%]   .hidden[_ngcontent-%COMP%]{visibility:hidden}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]{display:flex}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-toggle[_ngcontent-%COMP%]{flex:0 1;display:inline-block;vertical-align:top;padding:5px 0 0 20px}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]{flex:1;display:inline-block;width:100%;min-height:45px}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]{width:100%;display:flex;padding:5px 0;flex:1}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .cell[_ngcontent-%COMP%]{position:relative;padding:0 10px;margin-right:15px;white-space:nowrap;text-overflow:ellipsis;overflow:hidden}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .cell.cell-text[_ngcontent-%COMP%]{line-height:45px}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .cell.cell-right[_ngcontent-%COMP%]{text-align:right}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .cell.cell-actions[_ngcontent-%COMP%]{max-width:35px}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .cell[_ngcontent-%COMP%]:first-child{flex:0 0 calc((100% + 60px)*0.40 - 60px)}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .cell[_ngcontent-%COMP%]:not(:first-child){flex:1 0 calc((100% + 60px)*0.08)}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row.row-first[_ngcontent-%COMP%]     .mat-form-field-wrapper{padding-bottom:15px}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row.row-title[_ngcontent-%COMP%]{height:45px;line-height:45px}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row.row-thin[_ngcontent-%COMP%]{padding:0}[_nghost-%COMP%]   mat-form-field[_ngcontent-%COMP%]{width:100%;padding:0 12px}[_nghost-%COMP%]   mat-form-field.header[_ngcontent-%COMP%]{margin-top:-5px}[_nghost-%COMP%]   mat-form-field.header[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{font-size:22px}[_nghost-%COMP%]   mat-form-field.invisible[_ngcontent-%COMP%]    .mat-form-field-underline{display:none!important}[_nghost-%COMP%]   p[_ngcontent-%COMP%]{font-size:14px;padding:0 12px}[_nghost-%COMP%]   .discounts-list[_ngcontent-%COMP%]{position:relative;padding:0 12px 0 0;width:100%}[_nghost-%COMP%]   .discounts-list[_ngcontent-%COMP%]   .discount-item[_ngcontent-%COMP%]{position:relative;background-color:#fff}[_nghost-%COMP%]   .discounts-list[_ngcontent-%COMP%]   .discount-item[_ngcontent-%COMP%]   .discount-remove[_ngcontent-%COMP%]{position:absolute;right:-5px;top:10px;z-index:2}"]}),t})();function Wt(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",7),c.NdJ("click",function(){return c.CHM(t),c.oxw().vm.rental_unit.reset()}),c.TgZ(1,"mat-icon"),c._uU(2,"close"),c.qZA(),c.qZA()}}function Xt(t,n){if(1&t&&(c.TgZ(0,"mat-option",9),c._uU(1),c.qZA()),2&t){const t=n.$implicit;c.Q6J("value",t),c.xp6(1),c.AsE(" ",t.name," (",t.capacity,") ")}}function Vt(t,n){1&t&&(c.TgZ(0,"mat-option"),c.TgZ(1,"i"),c._uU(2,"pas de r\xe9sultat"),c.qZA(),c.qZA())}function Kt(t,n){if(1&t&&(c.TgZ(0,"div"),c.YNc(1,Xt,2,3,"mat-option",8),c.YNc(2,Vt,3,0,"mat-option",6),c.qZA()),2&t){const t=n.$implicit;c.xp6(1),c.Q6J("ngForOf",t),c.xp6(1),c.Q6J("ngIf",0==t.length)}}let tn=(()=>{class t{constructor(t,n,e,i){this.api=t,this.auth=n,this.zone=e,this.snack=i,this.ready=!1,this.accomodation={},this.product=null,this.rental_unit=null,this.vm={rental_unit:{name:"",inputClue:new l.t(1),filteredList:new h.y,change:t=>this.rentalUnitChange(t),inputChange:t=>this.rentalUnitInputChange(t),focus:()=>this.rentalUnitFocus(),restore:()=>this.rentalUnitRestore(),reset:()=>this.rentalUnitReset(),display:t=>this.rentalUnitDisplay(t)},product:{id:0,name:""}}}ngOnInit(){this.accomodationInput.subscribe(t=>this.load(t)),this.vm.rental_unit.filteredList=this.vm.rental_unit.inputClue.pipe((0,f.b)(300),(0,_.U)(t=>"string"==typeof t?t:null==t?"":t.name),(0,v.zg)(t=>(0,u.mG)(this,void 0,void 0,function*(){return this.filterRentalUnits(t)})))}load(t){return(0,u.mG)(this,void 0,void 0,function*(){this.zone.run(()=>{this.ready=!1}),this.zone.run(()=>(0,u.mG)(this,void 0,void 0,function*(){try{for(let n of Object.keys(t))this.accomodation[n]=t[n];if(t.product_id){let n=yield this.api.read("lodging\\sale\\catalog\\Product",[t.product_id],["id","name","sku"]);if(n&&n.length){let t=n[0];this.product=t,this.vm.product.name=t.name+" ("+t.sku+")"}}if(t.rental_unit_id){let n=yield this.api.read("lodging\\realestate\\RentalUnit",[t.rental_unit_id],["id","name","capacity"]);if(n&&n.length){let t=n[0];this.rental_unit=t,this.vm.rental_unit.name=t.name+" ("+t.capacity+")"}}}catch(n){console.warn(n)}this.ready=!0}))})}rentalUnitInputChange(t){this.vm.rental_unit.inputClue.next(t.target.value)}rentalUnitFocus(){this.vm.rental_unit.inputClue.next("")}rentalUnitDisplay(t){return t?t.name+" ("+t.capacity+")":""}rentalUnitReset(){setTimeout(()=>{this.vm.rental_unit.name=""},100)}rentalUnitRestore(){this.vm.rental_unit.name=this.rental_unit?this.rental_unit.name+" ("+this.rental_unit.capacity+")":""}rentalUnitChange(t){if(console.log("BookingEditCustomerComponent::rentalUnitChange",t),t&&t.option&&t.option.value){let n=t.option.value;this.rental_unit=n,this.vm.rental_unit.name=n.name+" ("+n.capacity+")",this.accomodationOutput.next({id:this.accomodation.id,rental_unit_id:n.id})}}filterRentalUnits(t){return(0,u.mG)(this,void 0,void 0,function*(){let n=[];try{n=yield this.api.collect("lodging\\realestate\\RentalUnit",[["name","ilike","%"+t+"%"]],["id","name","capacity"],"name","asc",0,25)}catch(e){console.log(e)}return n})}}return t.\u0275fac=function(n){return new(n||t)(c.Y36(s.sM),c.Y36(s.Tq),c.Y36(c.R0b),c.Y36(g.ux))},t.\u0275cmp=c.Xpm({type:t,selectors:[["booking-edit-bookings-group-accomodation"]],inputs:{groupInput:"groupInput",accomodationOutput:"accomodationOutput",accomodationInput:"accomodationInput"},decls:12,vars:9,consts:[[1,"cell"],["matInput","","type","text","placeholder","Commencez \xe0 taper le nom",3,"matAutocomplete","value","keyup","focus","blur"],[3,"align"],["mat-button","","matSuffix","","mat-icon-button","","aria-label","Clear",3,"click",4,"ngIf"],[3,"displayWith","optionSelected"],["rentalUnitAutocomplete","matAutocomplete"],[4,"ngIf"],["mat-button","","matSuffix","","mat-icon-button","","aria-label","Clear",3,"click"],[3,"value",4,"ngFor","ngForOf"],[3,"value"]],template:function(t,n){if(1&t&&(c.TgZ(0,"div",0),c.TgZ(1,"mat-form-field"),c.TgZ(2,"mat-label"),c._uU(3,"Unit\xe9 locative"),c.qZA(),c.TgZ(4,"input",1),c.NdJ("keyup",function(t){return n.vm.rental_unit.inputChange(t)})("focus",function(){return n.vm.rental_unit.focus()})("blur",function(){return n.vm.rental_unit.restore()}),c.qZA(),c.TgZ(5,"mat-hint",2),c._uU(6),c.qZA(),c.YNc(7,Wt,3,0,"button",3),c.TgZ(8,"mat-autocomplete",4,5),c.NdJ("optionSelected",function(t){return n.vm.rental_unit.change(t)}),c.YNc(10,Kt,3,2,"div",6),c.ALo(11,"async"),c.qZA(),c.qZA(),c.qZA()),2&t){const t=c.MAs(9);c.xp6(4),c.Q6J("matAutocomplete",t)("value",n.vm.rental_unit.name),c.xp6(1),c.Q6J("align","end"),c.xp6(1),c.hij("Logement assign\xe9 \xe0 ",n.vm.product.name,""),c.xp6(1),c.Q6J("ngIf",n.vm.rental_unit.name.length),c.xp6(1),c.Q6J("displayWith",n.vm.rental_unit.display),c.xp6(2),c.Q6J("ngIf",c.lcZ(11,7,n.vm.rental_unit.filteredList))}},directives:[Z.KE,Z.hX,b.Nt,C.ZL,Z.bx,y.O5,C.XC,O.lW,Z.R9,A.Hw,y.sg,i.ey],pipes:[y.Ov],styles:["[_nghost-%COMP%]{display:flex;width:100%;height:100%}[_nghost-%COMP%]   .hidden[_ngcontent-%COMP%]{visibility:hidden}[_nghost-%COMP%]   .cell[_ngcontent-%COMP%]{flex:0 1 30%}[_nghost-%COMP%]   .cell[_ngcontent-%COMP%]   mat-form-field[_ngcontent-%COMP%]{width:100%}"]}),t})();function nn(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",12),c.NdJ("click",function(){c.CHM(t),c.oxw();const n=c.MAs(1);return n.identification.folded=!n.identification.folded}),c.TgZ(1,"mat-icon",13),c._uU(2,"keyboard_arrow_up"),c.qZA(),c.qZA()}}function en(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",12),c.NdJ("click",function(){c.CHM(t),c.oxw();const n=c.MAs(1);return n.identification.folded=!n.identification.folded}),c.TgZ(1,"mat-icon",13),c._uU(2,"keyboard_arrow_right"),c.qZA(),c.qZA()}}function on(t,n){1&t&&(c.TgZ(0,"mat-error"),c._uU(1," Ne peut \xeatre vide. "),c.qZA())}function an(t,n){1&t&&(c.TgZ(0,"mat-error"),c._uU(1," Doit \xeatre sup\xe9rieur \xe0 0. "),c.qZA())}function sn(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"div",6),c.TgZ(1,"div",7),c.TgZ(2,"div",14),c.TgZ(3,"mat-form-field",15),c.TgZ(4,"mat-label"),c._uU(5,"Intitul\xe9 du s\xe9jour"),c.qZA(),c.TgZ(6,"input",16),c.NdJ("blur",function(){return c.CHM(t),c.oxw().vm.name.change()}),c.qZA(),c.TgZ(7,"mat-hint"),c._uU(8,"Libell\xe9 du regroupement."),c.qZA(),c.YNc(9,on,2,0,"mat-error",17),c.qZA(),c.qZA(),c.TgZ(10,"div",18),c.TgZ(11,"mat-form-field"),c.TgZ(12,"mat-label"),c._uU(13,"Dates du s\xe9jour"),c.qZA(),c.TgZ(14,"mat-date-range-input",19),c.TgZ(15,"input",20),c.NdJ("blur",function(){return c.CHM(t),c.oxw().vm.daterange.change()}),c.qZA(),c.TgZ(16,"input",21),c.NdJ("blur",function(){return c.CHM(t),c.oxw().vm.daterange.change()}),c.qZA(),c.qZA(),c._UZ(17,"mat-datepicker-toggle",22),c.TgZ(18,"mat-date-range-picker",23,24),c.NdJ("closed",function(){return c.CHM(t),c.oxw().vm.daterange.change()}),c.qZA(),c.TgZ(20,"mat-hint",25),c.TgZ(21,"strong"),c._uU(22),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.TgZ(23,"div",26),c.TgZ(24,"mat-form-field"),c.TgZ(25,"mat-label"),c._uU(26,"Participants"),c.qZA(),c.TgZ(27,"input",27),c.NdJ("blur",function(){return c.CHM(t),c.oxw().vm.participants_count.change()}),c.qZA(),c.TgZ(28,"mat-hint"),c._uU(29,"Nombre d'h\xf4tes"),c.qZA(),c.YNc(30,an,2,0,"mat-error",17),c.qZA(),c.qZA(),c.qZA(),c.qZA()}if(2&t){const t=c.MAs(19),n=c.oxw();c.xp6(6),c.Q6J("formControl",n.vm.name.formControl),c.xp6(3),c.Q6J("ngIf",!n.vm.name.formControl.hasError("required")),c.xp6(5),c.Q6J("rangePicker",t),c.xp6(1),c.Q6J("formControl",n.vm.daterange.start.formControl),c.xp6(1),c.Q6J("formControl",n.vm.daterange.end.formControl),c.xp6(1),c.Q6J("for",t),c.xp6(3),c.Q6J("align","end"),c.xp6(2),c.AsE("",n.vm.daterange.nights_count," ",n.vm.daterange.nights_count>1?"nuit\xe9es":"nuit\xe9e",""),c.xp6(5),c.Q6J("value",n.vm.participants_count.value)("formControl",n.vm.participants_count.formControl),c.xp6(3),c.Q6J("ngIf",!n.vm.participants_count.formControl.hasError("required"))}}function rn(t,n){1&t&&(c.TgZ(0,"mat-error"),c._uU(1," Ne peut \xeatre vide. "),c.qZA())}function cn(t,n){1&t&&(c.TgZ(0,"mat-error"),c._uU(1," Doit \xeatre sup\xe9rieur \xe0 0. "),c.qZA())}function dn(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",44),c.NdJ("click",function(){return c.CHM(t),c.oxw(2).vm.rate_class.reset()}),c.TgZ(1,"mat-icon"),c._uU(2,"close"),c.qZA(),c.qZA()}}function un(t,n){if(1&t&&(c.TgZ(0,"mat-option",46),c._uU(1),c.qZA()),2&t){const t=n.$implicit;c.Q6J("value",t),c.xp6(1),c.hij(" ",t.name," ")}}function ln(t,n){1&t&&(c.TgZ(0,"mat-option"),c.TgZ(1,"i"),c._uU(2,"pas de r\xe9sultat"),c.qZA(),c.qZA())}function pn(t,n){if(1&t&&(c.TgZ(0,"div"),c.YNc(1,un,2,2,"mat-option",45),c.YNc(2,ln,3,0,"mat-option",17),c.qZA()),2&t){const t=n.$implicit;c.xp6(1),c.Q6J("ngForOf",t),c.xp6(1),c.Q6J("ngIf",0==t.length)}}function gn(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",44),c.NdJ("click",function(){return c.CHM(t),c.oxw(3).vm.pack.reset()}),c.TgZ(1,"mat-icon"),c._uU(2,"close"),c.qZA(),c.qZA()}}function mn(t,n){if(1&t&&(c.TgZ(0,"mat-option",46),c._uU(1),c.qZA()),2&t){const t=n.$implicit;c.Q6J("value",t),c.xp6(1),c.hij(" ",t.name," ")}}function hn(t,n){1&t&&(c.TgZ(0,"mat-option"),c.TgZ(1,"i"),c._uU(2,"pas de r\xe9sultat"),c.qZA(),c.qZA())}function fn(t,n){if(1&t&&(c.TgZ(0,"div"),c.YNc(1,mn,2,2,"mat-option",45),c.YNc(2,hn,3,0,"mat-option",17),c.qZA()),2&t){const t=n.$implicit;c.xp6(1),c.Q6J("ngForOf",t),c.xp6(1),c.Q6J("ngIf",0==t.length)}}function _n(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"div",47),c.TgZ(1,"mat-form-field"),c.TgZ(2,"mat-label"),c._uU(3,"Pack de r\xe9f\xe9rence"),c.qZA(),c.TgZ(4,"input",29),c.NdJ("keyup",function(n){return c.CHM(t),c.oxw(2).vm.pack.inputChange(n)})("focus",function(){return c.CHM(t),c.oxw(2).vm.pack.focus()})("blur",function(){return c.CHM(t),c.oxw(2).vm.pack.restore()}),c.qZA(),c.YNc(5,gn,3,0,"button",30),c.TgZ(6,"mat-autocomplete",31,48),c.NdJ("optionSelected",function(n){return c.CHM(t),c.oxw(2).vm.pack.change("name",n.option.value)}),c.YNc(8,fn,3,2,"div",17),c.ALo(9,"async"),c.qZA(),c.TgZ(10,"mat-hint",33),c.TgZ(11,"span"),c._uU(12,"Type de s\xe9jour de la r\xe9servation"),c.qZA(),c.qZA(),c.qZA(),c.qZA()}if(2&t){const t=c.MAs(7),n=c.oxw(2);c.xp6(4),c.Q6J("matAutocomplete",t)("value",n.vm.pack.name),c.xp6(1),c.Q6J("ngIf",n.vm.pack.name.length),c.xp6(1),c.Q6J("displayWith",n.vm.pack.display),c.xp6(2),c.Q6J("ngIf",c.lcZ(9,6,n.vm.pack.filteredList)),c.xp6(2),c.Q6J("align","start")}}function vn(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"div",49),c.TgZ(1,"mat-form-field",39),c.TgZ(2,"mat-slide-toggle",50),c.NdJ("change",function(n){return c.CHM(t),c.oxw(2).vm.pack.change("is_locked",n.checked)}),c._uU(3,"Liste des produits verrouill\xe9e"),c.qZA(),c._UZ(4,"textarea",41),c.qZA(),c.qZA()}if(2&t){const t=c.oxw(2);c.xp6(2),c.Q6J("ngModel",t.vm.pack.is_locked)}}function Zn(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"div",6),c.TgZ(1,"div",7),c.TgZ(2,"div",14),c.TgZ(3,"mat-form-field",15),c.TgZ(4,"mat-label"),c._uU(5,"Intitul\xe9 du s\xe9jour"),c.qZA(),c.TgZ(6,"input",16),c.NdJ("blur",function(){return c.CHM(t),c.oxw().vm.name.change()}),c.qZA(),c.TgZ(7,"mat-hint"),c._uU(8,"Libell\xe9 du regroupement."),c.qZA(),c.YNc(9,rn,2,0,"mat-error",17),c.qZA(),c.qZA(),c.TgZ(10,"div",18),c.TgZ(11,"mat-form-field"),c.TgZ(12,"mat-label"),c._uU(13,"Dates du s\xe9jour"),c.qZA(),c.TgZ(14,"mat-date-range-input",19),c.TgZ(15,"input",20),c.NdJ("blur",function(){return c.CHM(t),c.oxw().vm.daterange.change()}),c.qZA(),c.TgZ(16,"input",21),c.NdJ("blur",function(){return c.CHM(t),c.oxw().vm.daterange.change()}),c.qZA(),c.qZA(),c._UZ(17,"mat-datepicker-toggle",22),c.TgZ(18,"mat-date-range-picker",23,24),c.NdJ("closed",function(){return c.CHM(t),c.oxw().vm.daterange.change()}),c.qZA(),c.TgZ(20,"mat-hint",25),c.TgZ(21,"strong"),c._uU(22),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.TgZ(23,"div",26),c.TgZ(24,"mat-form-field"),c.TgZ(25,"mat-label"),c._uU(26,"Participants"),c.qZA(),c.TgZ(27,"input",27),c.NdJ("blur",function(){return c.CHM(t),c.oxw().vm.participants_count.change()}),c.qZA(),c.TgZ(28,"mat-hint"),c._uU(29,"Nombre d'h\xf4tes"),c.qZA(),c.YNc(30,cn,2,0,"mat-error",17),c.qZA(),c.qZA(),c.qZA(),c.TgZ(31,"div",7),c.TgZ(32,"div",28),c.TgZ(33,"mat-form-field"),c.TgZ(34,"mat-label"),c._uU(35,"Cat\xe9gorie tarifaire"),c.qZA(),c.TgZ(36,"input",29),c.NdJ("keyup",function(n){return c.CHM(t),c.oxw().vm.rate_class.inputChange(n)})("focus",function(){return c.CHM(t),c.oxw().vm.rate_class.focus()})("blur",function(){return c.CHM(t),c.oxw().vm.rate_class.restore()}),c.qZA(),c.YNc(37,dn,3,0,"button",30),c.TgZ(38,"mat-autocomplete",31,32),c.NdJ("optionSelected",function(n){return c.CHM(t),c.oxw().vm.rate_class.change(n)}),c.YNc(40,pn,3,2,"div",17),c.ALo(41,"async"),c.qZA(),c.TgZ(42,"mat-hint",33),c.TgZ(43,"span"),c._uU(44,"Cat\xe9gorie tarifaire de facturation"),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.TgZ(45,"div",34),c.TgZ(46,"mat-form-field"),c.TgZ(47,"mat-label"),c._uU(48,"Type de s\xe9jour"),c.qZA(),c.TgZ(49,"mat-select",35),c.NdJ("selectionChange",function(n){return c.CHM(t),c.oxw().vm.sojourn_type.change(n)}),c.TgZ(50,"mat-option",36),c._uU(51,"GG"),c.qZA(),c.TgZ(52,"mat-option",37),c._uU(53,"GA"),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.TgZ(54,"div",7),c.TgZ(55,"div",38),c.TgZ(56,"mat-form-field",39),c.TgZ(57,"mat-slide-toggle",40),c.NdJ("change",function(n){return c.CHM(t),c.oxw().vm.pack.change("has_pack",n.checked)}),c._uU(58,"Utiliser un pack ?"),c.qZA(),c._UZ(59,"textarea",41),c.qZA(),c.qZA(),c.YNc(60,_n,13,8,"div",42),c.YNc(61,vn,5,1,"div",43),c.qZA(),c.qZA()}if(2&t){const t=c.MAs(19),n=c.MAs(39),e=c.oxw();c.xp6(6),c.Q6J("formControl",e.vm.name.formControl),c.xp6(3),c.Q6J("ngIf",!e.vm.name.formControl.hasError("required")),c.xp6(5),c.Q6J("rangePicker",t),c.xp6(1),c.Q6J("formControl",e.vm.daterange.start.formControl),c.xp6(1),c.Q6J("formControl",e.vm.daterange.end.formControl),c.xp6(1),c.Q6J("for",t),c.xp6(3),c.Q6J("align","end"),c.xp6(2),c.AsE("",e.vm.daterange.nights_count," ",e.vm.daterange.nights_count>1?"nuit\xe9es":"nuit\xe9e",""),c.xp6(5),c.Q6J("value",e.vm.participants_count.value)("formControl",e.vm.participants_count.formControl),c.xp6(3),c.Q6J("ngIf",!e.vm.participants_count.formControl.hasError("required")),c.xp6(6),c.Q6J("matAutocomplete",n)("value",e.vm.rate_class.name),c.xp6(1),c.Q6J("ngIf",e.vm.rate_class.name.length),c.xp6(1),c.Q6J("displayWith",e.vm.rate_class.display),c.xp6(2),c.Q6J("ngIf",c.lcZ(41,22,e.vm.rate_class.filteredList)),c.xp6(2),c.Q6J("align","start"),c.xp6(7),c.Q6J("ngModel",e.vm.sojourn_type.value),c.xp6(8),c.Q6J("ngModel",e.vm.pack.has_pack),c.xp6(3),c.Q6J("ngIf",e.vm.pack.has_pack),c.xp6(1),c.Q6J("ngIf",e.vm.pack.has_pack)}}function bn(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",12),c.NdJ("click",function(){c.CHM(t),c.oxw();const n=c.MAs(1);return n.products.folded=!n.products.folded}),c.TgZ(1,"mat-icon",13),c._uU(2,"keyboard_arrow_up"),c.qZA(),c.qZA()}}function Cn(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",12),c.NdJ("click",function(){c.CHM(t),c.oxw();const n=c.MAs(1);return n.products.folded=!n.products.folded}),c.TgZ(1,"mat-icon",13),c._uU(2,"keyboard_arrow_right"),c.qZA(),c.qZA()}}function yn(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",51),c.NdJ("click",function(){return c.CHM(t),c.oxw().vm.lines.add()}),c.TgZ(1,"mat-icon"),c._uU(2,"add"),c.qZA(),c.qZA()}}function kn(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",12),c.NdJ("click",function(){c.CHM(t);const n=c.oxw().$implicit;return c.oxw(2).vm.lines.remove(n)}),c.TgZ(1,"mat-icon"),c._uU(2,"delete"),c.qZA(),c.qZA()}}function xn(t,n){if(1&t&&(c.TgZ(0,"div",60),c.TgZ(1,"div",61),c.TgZ(2,"mat-icon",62),c._uU(3,"drag_indicator"),c.qZA(),c.qZA(),c.TgZ(4,"div",63),c.YNc(5,kn,3,0,"button",4),c.qZA(),c._UZ(6,"booking-edit-bookings-group-line",64),c.qZA()),2&t){const t=n.$implicit,e=n.index,i=c.oxw(2);c.Q6J("cdkDragData",t),c.xp6(5),c.Q6J("ngIf",!i.vm.pack.is_locked),c.xp6(1),c.Q6J("groupInput",i.group)("lineInput",i._lineOutput[e])("lineOutput",i._lineInput)}}function On(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"div",7),c.TgZ(1,"div",52),c.TgZ(2,"div",53),c.TgZ(3,"div",54),c.TgZ(4,"div",55),c._uU(5,"SKU"),c.qZA(),c.TgZ(6,"div",56),c._uU(7,"QT\xc9"),c.qZA(),c.TgZ(8,"div",56),c._uU(9,"GT\xc9"),c.qZA(),c.TgZ(10,"div",56),c._uU(11,"P.U."),c.qZA(),c.TgZ(12,"div",56),c._uU(13,"R\xc9DUC"),c.qZA(),c.TgZ(14,"div",56),c._uU(15,"TAX"),c.qZA(),c.TgZ(16,"div",56),c._uU(17,"PRIX"),c.qZA(),c._UZ(18,"div",57),c.qZA(),c.qZA(),c.TgZ(19,"div",58),c.NdJ("cdkDropListDropped",function(n){return c.CHM(t),c.oxw().vm.lines.drop(n)}),c.YNc(20,xn,7,5,"div",59),c.qZA(),c.qZA(),c.qZA()}if(2&t){const t=c.oxw();c.xp6(20),c.Q6J("ngForOf",t.lines)}}function An(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",12),c.NdJ("click",function(){c.CHM(t),c.oxw();const n=c.MAs(1);return n.accomodations.folded=!n.accomodations.folded}),c.TgZ(1,"mat-icon",13),c._uU(2,"keyboard_arrow_up"),c.qZA(),c.qZA()}}function qn(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",12),c.NdJ("click",function(){c.CHM(t),c.oxw();const n=c.MAs(1);return n.accomodations.folded=!n.accomodations.folded}),c.TgZ(1,"mat-icon",13),c._uU(2,"keyboard_arrow_right"),c.qZA(),c.qZA()}}function Tn(t,n){1&t&&(c.TgZ(0,"div",6),c.TgZ(1,"div",7),c.TgZ(2,"div",65),c._uU(3,"Logements "),c.qZA(),c.qZA(),c.qZA())}function wn(t,n){if(1&t&&(c.TgZ(0,"div",68),c._UZ(1,"booking-edit-bookings-group-accomodation",69),c.qZA()),2&t){const t=n.index,e=c.oxw(2);c.xp6(1),c.Q6J("groupInput",e.group)("accomodationInput",e._accomodationOutput[t])("accomodationOutput",e._accomodationInput)}}function Pn(t,n){if(1&t&&(c.TgZ(0,"div",6),c.TgZ(1,"div",7),c.TgZ(2,"div",65),c._uU(3,"Logements "),c.qZA(),c.qZA(),c.TgZ(4,"div",66),c.YNc(5,wn,2,3,"div",67),c.qZA(),c.qZA()),2&t){const t=c.oxw();c.xp6(5),c.Q6J("ngForOf",t.accomodations)}}const Mn=function(){return{folded:!0}},In=function(t,n,e){return{identification:t,products:n,accomodations:e}};let Un=(()=>{class t{constructor(t,n,e,i,o){this.api=t,this.auth=n,this.dialog=e,this.zone=i,this.snack=o,this._lineInput=new l.t(1),this._lineOutput=[],this._accomodationInput=new l.t(1),this._accomodationOutput=[],this.model_fields={BookingLine:["id","product_id","order","qty","price_id","vat_rate","unit_price","price","booking_id","booking_line_group_id","price_adapters_ids","auto_discounts_ids","manual_discounts_ids","qty_accounting_method"],Consumption:["id","product_id","rental_unit_id"]},this.ready=!1,this.group={},this.rate_class=null,this.pack=null,this.lines=[],this.accomodations=[],this.vm={price:{value:0},name:{value:"",formControl:new x.NI("",x.kI.required),change:()=>this.nameChange()},daterange:{start:{formControl:new x.NI},end:{formControl:new x.NI},nights_count:0,change:()=>this.dateRangeChange()},participants_count:{value:1,formControl:new x.NI("",x.kI.required),change:()=>this.nbPersChange()},sojourn_type:{value:"GG",change:t=>this.sojournTypeChange(t)},pack:{name:"",has_pack:!1,is_locked:!1,inputClue:new l.t(1),filteredList:new h.y,change:(t,n)=>this.packChange(t,n),inputChange:t=>this.packInputChange(t),focus:()=>this.packFocus(),restore:()=>this.packRestore(),reset:()=>this.packReset(),display:t=>this.packDisplay(t)},rate_class:{name:"",inputClue:new l.t(1),filteredList:new h.y,change:t=>this.rateClassChange(t),inputChange:t=>this.rateClassInputChange(t),focus:()=>this.rateClassFocus(),restore:()=>this.rateClassRestore(),reset:()=>this.rateClassReset(),display:t=>this.rateClassDisplay(t)},lines:{add:()=>this.lineAdd(),remove:t=>this.lineRemove(t),drop:t=>this.lineDrop(t)}}}ngOnInit(){this.groupInput.subscribe(t=>this.load(t)),this._lineInput.subscribe(t=>this.updateFromLine(t)),this._accomodationInput.subscribe(t=>this.updateFromAccomodation(t)),this.vm.pack.filteredList=this.vm.pack.inputClue.pipe((0,f.b)(300),(0,_.U)(t=>"string"==typeof t?t:null==t?"":t.name),(0,v.zg)(t=>(0,u.mG)(this,void 0,void 0,function*(){return this.filterPacks(t)}))),this.vm.rate_class.filteredList=this.vm.rate_class.inputClue.pipe((0,f.b)(300),(0,_.U)(t=>"string"==typeof t?t:null==t?"":t.name),(0,v.zg)(t=>(0,u.mG)(this,void 0,void 0,function*(){return this.filterRateClasses(t)}))),this.vm.daterange.start.formControl.valueChanges.subscribe(t=>{this.dateRangeUpdate()}),this.vm.daterange.end.formControl.valueChanges.subscribe(t=>{this.dateRangeUpdate()}),this.vm.participants_count.formControl.valueChanges.subscribe(t=>{this.vm.participants_count.value=t}),this.vm.name.formControl.valueChanges.subscribe(t=>{this.vm.name.value=t})}load(t){return(0,u.mG)(this,void 0,void 0,function*(){this.zone.run(()=>{}),this.zone.run(()=>(0,u.mG)(this,void 0,void 0,function*(){try{console.log("BookingEditBookingsGroupComponent: received changes from parent",t.id,t);for(let n of Object.keys(t))this.group[n]=t[n];if(t.name&&this.vm.name.formControl.setValue(t.name),t.hasOwnProperty("price")&&(this.vm.price.value=t.price),t.rate_class_id){let n=yield this.api.read("sale\\customer\\RateClass",[t.rate_class_id],["id","name","description"]);if(n&&n.length){let t=n[0];this.rate_class=t,this.vm.rate_class.name=t.name}}if(t.pack_id){let n=yield this.api.read("lodging\\sale\\catalog\\Product",[t.pack_id],["id","name","sku"]);if(n&&n.length){let t=n[0];this.pack=t,this.vm.pack.name=t.name}}if(t.hasOwnProperty("has_pack")&&(this.vm.pack.has_pack=t.has_pack),t.hasOwnProperty("is_locked")&&(this.vm.pack.is_locked=t.is_locked),t.hasOwnProperty("nb_pers")&&this.vm.participants_count.formControl.setValue(t.nb_pers),t.sojourn_type&&(this.vm.sojourn_type.value=t.sojourn_type),t.date_from&&this.vm.daterange.start.formControl.setValue(t.date_from),t.date_to&&this.vm.daterange.end.formControl.setValue(t.date_to),t.booking_lines_ids){let n=yield this.loadLines(t.booking_lines_ids,this.model_fields.BookingLine);if(n){for(let[t,e]of n.entries())if(t>=this.lines.length){let t=new l.t(1);this._lineOutput.push(t),t.next(e),this.lines.push(e)}else if(JSON.stringify(this.lines[t])!=JSON.stringify(e)){let n=new l.t(1);this._lineOutput[t]=n,this.lines[t]=e,n.next(e)}this.lines.length>n.length&&(this.lines.splice(n.length),this._lineOutput.splice(n.length))}}if(t.accomodations_ids){let n=yield this.loadAccomodations(t.accomodations_ids,this.model_fields.Consumption);if(n){for(let[t,e]of n.entries())if(t>=this.accomodations.length){let t=new l.t(1);this._accomodationOutput.push(t),t.next(e),this.accomodations.push(e)}else if(JSON.stringify(this.accomodations[t])!=JSON.stringify(e)){let n=new l.t(1);this._accomodationOutput[t]=n,this.accomodations[t]=e,n.next(e)}this.accomodations.length>n.length&&(this.accomodations.splice(n.length),this._accomodationOutput.splice(n.length))}}}catch(n){console.warn(n)}this.ready=!0}))})}updateFromAccomodation(t){return(0,u.mG)(this,void 0,void 0,function*(){console.log("BookingEditBookingsGroupComponent: received changes from child",t);let n=!1;try{let e=this.lines.findIndex(n=>n.id==t.id),i=this.lines.find(n=>n.id==t.id);if(t.hasOwnProperty("rental_unit_id")&&t.rental_unit_id!=i.rental_unit_id&&(n=!0,yield this.updateRentalUnit(t)),n){let n=(yield this.loadAccomodations([t.id],this.model_fields.Consumption))[0];for(let t of Object.keys(n))this.accomodations[e][t]=n[t];this._accomodationOutput[e].next(this.accomodations[e]),this.snack.open("Logement mis \xe0 jour")}}catch(e){console.warn(e)}})}updateFromLine(t){return(0,u.mG)(this,void 0,void 0,function*(){console.log("BookingEditBookingsGroupComponent: received changes from child",t);try{let n=!1,e={},i=this.lines.findIndex(n=>n.id==t.id),o=this.lines.find(n=>n.id==t.id);if(t.hasOwnProperty("product_id")&&t.product_id!=o.product_id&&(yield this.updateProduct(t),n=!0,e.booking_id=["price"],e.self=["price"]),t.hasOwnProperty("qty")&&t.qty!=o.qty&&(yield this.updateQuantity(t),n=!0,e.booking_id=["price"],e.self=["price"]),t.hasOwnProperty("price_adapters_ids")&&(n=!0,e.booking_id=["price"],e.self=["price"]),t.hasOwnProperty("refresh")){let n=this.model_fields.BookingLine;if(t.refresh.hasOwnProperty("self")){Array.isArray(t.refresh.self)&&(n=t.refresh.self);let e=yield this.loadLines([t.id],n);this._lineOutput[i].next(e[0])}t.refresh.hasOwnProperty("booking_line_group_id")&&(e.self=e.hasOwnPropertyKey("self")?[...e.self,...t.refresh.booking_line_group_id]:t.refresh.booking_line_group_id)}else if(n){let n=(yield this.loadLines([t.id],this.model_fields.BookingLine))[0];for(let t of Object.keys(n))this.lines[i][t]=n[t];this._lineOutput[i].next(this.lines[i]),this.snack.open("Regroupement mis \xe0 jour")}Object.keys(e).length&&this.groupOutput.next({id:this.group.id,refresh:e})}catch(n){console.warn("some changes could not be stored",n),this.snack.open("Erreur - certains changements n'ont pas pu \xeatre enregistr\xe9s.")}})}loadLines(t,n){return(0,u.mG)(this,void 0,void 0,function*(){return yield this.api.read("lodging\\sale\\booking\\BookingLine",t,n,"order")})}loadAccomodations(t,n){return(0,u.mG)(this,void 0,void 0,function*(){return yield this.api.read("lodging\\sale\\booking\\BookingLine",t,n)})}dateRangeUpdate(){let t=this.vm.daterange.start.formControl.value,n=this.vm.daterange.end.formControl.value;if(t&&n){let e=Math.floor((Date.parse(n.toString())-Date.parse(t.toString()))/864e5);this.vm.daterange.nights_count=e<0?0:e}}nbPersChange(){console.log("BookingEditCustomerComponent::nbPersChange"),this.groupOutput.next({id:this.group.id,nb_pers:this.vm.participants_count.value,refresh:{self:["price"],booking_id:["price"]}})}nameChange(){console.log("BookingEditCustomerComponent::nameChange"),this.groupOutput.next({id:this.group.id,name:this.vm.name.value})}dateRangeChange(){console.log("BookingEditCustomerComponent::dateRangeChange"),this.groupOutput.next({id:this.group.id,date_from:this.vm.daterange.start.formControl.value,date_to:this.vm.daterange.end.formControl.value})}packChange(t,n){switch(console.log("BookingEditCustomerComponent::packChange",n),t){case"name":let t=n;this.pack=t,this.vm.pack.name=t.name,this.groupOutput.next({id:this.group.id,pack_id:t.id});break;case"has_pack":this.vm.pack.has_pack=n,this.groupOutput.next({id:this.group.id,has_pack:n});break;case"is_locked":this.vm.pack.is_locked=n,this.groupOutput.next({id:this.group.id,is_locked:n})}}packInputChange(t){this.vm.pack.inputClue.next(t.target.value)}packFocus(){this.vm.pack.inputClue.next("")}packDisplay(t){return t?t.name:""}packReset(){setTimeout(()=>{this.vm.pack.name=""},100)}packRestore(){this.vm.pack.name=this.pack?this.pack.name:""}sojournTypeChange(t){}rateClassChange(t){if(console.log("BookingEditCustomerComponent::rateClassChange",t),t&&t.option&&t.option.value){let n=t.option.value;this.rate_class=n,this.vm.rate_class.name=n.name,this.groupOutput.next({id:this.group.id,rate_class_id:n.id})}}rateClassInputChange(t){this.vm.rate_class.inputClue.next(t.target.value)}rateClassFocus(){this.vm.rate_class.inputClue.next("")}rateClassDisplay(t){return t?t.name+" - "+t.description:""}rateClassReset(){setTimeout(()=>{this.vm.rate_class.name=""},100)}rateClassRestore(){this.vm.rate_class.name=this.rate_class?this.rate_class.name:""}filterPacks(t){return(0,u.mG)(this,void 0,void 0,function*(){let n=[];try{n=yield this.api.collect("lodging\\sale\\catalog\\Product",[["name","ilike","%"+t+"%"],["is_pack","=","true"]],["id","name"],"name","asc",0,25)}catch(e){console.log(e)}return n})}filterRateClasses(t){return(0,u.mG)(this,void 0,void 0,function*(){let n=[];try{n=yield this.api.collect("sale\\customer\\RateClass",[["name","ilike","%"+t+"%"]],["id","name","description"],"name","asc",0,25)}catch(e){console.log(e)}return n})}lineAdd(){return(0,u.mG)(this,void 0,void 0,function*(){try{const t=yield this.api.create("lodging\\sale\\booking\\BookingLine",{order:this.lines.length+1,booking_id:this.group.booking_id,booking_line_group_id:this.group.id});this.groupOutput.next({id:this.group.id,booking_lines_ids:[t.id]})}catch(t){console.log(t)}})}lineRemove(t){return(0,u.mG)(this,void 0,void 0,function*(){this.groupOutput.next({id:this.group.id,booking_lines_ids:[-t.id]})})}lineDrop(t){(0,pt.bA)(this.lines,t.previousIndex,t.currentIndex),(0,pt.bA)(this._lineOutput,t.previousIndex,t.currentIndex);for(let n in this.lines)this.updateFromLine({id:this.lines[n].id,order:parseInt(n)+1})}updateProduct(t){return(0,u.mG)(this,void 0,void 0,function*(){yield this.api.update("lodging\\sale\\booking\\BookingLine",[t.id],{product_id:t.product_id})})}updateQuantity(t){return(0,u.mG)(this,void 0,void 0,function*(){yield this.api.update("lodging\\sale\\booking\\BookingLine",[t.id],{qty:t.qty})})}updateRentalUnit(t){return(0,u.mG)(this,void 0,void 0,function*(){yield this.api.update("lodging\\sale\\booking\\BookingLine",[t.id],{rental_unit_id:t.rental_unit_id})})}}return t.\u0275fac=function(n){return new(n||t)(c.Y36(s.sM),c.Y36(s.Tq),c.Y36(p.uw),c.Y36(c.R0b),c.Y36(g.ux))},t.\u0275cmp=c.Xpm({type:t,selectors:[["booking-edit-bookings-group"]],inputs:{bookingInput:"bookingInput",groupOutput:"groupOutput",groupInput:"groupInput"},decls:28,vars:26,consts:[[3,"var"],["vGroup","var"],[1,"part"],[1,"part-toggle"],["mat-icon-button","",3,"click",4,"ngIf"],["class","part-container",4,"ngIf"],[1,"part-container"],[1,"row"],[1,"row-products-title"],["mat-mini-fab","","color","primary","style","transform: scale(0.65);",3,"click",4,"ngIf"],[1,"row-products-price"],["class","row",4,"ngIf"],["mat-icon-button","",3,"click"],[2,"font-size","15px"],[1,"",2,"min-width","350px"],[1,"header"],["type","text","matInput","",3,"formControl","blur"],[4,"ngIf"],[1,"cell",2,"max-width","260px"],[3,"rangePicker"],["matStartDate","","placeholder","dd/mm/yyyy",3,"formControl","blur"],["matEndDate","","placeholder","dd/mm/yyyy",3,"formControl","blur"],["matSuffix","",3,"for"],[3,"closed"],["sojournDateRangePicker",""],[3,"align"],[1,"cell",2,"max-width","150px"],["type","number","matInput","",3,"value","formControl","blur"],[1,"cell",2,"max-width","250px"],["matInput","","type","text","placeholder","Commencez \xe0 taper le nom",3,"matAutocomplete","value","keyup","focus","blur"],["mat-button","","matSuffix","","mat-icon-button","","aria-label","Clear",3,"click",4,"ngIf"],[3,"displayWith","optionSelected"],["rateClassAutocomplete","matAutocomplete"],[2,"opacity","1",3,"align"],[1,"cell",2,"max-width","120px"],[3,"ngModel","selectionChange"],["value","GG"],["value","GA"],[1,"cell",2,"max-width","200px"],["floatLabel","always",1,"invisible"],["color","primary",3,"ngModel","change"],["matInput","","hidden",""],["class","cell","style","max-width: 350px;",4,"ngIf"],["class","cell",4,"ngIf"],["mat-button","","matSuffix","","mat-icon-button","","aria-label","Clear",3,"click"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],[1,"cell",2,"max-width","350px"],["packAutocomplete","matAutocomplete"],[1,"cell"],[3,"ngModel","change"],["mat-mini-fab","","color","primary",2,"transform","scale(0.65)",3,"click"],[2,"width","100%"],[1,"products-header"],[2,"display","flex","width","100%"],[1,"product-cell",2,"text-align","left"],[1,"product-cell"],[1,"product-cell",2,"max-width","35px"],["cdkDropList","",1,"products-list",3,"cdkDropListDropped"],["class","product-item","cdkDrag","",3,"cdkDragData",4,"ngFor","ngForOf"],["cdkDrag","",1,"product-item",3,"cdkDragData"],["cdkDragHandle","",1,"product-handle"],[2,"font-size","16px"],[1,"product-remove"],[3,"groupInput","lineInput","lineOutput"],[2,"margin-top","8px"],[1,"row",2,"display","block"],["class","accomodation-item",4,"ngFor","ngForOf"],[1,"accomodation-item"],[3,"groupInput","accomodationInput","accomodationOutput"]],template:function(t,n){if(1&t&&(c._UZ(0,"div",0,1),c.TgZ(2,"div"),c.TgZ(3,"div",2),c.TgZ(4,"div",3),c.YNc(5,nn,3,0,"button",4),c.YNc(6,en,3,0,"button",4),c.qZA(),c.YNc(7,sn,31,12,"div",5),c.YNc(8,Zn,62,24,"div",5),c.qZA(),c.TgZ(9,"div",2),c.TgZ(10,"div",3),c.YNc(11,bn,3,0,"button",4),c.YNc(12,Cn,3,0,"button",4),c.qZA(),c.TgZ(13,"div",6),c.TgZ(14,"div",7),c.TgZ(15,"div",8),c._uU(16,"Produits "),c.YNc(17,yn,3,0,"button",9),c.qZA(),c.TgZ(18,"div",10),c._uU(19),c.ALo(20,"number"),c.qZA(),c.qZA(),c.YNc(21,On,21,1,"div",11),c.qZA(),c.qZA(),c.TgZ(22,"div",2),c.TgZ(23,"div",3),c.YNc(24,An,3,0,"button",4),c.YNc(25,qn,3,0,"button",4),c.qZA(),c.YNc(26,Tn,4,0,"div",5),c.YNc(27,Pn,6,1,"div",5),c.qZA(),c.qZA()),2&t){const t=c.MAs(1);c.Q6J("var",c.kEZ(22,In,c.DdM(19,Mn),c.DdM(20,Mn),c.DdM(21,Mn))),c.xp6(2),c.ekj("hidden",!n.ready),c.xp6(3),c.Q6J("ngIf",!t.identification.folded),c.xp6(1),c.Q6J("ngIf",t.identification.folded),c.xp6(1),c.Q6J("ngIf",t.identification.folded),c.xp6(1),c.Q6J("ngIf",!t.identification.folded),c.xp6(3),c.Q6J("ngIf",!t.products.folded),c.xp6(1),c.Q6J("ngIf",t.products.folded),c.xp6(5),c.Q6J("ngIf",!n.vm.pack.is_locked),c.xp6(2),c.hij("TOTAL TTC \xa0:\xa0 ",c.xi3(20,16,n.vm.price.value,"1.2-2")," \u20ac"),c.xp6(2),c.Q6J("ngIf",!t.products.folded),c.xp6(3),c.Q6J("ngIf",!t.accomodations.folded),c.xp6(1),c.Q6J("ngIf",t.accomodations.folded),c.xp6(1),c.Q6J("ngIf",t.accomodations.folded),c.xp6(1),c.Q6J("ngIf",!t.accomodations.folded)}},directives:[s.gC,y.O5,O.lW,A.Hw,Z.KE,Z.hX,b.Nt,x.Fj,x.JJ,x.oH,Z.bx,gt.wx,gt.zY,gt.By,gt.nW,Z.R9,gt._g,x.wV,Z.TO,C.ZL,C.XC,L.gD,x.On,i.ey,k.Rr,y.sg,pt.Wj,pt.Zt,pt.Bh,$t,tn],pipes:[y.JJ,y.Ov],styles:["[_nghost-%COMP%]{display:block;width:100%;height:100%;padding-top:10px}[_nghost-%COMP%]   .hidden[_ngcontent-%COMP%]{visibility:hidden}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]{display:flex}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-toggle[_ngcontent-%COMP%]{flex:0 1;display:inline-block;vertical-align:top;padding:5px 0 0 20px}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]{flex:1;display:inline-block;width:100%;min-height:45px}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]{width:100%;display:flex;padding:5px 0;flex:1}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .row-products-title[_ngcontent-%COMP%]{flex:0 1 50%;height:40px;line-height:40px}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .row-products-price[_ngcontent-%COMP%]{flex:0 1 20%;margin-left:auto;text-align:right;margin-right:65px}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .cell[_ngcontent-%COMP%]{flex:1}[_nghost-%COMP%]   mat-form-field[_ngcontent-%COMP%]{width:100%;padding:0 12px}[_nghost-%COMP%]   mat-form-field.header[_ngcontent-%COMP%]{margin-top:-5px}[_nghost-%COMP%]   mat-form-field.header[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{font-size:22px}[_nghost-%COMP%]   mat-form-field.invisible[_ngcontent-%COMP%]    .mat-form-field-underline{display:none!important}[_nghost-%COMP%]   p[_ngcontent-%COMP%]{font-size:14px;padding:0 12px}[_nghost-%COMP%]   .products-header[_ngcontent-%COMP%]{padding:0 12px 0 0;width:100%;margin-bottom:1px}[_nghost-%COMP%]   .products-header[_ngcontent-%COMP%]   .product-cell[_ngcontent-%COMP%]{font-weight:600;outline:1px solid #0003;line-height:34px;position:relative;flex:1 0 8%;text-align:right;padding:0 10px;margin-right:15px;white-space:nowrap;text-overflow:ellipsis;overflow:hidden}[_nghost-%COMP%]   .products-header[_ngcontent-%COMP%]   .product-cell[_ngcontent-%COMP%]:last-child{outline:none}[_nghost-%COMP%]   .products-header[_ngcontent-%COMP%]   .product-cell[_ngcontent-%COMP%]:first-child{flex:1 0 40%}[_nghost-%COMP%]   .products-list[_ngcontent-%COMP%]{position:relative;padding:0 12px 0 0;width:100%}[_nghost-%COMP%]   .products-list[_ngcontent-%COMP%]   .product-item[_ngcontent-%COMP%]{position:relative;background-color:#fff}[_nghost-%COMP%]   .products-list[_ngcontent-%COMP%]   .product-item[_ngcontent-%COMP%]   .product-handle[_ngcontent-%COMP%]{position:absolute;top:10px;left:5px;z-index:3}[_nghost-%COMP%]   .products-list[_ngcontent-%COMP%]   .product-item[_ngcontent-%COMP%]   .product-remove[_ngcontent-%COMP%]{position:absolute;right:-5px;top:10px;z-index:2}.cdk-drag-preview[_ngcontent-%COMP%]{box-sizing:border-box;border-radius:4px;box-shadow:0 5px 5px -3px #0003,0 8px 10px 1px #00000024,0 3px 14px 2px #0000001f;background-color:#d3d3d3!important}.cdk-drag-preview[_ngcontent-%COMP%]   .product-handle[_ngcontent-%COMP%], .cdk-drag-preview[_ngcontent-%COMP%]   .product-remove[_ngcontent-%COMP%]{display:none}.cdk-drag-placeholder[_ngcontent-%COMP%]{opacity:0}"]}),t})();function Jn(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"div",10),c.TgZ(1,"div",11),c.TgZ(2,"mat-icon",12),c._uU(3,"drag_indicator"),c.qZA(),c.qZA(),c.TgZ(4,"div",13),c.TgZ(5,"button",14),c.NdJ("click",function(){const n=c.CHM(t).$implicit;return c.oxw(2).vm.groups.remove(n)}),c.TgZ(6,"mat-icon"),c._uU(7,"delete"),c.qZA(),c.qZA(),c.qZA(),c._UZ(8,"booking-edit-bookings-group",15),c.qZA()}if(2&t){const t=n.$implicit,e=n.index,i=c.oxw(2);c.Q6J("cdkDragData",t),c.xp6(8),c.Q6J("bookingInput",i.booking)("groupInput",i._groupOutput[e])("groupOutput",i._groupInput)}}function Nn(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"div",7),c.TgZ(1,"div",8),c.NdJ("cdkDropListDropped",function(n){return c.CHM(t),c.oxw().vm.groups.drop(n)}),c.YNc(2,Jn,9,4,"div",9),c.qZA(),c.qZA()}if(2&t){const t=c.oxw();c.xp6(2),c.Q6J("ngForOf",t.groups)}}let Qn=(()=>{class t{constructor(t,n,e,i){this.api=t,this.auth=n,this.zone=e,this.snack=i,this._groupInput=new l.t(1),this._groupOutput=[],this.model_fields={BookingLineGroup:["id","booking_id","name","order","has_pack","pack_id","price","is_locked","date_from","date_to","sojourn_type","nb_pers","rate_class_id","booking_lines_ids","accomodations_ids"]},this.booking={},this.center=null,this.groups=[],this.vm={price:{value:0},groups:{add:()=>this.groupAdd(),remove:t=>this.groupRemove(t),drop:t=>this.groupDrop(t)}}}ngOnInit(){this.bookingInput.subscribe(t=>(0,u.mG)(this,void 0,void 0,function*(){return this.load(t)})),this._groupInput.subscribe(t=>this.updateFromGroup(t))}load(t){return(0,u.mG)(this,void 0,void 0,function*(){this.zone.run(()=>(0,u.mG)(this,void 0,void 0,function*(){try{console.log("BookingEditBookingsComponent: received changes from parent",t);for(let n of Object.keys(t))this.booking[n]=t[n];if(t.hasOwnProperty("price")&&(this.vm.price.value=t.price),t.booking_lines_groups_ids&&t.booking_lines_groups_ids.length){let n=yield this.loadGroups(t.booking_lines_groups_ids,this.model_fields.BookingLineGroup);if(n){for(let[t,e]of n.entries())if(t>=this.groups.length){let t=new l.t(1);this._groupOutput.push(t),t.next(e),this.groups.push(e)}else if(JSON.stringify(this.groups[t])!=JSON.stringify(e)){let n=new l.t(1);this._groupOutput[t]=n,this.groups[t]=e,n.next(e)}this.groups.length>n.length&&(this.groups.splice(n.length),this._groupOutput.splice(n.length))}}if(t.center_id){let n=yield this.api.read("lodging\\identity\\Center",[t.center_id],["id","name","code","organisation_id"]);n&&n.length&&(this.center=n[0])}}catch(n){console.warn(n)}}))})}loadGroups(t,n){return(0,u.mG)(this,void 0,void 0,function*(){return yield this.api.read("lodging\\sale\\booking\\BookingLineGroup",t,n,"order")})}groupAdd(){return(0,u.mG)(this,void 0,void 0,function*(){console.log("group add");try{const t=yield this.api.create("lodging\\sale\\booking\\BookingLineGroup",{name:"S\xe9jour "+this.center.name,order:this.groups.length+1,booking_id:this.booking.id,rate_class_id:4});let n=yield this.loadGroups([t.id],this.model_fields.BookingLineGroup),e=new l.t(1);this._groupOutput.push(e),this.groups.push(n[0]),e.next(n[0])}catch(t){console.log(t)}})}groupRemove(t){return(0,u.mG)(this,void 0,void 0,function*(){try{yield this.api.remove("lodging\\sale\\booking\\BookingLineGroup",[t.id],!0);let n=this.groups.findIndex(n=>n.id==t.id);this.groups.splice(n,1),this._groupOutput.splice(n,1)}catch(n){console.warn(n)}})}groupDrop(t){console.log(t.previousIndex,t.currentIndex),(0,pt.bA)(this.groups,t.previousIndex,t.currentIndex),(0,pt.bA)(this._groupOutput,t.previousIndex,t.currentIndex);for(let n in this.groups)this.updateFromGroup({id:this.groups[n].id,order:parseInt(n)+1})}updateFromGroup(t){return(0,u.mG)(this,void 0,void 0,function*(){console.log("BookingEditBookingsComponent: received changes from child",t);try{let n=this.groups.findIndex(n=>n.id==t.id),e=this.groups.find(n=>n.id==t.id),i=!1,o=[];if(t.hasOwnProperty("name")&&t.name!=e.name&&(yield this.updateName(t),i=!0),t.hasOwnProperty("pack_id")&&t.pack_id!=e.pack_id&&(yield this.updatePack(t),o.push("price"),i=!0),t.hasOwnProperty("rate_class_id")&&t.rate_class_id!=e.rate_class_id&&(yield this.updateRateClass(t),i=!0),t.hasOwnProperty("is_locked")&&t.is_locked!=e.is_locked&&(yield this.updateIsLocked(t),o.push("price"),i=!0),t.hasOwnProperty("has_pack")&&t.has_pack!=e.has_pack&&(yield this.updateHasPack(t),i=!0),(t.hasOwnProperty("date_from")&&t.date_from!=e.date_from||t.hasOwnProperty("date_to")&&t.date_to!=e.date_to)&&(yield this.updateDate(t),i=!0),t.hasOwnProperty("nb_pers")&&t.nb_pers!=e.nb_pers&&(yield this.updateNbPers(t),i=!0),t.hasOwnProperty("order")&&t.order!=e.order&&(yield this.updateOrder(t),i=!0),t.hasOwnProperty("booking_lines_ids")&&t.booking_lines_ids.filter(t=>-1===e.booking_lines_ids.indexOf(t)).length&&(yield this.updateBookingLinesIds(t),i=!0),t.hasOwnProperty("refresh")){let e=this.model_fields.BookingLineGroup;if(t.refresh.hasOwnProperty("self")){Array.isArray(t.refresh.self)&&(e=t.refresh.self);let i=yield this.loadGroups([t.id],e);this._groupOutput[n].next(i[0])}t.refresh.hasOwnProperty("booking_id")&&(o=[...o,...t.refresh.booking_id])}else if(i){let e=(yield this.loadGroups([t.id],this.model_fields.BookingLineGroup))[0];for(let t of Object.keys(e))this.groups[n][t]=e[t];this._groupOutput[n].next(this.groups[n]),this.snack.open("Regroupement mis \xe0 jour")}o.length&&this.bookingOutput.next({id:this.booking.id,refresh:o})}catch(n){console.warn("some changes could not be stored",n);let t="unknonw";if(n&&n.hasOwnProperty("error")&&n.error.hasOwnProperty("errors")){let e=n.error.errors;e.hasOwnProperty("INVALID_PARAM")?t="invalid_param":e.hasOwnProperty("NOT_ALLOWED")?t="not_allowed":e.hasOwnProperty("CONFLICT_OBJECT")&&(t="conflict_object")}switch(t){case"not_allowed":this.snack.open("Erreur - Vous n'avez pas les autorisations pour cette op\xe9ration.");break;case"conflict_object":this.snack.open("Erreur - Cette r\xe9servation a \xe9t\xe9 modifi\xe9e par un autre utilisateur.");break;case"unknonw":case"invalid_param":default:this.snack.open("Erreur - certains changements n'ont pas pu \xeatre enregistr\xe9s.")}}})}updateName(t){return(0,u.mG)(this,void 0,void 0,function*(){console.log("BookingEditBookingsComponent::updateName",t),yield this.api.update("lodging\\sale\\booking\\BookingLineGroup",[t.id],{name:t.name})})}updatePack(t){return(0,u.mG)(this,void 0,void 0,function*(){console.log("BookingEditBookingsComponent::updatePack",t),yield this.api.update("lodging\\sale\\booking\\BookingLineGroup",[t.id],{pack_id:t.pack_id})})}updateRateClass(t){return(0,u.mG)(this,void 0,void 0,function*(){console.log("BookingEditBookingsComponent::updateRateClass",t),yield this.api.update("lodging\\sale\\booking\\BookingLineGroup",[t.id],{rate_class_id:t.rate_class_id})})}updateHasPack(t){return(0,u.mG)(this,void 0,void 0,function*(){console.log("BookingEditBookingsComponent::updateHasPack",t),yield this.api.update("lodging\\sale\\booking\\BookingLineGroup",[t.id],{has_pack:t.has_pack})})}updateNbPers(t){return(0,u.mG)(this,void 0,void 0,function*(){console.log("BookingEditBookingsComponent::updateNbPers",t),yield this.api.update("lodging\\sale\\booking\\BookingLineGroup",[t.id],{nb_pers:t.nb_pers})})}updateOrder(t){return(0,u.mG)(this,void 0,void 0,function*(){console.log("BookingEditBookingsComponent::updateOrder",t),yield this.api.update("lodging\\sale\\booking\\BookingLineGroup",[t.id],{order:t.order})})}updateIsLocked(t){return(0,u.mG)(this,void 0,void 0,function*(){console.log("BookingEditBookingsComponent::updateIsLocked",t),yield this.api.update("lodging\\sale\\booking\\BookingLineGroup",[t.id],{is_locked:t.is_locked})})}updateDate(t){return(0,u.mG)(this,void 0,void 0,function*(){console.log("BookingEditBookingsComponent::updateDate",t),t.date_from&&t.date_to?yield this.api.update("lodging\\sale\\booking\\BookingLineGroup",[t.id],{date_from:t.date_from,date_to:t.date_to}):t.date_from?yield this.api.update("lodging\\sale\\booking\\BookingLineGroup",[t.id],{date_from:t.date_from}):yield this.api.update("lodging\\sale\\booking\\BookingLineGroup",[t.id],{date_to:t.date_to})})}updateBookingLinesIds(t){return(0,u.mG)(this,void 0,void 0,function*(){yield this.api.update("lodging\\sale\\booking\\BookingLineGroup",[t.id],{booking_lines_ids:t.booking_lines_ids})})}}return t.\u0275fac=function(n){return new(n||t)(c.Y36(s.sM),c.Y36(s.Tq),c.Y36(c.R0b),c.Y36(g.ux))},t.\u0275cmp=c.Xpm({type:t,selectors:[["booking-edit-bookings"]],inputs:{bookingInput:"bookingInput",bookingOutput:"bookingOutput"},decls:12,vars:5,consts:[[1,"container"],[1,"outer-wrapper",2,"width","100%"],[1,"header",2,"display","flex","width","100%"],[2,"flex","1"],["mat-mini-fab","","color","primary",2,"transform","scale(0.65)",3,"click"],[2,"margin-left","auto","font-size","20px"],["class","inner-wrapper",4,"ngIf"],[1,"inner-wrapper"],["cdkDropList","",1,"groups-list",3,"cdkDropListDropped"],["class","group-item","cdkDrag","",3,"cdkDragData",4,"ngFor","ngForOf"],["cdkDrag","",1,"group-item",3,"cdkDragData"],["cdkDragHandle","",1,"group-handle"],[2,"font-size","16px"],[1,"group-remove"],["mat-icon-button","",3,"click"],[3,"bookingInput","groupInput","groupOutput"]],template:function(t,n){1&t&&(c.TgZ(0,"div",0),c.TgZ(1,"div",1),c.TgZ(2,"div",2),c.TgZ(3,"div",3),c._uU(4,"Ajouter un s\xe9jour "),c.TgZ(5,"button",4),c.NdJ("click",function(){return n.vm.groups.add()}),c.TgZ(6,"mat-icon"),c._uU(7,"add"),c.qZA(),c.qZA(),c.qZA(),c.TgZ(8,"div",5),c._uU(9),c.ALo(10,"number"),c.qZA(),c.qZA(),c.YNc(11,Nn,3,1,"div",6),c.qZA(),c.qZA()),2&t&&(c.xp6(9),c.hij("Total TTC ",c.xi3(10,2,n.vm.price.value,"1.2-2")," \u20ac"),c.xp6(2),c.Q6J("ngIf",n.groups.length))},directives:[O.lW,A.Hw,y.O5,pt.Wj,y.sg,pt.Zt,pt.Bh,Un],pipes:[y.JJ],styles:["[_nghost-%COMP%]{width:100%;height:100%}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]{display:flex;height:100%;width:100%}[_nghost-%COMP%]   .inner-wrapper[_ngcontent-%COMP%]{border:1px solid #d3d3d3}[_nghost-%COMP%]   .group-item[_ngcontent-%COMP%]{position:relative;margin:12px;padding-bottom:12px;background-color:#0000000a}[_nghost-%COMP%]   .group-item[_ngcontent-%COMP%]   .group-handle[_ngcontent-%COMP%]{position:absolute;top:10px;left:5px;z-index:3}[_nghost-%COMP%]   .group-item[_ngcontent-%COMP%]   .group-remove[_ngcontent-%COMP%]{position:absolute;right:10px;top:10px}.cdk-drag-preview[_ngcontent-%COMP%]{box-sizing:border-box;border-radius:4px;box-shadow:0 5px 5px -3px #0003,0 8px 10px 1px #00000024,0 3px 14px 2px #0000001f;background-color:#d3d3d3!important}.cdk-drag-preview[_ngcontent-%COMP%]   .group-handle[_ngcontent-%COMP%], .cdk-drag-preview[_ngcontent-%COMP%]   .group-remove[_ngcontent-%COMP%]{display:none}.cdk-drag-placeholder[_ngcontent-%COMP%]{opacity:0}"]}),t})();function Yn(t,n){1&t&&c._uU(0,"Client")}function Dn(t,n){1&t&&c._uU(0,"R\xe9servation")}function Gn(t,n){1&t&&c._uU(0,"S\xe9jours")}class Ln{constructor(t=0,n="",e=new Date,i=0,o="",a=0,s=!1,r=0,c=0,d=0,u="",l=[],p=[]){this.id=t,this.name=n,this.created=e,this.price=i,this.status=o,this.customer_id=a,this.has_payer_organisation=s,this.payer_organisation_id=r,this.center_id=c,this.type_id=d,this.description=u,this.contacts_ids=l,this.booking_lines_groups_ids=p}}let Fn=(()=>{class t{constructor(t,n,e,i,o,a,s){this.auth=t,this.api=n,this.router=e,this.dialog=i,this.route=o,this.snack=a,this.zone=s,this.booking=new Ln,this.id=0,this._bookingInput=new l.t(1),this._bookingOutput=new l.t(1),this.showSbContainer=!1}ngAfterViewInit(){$("#sb-booking-container").on("_close",(t,n)=>{this.zone.run(()=>{this.showSbContainer=!1})}),$("#sb-booking-container").on("_open",(t,n)=>{this.zone.run(()=>{this.showSbContainer=!0})})}ngOnInit(){this._bookingInput.subscribe(t=>this.update(t)),this.route.params.subscribe(t=>(0,u.mG)(this,void 0,void 0,function*(){if(t&&t.hasOwnProperty("id")){this.id=t.id;try{let t=yield this.load(Object.getOwnPropertyNames(new Ln));this.booking=new Ln(t.id,t.name,new Date(t.created),t.price,t.status,t.customer_id,t.has_payer_organisation,t.payer_organisation_id,t.center_id,t.type_id,t.description,t.contacts_ids,t.booking_lines_groups_ids),this._bookingOutput.next(this.booking)}catch(n){console.warn(n)}}}))}load(t){return(0,u.mG)(this,void 0,void 0,function*(){const n=yield this.api.read("lodging\\sale\\booking\\Booking",[this.id],t);return n&&n.length?n[0]:{}})}update(t){return(0,u.mG)(this,void 0,void 0,function*(){console.log("BookingEditComponent: received change",t,this.booking);try{if(t.hasOwnProperty("refresh")){let n=Object.getOwnPropertyNames(new Ln);Array.isArray(t.refresh)&&(n=t.refresh);let e=yield this.load(n);return this.booking=new Ln(e.id,e.name,new Date(e.created),e.price,e.customer_id,e.has_payer_organisation,e.payer_organisation_id,e.center_id,e.type_id,e.description,e.contacts_ids,e.booking_lines_groups_ids),void this._bookingOutput.next(e)}let n=!1;if(t.hasOwnProperty("customer_id")&&t.customer_id!=this.booking.customer_id&&(yield this.updateCustomer(t.customer_id),n=!0),(t.hasOwnProperty("payer_organisation_id")&&t.payer_organisation_id!=this.booking.payer_organisation_id||t.hasOwnProperty("has_payer_organisation")&&t.has_payer_organisation!=this.booking.has_payer_organisation)&&(yield this.updatePayer(t.payer_organisation_id),n=!0),t.hasOwnProperty("center_id")&&t.center_id!=this.booking.center_id&&(yield this.updateCenter(t.center_id),n=!0),t.hasOwnProperty("type_id")&&t.type_id!=this.booking.type_id&&(yield this.updateType(t.type_id),n=!0),t.hasOwnProperty("description")&&t.description!=this.booking.description&&(yield this.updateDescription(t.description),n=!0),t.hasOwnProperty("contacts_ids")&&t.contacts_ids.length!=this.booking.contacts_ids.length&&(this.booking.contacts_ids=t.contacts_ids,n=!0),t.hasOwnProperty("booking_lines_groups_ids")&&t.booking_lines_groups_ids.length!=this.booking.booking_lines_groups_ids.length&&(this.booking.booking_lines_groups_ids=t.booking_lines_groups_ids,n=!0),n){let t=yield this.load(Object.getOwnPropertyNames(new Ln));for(let n of Object.keys(t))this.booking[n]=t[n];this._bookingOutput.next(this.booking),this.snack.open("R\xe9servation mise \xe0 jour")}}catch(n){console.warn("some changes could not be stored",n);let t="unknonw";if(n&&n.hasOwnProperty("error")&&n.error.hasOwnProperty("errors")){let e=n.error.errors;e.hasOwnProperty("INVALID_PARAM")?t="invalid_param":e.hasOwnProperty("NOT_ALLOWED")?t="not_allowed":e.hasOwnProperty("CONFLICT_OBJECT")&&(t="conflict_object")}switch(t){case"not_allowed":this.snack.open("Erreur - Vous n'avez pas les autorisations pour cette op\xe9ration.");break;case"conflict_object":this.snack.open("Erreur - Cette r\xe9servation a \xe9t\xe9 modifi\xe9e par un autre utilisateur.");break;case"unknonw":case"invalid_param":default:this.snack.open("Erreur - certains changements n'ont pas pu \xeatre enregistr\xe9s.")}}})}updateCustomer(t){return(0,u.mG)(this,void 0,void 0,function*(){console.log("BookingEditComponent::updateCustomer",t),yield this.api.update("lodging\\sale\\booking\\Booking",[this.id],{customer_id:t})})}updateDescription(t){return(0,u.mG)(this,void 0,void 0,function*(){console.log("BookingEditComponent::updateDescription",t),yield this.api.update("lodging\\sale\\booking\\Booking",[this.id],{description:t})})}updatePayer(t){return(0,u.mG)(this,void 0,void 0,function*(){console.log("BookingEditComponent::updatePayer",t);let n={};t<=0?(n.has_payer_organisation=!1,n.payer_organisation_id=0):(n.has_payer_organisation=!0,n.payer_organisation_id=t),yield this.api.update("lodging\\sale\\booking\\Booking",[this.id],n)})}updateCenter(t){return(0,u.mG)(this,void 0,void 0,function*(){console.log("BookingEditComponent::updateCenter",t),yield this.api.update("lodging\\sale\\booking\\Booking",[this.id],{center_id:t})})}updateType(t){return(0,u.mG)(this,void 0,void 0,function*(){console.log("BookingEditComponent::updateType",t),yield this.api.update("lodging\\sale\\booking\\Booking",[this.id],{type_id:t})})}}return t.\u0275fac=function(n){return new(n||t)(c.Y36(s.Tq),c.Y36(s.sM),c.Y36(r.F0),c.Y36(p.uw),c.Y36(r.gz),c.Y36(g.ux),c.Y36(c.R0b))},t.\u0275cmp=c.Xpm({type:t,selectors:[["booking-edit"]],decls:25,vars:9,consts:[[1,"container"],[1,"booking-header"],[1,"booking-body"],[2,"height","46px","margin-top","10px","display","flex"],[2,"flex","0 1 50%"],[2,"margin-left","auto"],[2,"line-height","40px"],["mat-tab-label",""],[1,"step-container"],[3,"bookingInput","bookingOutput"],["id","sb-booking-container",1,"sb-container"]],template:function(t,n){1&t&&(c.TgZ(0,"div",0),c.TgZ(1,"div",1),c._uU(2,"Nouvelle r\xe9servation"),c.qZA(),c.TgZ(3,"div",2),c.TgZ(4,"div",3),c._UZ(5,"div",4),c.TgZ(6,"div",5),c.TgZ(7,"span",6),c._uU(8,"Statut de la r\xe9servation: "),c.TgZ(9,"strong"),c._uU(10),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.TgZ(11,"mat-tab-group"),c.TgZ(12,"mat-tab"),c.YNc(13,Yn,1,0,"ng-template",7),c.TgZ(14,"div",8),c._UZ(15,"booking-edit-customer",9),c.qZA(),c.qZA(),c.TgZ(16,"mat-tab"),c.YNc(17,Dn,1,0,"ng-template",7),c.TgZ(18,"div",8),c._UZ(19,"booking-edit-sojourn",9),c.qZA(),c.qZA(),c.TgZ(20,"mat-tab"),c.YNc(21,Gn,1,0,"ng-template",7),c.TgZ(22,"div",8),c._UZ(23,"booking-edit-bookings",9),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c._UZ(24,"div",10)),2&t&&(c.ekj("hidden",n.showSbContainer),c.xp6(10),c.Oqu(n.booking.status),c.xp6(5),c.Q6J("bookingInput",n._bookingOutput)("bookingOutput",n._bookingInput),c.xp6(4),c.Q6J("bookingInput",n._bookingOutput)("bookingOutput",n._bookingInput),c.xp6(4),c.Q6J("bookingInput",n._bookingOutput)("bookingOutput",n._bookingInput))},directives:[m.SP,m.uX,m.uD,Q,ut,Qn],styles:["[_nghost-%COMP%]{width:100%;height:100%;overflow:hidden;box-sizing:border-box}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]{height:100%;width:100%}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]   .booking-header[_ngcontent-%COMP%]{width:100%;padding-left:12px;height:48px;line-height:48px;border-bottom:1px solid #d3d3d3;font-size:22px}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]   .booking-body[_ngcontent-%COMP%]{height:calc(100vh - 123px);width:100%;overflow-y:scroll;padding:0 12px}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]   .booking-body[_ngcontent-%COMP%]     mat-tab-group .mat-tab-header{margin-bottom:20px}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]   .booking-body[_ngcontent-%COMP%]::-webkit-scrollbar{width:6px;overflow-y:scroll;background:#0000}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]   .booking-body[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:var(--mdc-theme-primary,#6200ee);border-radius:10px}[_nghost-%COMP%]   .container.hidden[_ngcontent-%COMP%]{display:none}"]}),t})();var Bn=e(4885);function En(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",9),c.NdJ("click",function(){c.CHM(t);const n=c.oxw().index;c.oxw();const e=c.MAs(1);return e.items[n]=!e.items[n]}),c.TgZ(1,"mat-icon",18),c._uU(2,"keyboard_arrow_right"),c.qZA(),c.qZA()}}function Rn(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",9),c.NdJ("click",function(){c.CHM(t);const n=c.oxw().index;c.oxw();const e=c.MAs(1);return e.items[n]=!e.items[n]}),c.TgZ(1,"mat-icon",18),c._uU(2,"keyboard_arrow_up"),c.qZA(),c.qZA()}}function jn(t,n){1&t&&(c.TgZ(0,"div"),c._uU(1,"Voir le listing"),c.qZA())}function Hn(t,n){if(1&t&&(c.TgZ(0,"div",27),c.TgZ(1,"div",28),c._uU(2),c.qZA(),c.qZA()),2&t){const t=c.oxw(4);c.xp6(2),c.Oqu(t.selection.length>0?t.selection.length:1)}}function zn(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"div",23),c.NdJ("click",function(n){const e=c.CHM(t).$implicit;return c.oxw(3).onToggle(n,e)})("cdkDragStarted",function(n){return c.CHM(t),c.oxw(3).onDragStart(n)}),c.YNc(1,Hn,3,1,"div",24),c.TgZ(2,"div",25),c._uU(3),c.qZA(),c.TgZ(4,"div",25),c._uU(5),c.qZA(),c.TgZ(6,"div",25),c._uU(7),c.qZA(),c.TgZ(8,"div",25),c._uU(9),c.qZA(),c.TgZ(10,"div",26),c.TgZ(11,"button",9),c.NdJ("click",function(){const n=c.CHM(t).$implicit;return c.oxw(3).onOpenCompositionItem(n.id)}),c.TgZ(12,"mat-icon"),c._uU(13,"open_in_new"),c.qZA(),c.qZA(),c.qZA(),c.qZA()}if(2&t){const t=n.$implicit,e=n.index,i=c.oxw(3);c.ekj("selected",t.selected)("dragging",i.dragging),c.Q6J("cdkDragDisabled",!t.selected),c.xp6(3),c.hij("",e+1,"."),c.xp6(2),c.Oqu(t.firstname),c.xp6(2),c.Oqu(t.lastname),c.xp6(2),c.Oqu(t.gender)}}function Sn(t,n){if(1&t&&(c.TgZ(0,"div",19),c.TgZ(1,"div",20),c.TgZ(2,"div",21),c._uU(3,"#"),c.qZA(),c.TgZ(4,"div",21),c._uU(5,"Nom"),c.qZA(),c.TgZ(6,"div",21),c._uU(7,"Pr\xe9nom"),c.qZA(),c.TgZ(8,"div",21),c._uU(9,"Genre"),c.qZA(),c._UZ(10,"div",21),c.qZA(),c.YNc(11,zn,14,9,"div",22),c.qZA()),2&t){const t=c.oxw().$implicit,n=c.oxw();c.xp6(11),c.Q6J("ngForOf",n.composition_items[t.id])}}function $n(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"tr"),c.TgZ(1,"td"),c.TgZ(2,"div",6),c.TgZ(3,"div",7),c._uU(4),c.qZA(),c.TgZ(5,"div",8),c.TgZ(6,"button",9),c.NdJ("click",function(){const n=c.CHM(t).$implicit;return c.oxw().onOpenRentalUnit(n.id)}),c.TgZ(7,"mat-icon"),c._uU(8,"open_in_new"),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.TgZ(9,"td",10),c.TgZ(10,"div",11),c._uU(11),c.qZA(),c.qZA(),c.TgZ(12,"td"),c.TgZ(13,"div",12),c.TgZ(14,"div",13),c.YNc(15,En,3,0,"button",14),c.YNc(16,Rn,3,0,"button",14),c.qZA(),c.TgZ(17,"div",15),c.NdJ("cdkDropListDropped",function(n){return c.CHM(t),c.oxw().onDrop(n)}),c.YNc(18,jn,2,0,"div",16),c.YNc(19,Sn,12,1,"div",17),c.qZA(),c.qZA(),c.qZA(),c.qZA()}if(2&t){const t=n.$implicit,e=n.index,i=c.oxw(),o=c.MAs(1);c.xp6(4),c.lnq("",t.name,", ",t.code," (",t.capacity,")"),c.xp6(7),c.Oqu(i.composition_items[t.id].length),c.xp6(4),c.Q6J("ngIf",!o.items[e]),c.xp6(1),c.Q6J("ngIf",o.items[e]),c.xp6(1),c.s9C("id",t.id),c.Q6J("cdkDropListData",t.id),c.xp6(1),c.Q6J("ngIf",!o.items[e]),c.xp6(1),c.Q6J("ngIf",o.items[e])}}const Wn=function(){return[]},Xn=function(t){return{items:t}};class Vn{constructor(t=0,n=0){this.id=t,this.booking_id=n}}class Kn{constructor(t=0,n="",e="",i="",o="",a="",s="",r="",c="",d="",u=""){this.id=t,this.firstname=n,this.lastname=e,this.gender=i,this.date_of_birth=o,this.place_of_birth=a,this.email=s,this.phone=r,this.address=c,this.country=d,this.rental_unit_id=u}}class te{constructor(t=0,n="",e="",i=0){this.id=t,this.name=n,this.code=e,this.capacity=i}}let ne=(()=>{class t{constructor(t,n,e,i,o){this.api=t,this.cd=n,this.context=e,this.zone=i,this.snack=o,this.composition=new Vn,this.composition_items={},this.rental_units=[],this.selection=[],this.dragging=!1}ngOnInit(){}ngOnChanges(t){return(0,u.mG)(this,void 0,void 0,function*(){if(t.composition_id)try{const t=yield this.api.read("sale\\booking\\Composition",[this.composition_id],Object.getOwnPropertyNames(new Vn));if(t.length){this.composition=t[0];{const t=yield this.load(Object.getOwnPropertyNames(new Kn));for(let n of t)this.composition_items.hasOwnProperty(n.rental_unit_id)||(this.composition_items[n.rental_unit_id]=[]),this.composition_items[n.rental_unit_id].push(n)}console.log(this.composition_items);{const t=yield this.api.read("lodging\\realestate\\RentalUnit",Object.keys(this.composition_items),Object.getOwnPropertyNames(new te));this.rental_units=t}console.log(this.rental_units)}}catch(n){console.warn(n),this.snack.open("unknonw error")}})}onToggle(t,n){console.log("selecting",t,n),n.hasOwnProperty("selected")||(n.selected=!1);let e=n.rental_unit_id;if(n.selected)n.selected=!1;else{for(let t of Object.keys(this.composition_items))if(t!=e)for(let n in this.composition_items[t])this.composition_items[t][n].selected=!1;n.selected=!0}this.selection=this.composition_items[e].filter(t=>t.selected),console.log(this.selection)}onDragStart(t){this.dragging=!0}onDrop(t){if(t.previousContainer!=t.container){console.log("from",t.previousContainer.data,"to",t.container.data);let n=t.currentIndex,e=t.container.data,i=t.previousContainer.data;for(let t of this.selection){let o=this.composition_items[i].findIndex(n=>n.id==t.id);(0,pt.EA)(this.composition_items[i],this.composition_items[e],o,n),++n,t.rental_unit_id=e,t.selected=!1}this.selection=[]}this.dragging=!1,console.log("dropped",t)}onOpenRentalUnit(t){this.context.change({context:{entity:"lodging\\realestate\\RentalUnit",type:"form",name:"default",domain:["id","=",t],mode:"view",purpose:"view",target:"#sb-composition-container",callback:t=>{}}})}onOpenCompositionItem(t){this.context.change({context:{entity:"sale\\booking\\CompositionItem",type:"form",name:"default",domain:["id","=",t],mode:"edit",purpose:"view",target:"#sb-composition-container",callback:t=>{}}})}load(t){return(0,u.mG)(this,void 0,void 0,function*(){return yield this.api.collect("sale\\booking\\CompositionItem",["composition_id","=",this.composition.id],t,"id","asc",0,500)})}}return t.\u0275fac=function(n){return new(n||t)(c.Y36(s.sM),c.Y36(c.sBO),c.Y36(s.Ob),c.Y36(c.R0b),c.Y36(g.ux))},t.\u0275cmp=c.Xpm({type:t,selectors:[["booking-composition-lines"]],inputs:{composition_id:"composition_id"},features:[c.TTD],decls:11,vars:5,consts:[[3,"var"],["vUnit","var"],[2,"width","25%"],["colspan","2"],["cdkDropListGroup",""],[4,"ngFor","ngForOf"],[2,"display","flex"],[1,"cell",2,"flex","0 1 66%"],[1,"cell",2,"margin-left","auto"],["mat-icon-button","",3,"click"],[2,"width","8%","text-align","center"],[1,"cell"],[1,"part"],[1,"part-toggle"],["mat-icon-button","",3,"click",4,"ngIf"],["cdkDropList","",1,"part-container",3,"id","cdkDropListData","cdkDropListDropped"],[4,"ngIf"],["class","composition-container",4,"ngIf"],[2,"font-size","15px"],[1,"composition-container"],[1,"composition-container-header"],[1,"composition-container-column","header"],["cdkDrag","","class","composition-container-item",3,"selected","dragging","cdkDragDisabled","click","cdkDragStarted",4,"ngFor","ngForOf"],["cdkDrag","",1,"composition-container-item",3,"cdkDragDisabled","click","cdkDragStarted"],["class","drag-preview",4,"cdkDragPreview"],[1,"composition-container-column"],[1,"composition-container-column",2,"text-align","right"],[1,"drag-preview"],[1,"drag-preview-inner"]],template:function(t,n){1&t&&(c._UZ(0,"div",0,1),c.TgZ(2,"table"),c.TgZ(3,"thead"),c.TgZ(4,"tr"),c.TgZ(5,"th",2),c._uU(6,"Unit\xe9 locative"),c.qZA(),c.TgZ(7,"th",3),c._uU(8,"occupation"),c.qZA(),c.qZA(),c.qZA(),c.TgZ(9,"tbody",4),c.YNc(10,$n,20,10,"tr",5),c.qZA(),c.qZA()),2&t&&(c.Q6J("var",c.VKq(3,Xn,c.DdM(2,Wn))),c.xp6(10),c.Q6J("ngForOf",n.rental_units))},directives:[s.gC,pt.Fd,y.sg,O.lW,A.Hw,y.O5,pt.Wj,pt.Zt,pt.pV],styles:["[_nghost-%COMP%]{width:100%;height:100%;overflow:hidden;box-sizing:border-box}[_nghost-%COMP%]   .composition-container[_ngcontent-%COMP%]{border:1px solid #ccc;min-height:60px;background:#fff;border-radius:4px;overflow:hidden;display:block}[_nghost-%COMP%]   .composition-container[_ngcontent-%COMP%]   .composition-container-header[_ngcontent-%COMP%]{display:flex;padding:12px}[_nghost-%COMP%]   .composition-container[_ngcontent-%COMP%]   .composition-container-column[_ngcontent-%COMP%]{flex:1}[_nghost-%COMP%]   .composition-container[_ngcontent-%COMP%]   .composition-container-column.header[_ngcontent-%COMP%]{font-weight:500}[_nghost-%COMP%]   .composition-container[_ngcontent-%COMP%]   .composition-container-item[_ngcontent-%COMP%]{display:flex;padding:5px 10px;border-bottom:1px solid #ccc;color:#000000de;flex-direction:row;align-items:center;justify-content:space-between;box-sizing:border-box;cursor:move;background:#fff;font-size:14px}[_nghost-%COMP%]   .composition-container[_ngcontent-%COMP%]   .composition-container-item[_ngcontent-%COMP%]:last-child{border:none}[_nghost-%COMP%]   .composition-container[_ngcontent-%COMP%]   .composition-container-item.selected[_ngcontent-%COMP%]{background-color:#f5f5ff}[_nghost-%COMP%]   .composition-container[_ngcontent-%COMP%]   .composition-container-item.selected.dragging[_ngcontent-%COMP%]{opacity:.5}[_nghost-%COMP%]   table[_ngcontent-%COMP%]{border-spacing:0;width:100%;border:1px solid #e0e0e0}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{min-width:30px;width:30px}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:first-child, [_nghost-%COMP%]   table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]:first-child{padding-left:2px}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:last-child, [_nghost-%COMP%]   table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]:last-child{padding-right:2px}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]{height:45px}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   td[_ngcontent-%COMP%], [_nghost-%COMP%]   table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{text-align:center;border-right:1px solid #e0e0e0;border-bottom:1px solid #e0e0e0;font-weight:500;color:#000}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{position:sticky;top:0;background:#fff;z-index:1;box-shadow:0 3px 5px 0 #0000001a!important}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:last-child{border-right:0}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]:last-child{box-shadow:0 3px 5px 0 #0000001a!important}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]:last-child   td[_ngcontent-%COMP%]{border-bottom:0}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:12px;border-right:1px solid #e0e0e0;border-bottom:1px solid #e0e0e0;vertical-align:top}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]   .cell[_ngcontent-%COMP%]{min-height:45px;line-height:45px}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]   .part[_ngcontent-%COMP%]{display:flex}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]   .part[_ngcontent-%COMP%]   .part-toggle[_ngcontent-%COMP%]{flex:0 1;display:inline-block;vertical-align:top;padding:5px 0 0 20px}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]{flex:1;display:inline-block;width:100%;padding-top:12px}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:last-child{border-right:0}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]:last-child   td[_ngcontent-%COMP%]{border-bottom:0}.drag-preview[_ngcontent-%COMP%]{padding-left:20px}.drag-preview[_ngcontent-%COMP%]   .drag-preview-inner[_ngcontent-%COMP%]{background:#ff4081;color:#fff;font-weight:700;padding:5px;border-radius:50%;width:30px;height:30px;text-align:center;display:inline-block}.cdk-drop-list-dragging[_ngcontent-%COMP%]   .cdk-drag[_ngcontent-%COMP%]{transition:transform .25s cubic-bezier(0,0,.2,1)}"]}),t})();function ee(t,n){1&t&&c._UZ(0,"mat-spinner")}function ie(t,n){if(1&t&&c._UZ(0,"booking-composition-lines",14),2&t){const t=c.oxw();c.Q6J("composition_id",t.booking.composition_id)}}function oe(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"span",15),c.NdJ("click",function(){return c.CHM(t),c.oxw().viewFullList()}),c._uU(1,"Listing complet"),c.qZA()}}const ae=function(t){return{hidden:t}};class se{constructor(t=0,n="",e=0){this.id=t,this.name=n,this.composition_id=e}}let re=(()=>{class t{constructor(t,n,e,i,o){this.dialog=t,this.api=n,this.route=e,this.context=i,this.zone=o,this.showSbContainer=!1,this.selectedTabIndex=0,this.loading=!0,this.booking=new se}ngAfterContentInit(){this.loading=!1,$("#sb-composition-container").on("_close",(t,n)=>{this.zone.run(()=>{console.log("hiding container"),this.showSbContainer=!1,this.selectedTabIndex=0})}),$("#sb-composition-container").on("_open",(t,n)=>{this.zone.run(()=>{console.log("showing container"),this.showSbContainer=!0})})}ngOnInit(){this.route.params.subscribe(t=>(0,u.mG)(this,void 0,void 0,function*(){if(t&&t.hasOwnProperty("id"))try{this.booking_id=t.id;const n=yield this.load(Object.getOwnPropertyNames(new se));this.booking=new se(n.id,n.name,n.composition_id)}catch(n){console.warn(n)}}))}load(t){return(0,u.mG)(this,void 0,void 0,function*(){const n=yield this.api.read("lodging\\sale\\booking\\Booking",[this.booking_id],t);return n&&n.length?n[0]:{}})}viewFullList(){this.selectedTabIndex=1,this.context.change({context:{entity:"sale\\booking\\CompositionItem",type:"list",name:"default",domain:["composition_id","=",this.booking.composition_id],mode:"view",purpose:"view",target:"#sb-composition-container",callback:t=>{}}})}onGenerate(){this.dialog.open(ce,{width:"50vw",data:{booking:this.booking}}).afterClosed().subscribe(t=>{t?console.log("answer is yes"):console.log("answer is no")})}}return t.\u0275fac=function(n){return new(n||t)(c.Y36(p.uw),c.Y36(s.sM),c.Y36(r.gz),c.Y36(s.Ob),c.Y36(c.R0b))},t.\u0275cmp=c.Xpm({type:t,selectors:[["booking-composition"]],decls:20,vars:7,consts:[[1,"container",3,"ngClass"],[1,"booking-header"],[1,"booking-body"],[2,"display","flex"],[2,"flex","0 1 20%"],[2,"margin-left","auto"],["mat-stroked-button","","color","primary",3,"click"],[3,"selectedIndex"],["label","Listing par Unit\xe9 locative"],[2,"margin-top","20px"],[4,"ngIf"],[3,"composition_id",4,"ngIf"],["mat-tab-label",""],["id","sb-composition-container",1,"sb-container"],[3,"composition_id"],[3,"click"]],template:function(t,n){1&t&&(c.TgZ(0,"div",0),c.TgZ(1,"div",1),c._uU(2,"Composition "),c.TgZ(3,"span"),c._uU(4," \u203a "),c.qZA(),c._uU(5),c.qZA(),c.TgZ(6,"div",2),c.TgZ(7,"div",3),c._UZ(8,"div",4),c.TgZ(9,"div",5),c.TgZ(10,"button",6),c.NdJ("click",function(){return n.onGenerate()}),c._uU(11,"G\xe9n\xe9rer la composition"),c.qZA(),c.qZA(),c.qZA(),c.TgZ(12,"mat-tab-group",7),c.TgZ(13,"mat-tab",8),c.TgZ(14,"div",9),c.YNc(15,ee,1,0,"mat-spinner",10),c.YNc(16,ie,1,1,"booking-composition-lines",11),c.qZA(),c.qZA(),c.TgZ(17,"mat-tab"),c.YNc(18,oe,2,0,"ng-template",12),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c._UZ(19,"div",13)),2&t&&(c.Q6J("ngClass",c.VKq(5,ae,n.showSbContainer)),c.xp6(5),c.hij(" R\xe9servation ",n.booking.name,""),c.xp6(7),c.Q6J("selectedIndex",n.selectedTabIndex),c.xp6(3),c.Q6J("ngIf",n.loading),c.xp6(1),c.Q6J("ngIf",!n.loading))},directives:[y.mk,O.lW,m.SP,m.uX,y.O5,m.uD,Bn.$g,ne],styles:["[_nghost-%COMP%]{width:100%;height:100%;overflow:hidden;box-sizing:border-box}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]{height:100%;width:100%}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{text-transform:uppercase}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]   .booking-header[_ngcontent-%COMP%]{width:100%;padding-left:12px;height:48px;line-height:48px;border-bottom:1px solid #d3d3d3;font-size:22px}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]   .booking-body[_ngcontent-%COMP%]{height:calc(100vh - 123px);width:100%;overflow-y:scroll;padding:12px}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]   .booking-body[_ngcontent-%COMP%]::-webkit-scrollbar{width:6px;overflow-y:scroll;background:#0000}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]   .booking-body[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:var(--mdc-theme-primary,#6200ee);border-radius:10px}[_nghost-%COMP%]   .container.hidden[_ngcontent-%COMP%]{display:none}"]}),t})(),ce=(()=>{class t{constructor(t,n){this.dialogRef=t,this.data=n}}return t.\u0275fac=function(n){return new(n||t)(c.Y36(p.so),c.Y36(p.WI))},t.\u0275cmp=c.Xpm({type:t,selectors:[["dialog-booking-composition-generate-confirm-dialog"]],decls:18,vars:3,consts:[["mat-dialog-title",""],["mat-dialog-content",""],["mat-dialog-actions",""],["mat-button","",3,"mat-dialog-close"],["mat-button","","cdkFocusInitial","",3,"mat-dialog-close"]],template:function(t,n){1&t&&(c.TgZ(0,"h1",0),c._uU(1,"G\xe9n\xe9rer la composition"),c.qZA(),c.TgZ(2,"div",1),c.TgZ(3,"p"),c._uU(4,"Cet assistant g\xe9n\xe9rera une composition sur base de la r\xe9servation "),c.TgZ(5,"b"),c._uU(6),c.qZA(),c._uU(7,"."),c.qZA(),c.TgZ(8,"p"),c._uU(9,"Les d\xe9tails de la composition existante seront remplac\xe9s et les \xe9ventuels changements effectu\xe9s seront perdus."),c.qZA(),c.TgZ(10,"p"),c.TgZ(11,"b"),c._uU(12,"Confirmez-vous la (re)g\xe9n\xe9ration ?"),c.qZA(),c.qZA(),c.qZA(),c.TgZ(13,"div",2),c.TgZ(14,"button",3),c._uU(15,"Annuler"),c.qZA(),c.TgZ(16,"button",4),c._uU(17,"Cr\xe9er"),c.qZA(),c.qZA()),2&t&&(c.xp6(6),c.Oqu(n.data.booking.name),c.xp6(8),c.Q6J("mat-dialog-close",!1),c.xp6(2),c.Q6J("mat-dialog-close",!0))},directives:[p.uh,p.xY,p.H8,O.lW,p.ZT],encapsulation:2}),t})();const de=[{path:"",component:d},{path:"edit/:id",component:Fn},{path:"edit",component:Fn},{path:"composition/:id",component:re}];let ue=(()=>{class t{}return t.\u0275fac=function(n){return new(n||t)},t.\u0275mod=c.oAB({type:t}),t.\u0275inj=c.cJS({imports:[[r.Bz.forChild(de)],r.Bz]}),t})(),le=(()=>{class t{}return t.\u0275fac=function(n){return new(n||t)},t.\u0275mod=c.oAB({type:t}),t.\u0275inj=c.cJS({providers:[{provide:i._A,useClass:a.e,deps:[i.Ad,o.t4]}],imports:[[s._e,ue]]}),t})()}}]);