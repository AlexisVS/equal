(self.webpackChunksymbiose=self.webpackChunksymbiose||[]).push([[513],{1513:(t,n,i)=>{"use strict";i.r(n),i.d(n,{AppInBookingModule:()=>On});var o=i(2458),e=i(521),s=i(7430),r=i(5036),a=i(3423),c=i(7716);let d=(()=>{class t{constructor(t){this.auth=t}ngOnInit(){console.log("BookingComponent init")}}return t.\u0275fac=function(n){return new(n||t)(c.Y36(r.Tq))},t.\u0275cmp=c.Xpm({type:t,selectors:[["booking"]],decls:0,vars:0,template:function(t,n){},styles:["[_nghost-%COMP%]   .tasks-container[_ngcontent-%COMP%]{flex-grow:1;overflow-y:auto}[_nghost-%COMP%]   .card-task[_ngcontent-%COMP%]{display:flex;padding:15px 12px;background:#fff;border-bottom:1px solid #ddd;border-radius:4px;margin-bottom:15px;box-shadow:0 5px 5px -3px #0000000d,0 3px 14px 2px #0000000d}"]}),t})();var p=i(4762),u=i(2298),l=i(2238),g=i(7001),h=i(3461),m=i(1095),_=i(6627),f=i(8583),v=i(3679),Z=i(7574),C=i(4395),k=i(8002),b=i(9773),x=i(8295),O=i(3166),y=i(3220),P=i(1554),M=i(7441),A=i(5396);function w(t,n){1&t&&(c.TgZ(0,"mat-error"),c._uU(1," Ne peut \xeatre vide. "),c.qZA())}let q=(()=>{class t{constructor(t,n,i,o,e){this.api=t,this.auth=n,this.dialog=i,this.zone=o,this.snack=e,this.ready=!1,this.discount={},this.vm={value:{value:0,formControl:new v.NI("",v.kI.required),change:t=>this.valueChange(t)},type:{value:"",formControl:new v.NI("",v.kI.required),change:t=>this.typeChange(t)}}}ngOnInit(){this.discountInput.subscribe(t=>this.load(t)),this.vm.value.formControl.valueChanges.subscribe(t=>{this.vm.value.value=t})}load(t){return(0,p.mG)(this,void 0,void 0,function*(){this.zone.run(()=>{this.ready=!1}),this.zone.run(()=>(0,p.mG)(this,void 0,void 0,function*(){try{console.log("BookingEditBookingsGroupLineDiscountComponent: received changes from parent",t.id,t);for(let n of Object.keys(t))this.discount[n]=t[n];t.hasOwnProperty("type")&&(this.vm.type.value=t.type,this.vm.type.formControl.setValue("percent"!=t.type)),t.hasOwnProperty("value")&&(this.vm.value.value=t.value,this.vm.value.formControl.setValue(t.value))}catch(n){console.warn(n)}this.ready=!0}))})}typeChange(t){console.log(t),this.vm.type.value=t?"amount":"percent",this.vm.value.value&&this.discountOutput.next({id:this.discount.id,type:this.vm.type.value})}valueChange(t){this.vm.value.value&&this.discountOutput.next({id:this.discount.id,value:this.vm.value.value})}}return t.\u0275fac=function(n){return new(n||t)(c.Y36(r.sM),c.Y36(r.Tq),c.Y36(l.uw),c.Y36(c.R0b),c.Y36(g.ux))},t.\u0275cmp=c.Xpm({type:t,selectors:[["booking-edit-bookings-group-line-discount"]],inputs:{lineInput:"lineInput",lineOutput:"lineOutput",discountInput:"discountInput",discountOutput:"discountOutput"},decls:10,vars:3,consts:[[1,"cell"],["floatLabel","always",1,"invisible",2,"max-width","85px"],[3,"formControl","change"],["matInput","","hidden",""],[2,"max-width","90px"],["type","number","placeholder","r\xe9duction","matInput","",3,"formControl","blur"],[4,"ngIf"]],template:function(t,n){1&t&&(c.TgZ(0,"div",0),c.TgZ(1,"mat-form-field",1),c._uU(2," % "),c.TgZ(3,"mat-slide-toggle",2),c.NdJ("change",function(t){return n.vm.type.change(t.checked)}),c._uU(4,"\u20ac"),c.qZA(),c._UZ(5,"textarea",3),c.qZA(),c.qZA(),c.TgZ(6,"div",0),c.TgZ(7,"mat-form-field",4),c.TgZ(8,"input",5),c.NdJ("blur",function(t){return n.vm.value.change(t)}),c.qZA(),c.YNc(9,w,2,0,"mat-error",6),c.qZA(),c.qZA()),2&t&&(c.xp6(3),c.Q6J("formControl",n.vm.type.formControl),c.xp6(5),c.Q6J("formControl",n.vm.value.formControl),c.xp6(1),c.Q6J("ngIf",!n.vm.value.formControl.hasError("required")))},directives:[x.KE,A.Rr,v.JJ,v.oH,O.Nt,v.wV,v.Fj,f.O5,x.TO],styles:["[_nghost-%COMP%]{display:block;width:100%;height:100%;max-height:50px}[_nghost-%COMP%]   .cell[_ngcontent-%COMP%]{display:inline-block}[_nghost-%COMP%]   mat-form-field.invisible[_ngcontent-%COMP%]    .mat-form-field-underline{display:none!important}"]}),t})();function T(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",24),c.NdJ("click",function(){c.CHM(t),c.oxw();const n=c.MAs(1);return n.identification.folded=!n.identification.folded}),c.TgZ(1,"mat-icon",25),c._uU(2,"keyboard_arrow_up"),c.qZA(),c.qZA()}}function I(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",24),c.NdJ("click",function(){c.CHM(t),c.oxw();const n=c.MAs(1);return n.identification.folded=!n.identification.folded}),c.TgZ(1,"mat-icon",25),c._uU(2,"keyboard_arrow_right"),c.qZA(),c.qZA()}}function J(t,n){1&t&&(c.TgZ(0,"mat-icon",26),c._uU(1,"hotel"),c.qZA())}function U(t,n){1&t&&(c.TgZ(0,"span"),c._uU(1,"au logement"),c.qZA())}function N(t,n){1&t&&(c.TgZ(0,"span"),c._uU(1,"\xe0 la personne"),c.qZA())}function Q(t,n){1&t&&(c.TgZ(0,"span"),c._uU(1,"\xe0 l'unit\xe9"),c.qZA())}function Y(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",27),c.NdJ("click",function(){return c.CHM(t),c.oxw().vm.product.reset()}),c.TgZ(1,"mat-icon"),c._uU(2,"close"),c.qZA(),c.qZA()}}function G(t,n){if(1&t&&(c.TgZ(0,"mat-option",29),c._uU(1),c.qZA()),2&t){const t=n.$implicit;c.Q6J("value",t),c.xp6(1),c.AsE(" ",t.name," (",t.sku,") ")}}function D(t,n){1&t&&(c.TgZ(0,"mat-option"),c.TgZ(1,"i"),c._uU(2,"pas de r\xe9sultat"),c.qZA(),c.qZA())}function L(t,n){if(1&t&&(c.TgZ(0,"div"),c.YNc(1,G,2,3,"mat-option",28),c.YNc(2,D,3,0,"mat-option",11),c.qZA()),2&t){const t=n.$implicit;c.xp6(1),c.Q6J("ngForOf",t),c.xp6(1),c.Q6J("ngIf",0==t.length)}}function B(t,n){if(1&t&&(c.TgZ(0,"span"),c._uU(1),c.qZA()),2&t){const t=c.oxw();c.xp6(1),c.Oqu(t.vm.qty.value)}}function E(t,n){1&t&&(c.TgZ(0,"mat-error"),c._uU(1," Ne peut \xeatre vide. "),c.qZA())}function F(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"mat-form-field"),c.TgZ(1,"mat-label"),c._uU(2,"Quantit\xe9"),c.qZA(),c.TgZ(3,"input",20),c.NdJ("blur",function(){return c.CHM(t),c.oxw().vm.qty.change()}),c.qZA(),c.YNc(4,E,2,0,"mat-error",11),c.qZA()}if(2&t){const t=c.oxw();c.xp6(3),c.Q6J("formControl",t.vm.qty.formControl),c.xp6(1),c.Q6J("ngIf",!t.vm.qty.formControl.hasError("required"))}}function j(t,n){if(1&t&&(c.TgZ(0,"span"),c._uU(1),c.qZA()),2&t){const t=c.oxw();c.xp6(1),c.Oqu(t.vm.free_qty.value)}}function H(t,n){if(1&t&&(c.TgZ(0,"span"),c._uU(1),c.ALo(2,"percent"),c.qZA()),2&t){const t=c.oxw();c.xp6(1),c.Oqu(c.lcZ(2,1,t.vm.discount.value))}}function R(t,n){if(1&t&&(c.TgZ(0,"span"),c._uU(1),c.ALo(2,"number"),c.qZA()),2&t){const t=c.oxw();c.xp6(1),c.hij("",c.xi3(2,1,t.vm.total_price.value,"1.2-2")," \u20ac")}}function z(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",24),c.NdJ("click",function(){c.CHM(t),c.oxw(2);const n=c.MAs(1);return n.adapters.folded=!n.adapters.folded}),c.TgZ(1,"mat-icon",25),c._uU(2,"keyboard_arrow_up"),c.qZA(),c.qZA()}}function S(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",24),c.NdJ("click",function(){c.CHM(t),c.oxw(2);const n=c.MAs(1);return n.adapters.folded=!n.adapters.folded}),c.TgZ(1,"mat-icon",25),c._uU(2,"keyboard_arrow_right"),c.qZA(),c.qZA()}}function V(t,n){if(1&t&&(c.TgZ(0,"span"),c._uU(1),c.ALo(2,"percent"),c.ALo(3,"percent"),c.qZA()),2&t){const t=c.oxw(2);c.xp6(1),c.lnq("\xa0 - \xa0",t.adapters[0].discount_list_id.name," (min: ",c.lcZ(2,3,t.adapters[0].discount_list_id.rate_min)," max: ",c.lcZ(3,5,t.adapters[0].discount_list_id.rate_max),")")}}function W(t,n){if(1&t&&(c.TgZ(0,"span"),c._uU(1),c.qZA()),2&t){const t=c.oxw().$implicit;c.xp6(1),c.hij("",t.discount_id.name," : ")}}function X(t,n){if(1&t&&(c.TgZ(0,"span"),c._uU(1),c.ALo(2,"number"),c.qZA()),2&t){const t=c.oxw().$implicit;c.xp6(1),c.hij("",c.xi3(2,1,t.value,"1.2-2")," \u20ac")}}function K(t,n){if(1&t&&(c.TgZ(0,"span"),c._uU(1),c.ALo(2,"percent"),c.qZA()),2&t){const t=c.oxw().$implicit;c.xp6(1),c.Oqu(c.lcZ(2,1,t.value))}}function tt(t,n){if(1&t&&(c.TgZ(0,"span"),c._uU(1),c.qZA()),2&t){const t=c.oxw().$implicit;c.xp6(1),c.Oqu(t.value)}}function nt(t,n){if(1&t&&(c.TgZ(0,"div"),c.YNc(1,W,2,1,"span",11),c.YNc(2,X,3,4,"span",11),c.YNc(3,K,3,3,"span",11),c.YNc(4,tt,2,1,"span",11),c.qZA()),2&t){const t=n.$implicit;c.xp6(1),c.Q6J("ngIf",t.discount_id.name),c.xp6(1),c.Q6J("ngIf","amount"==t.type),c.xp6(1),c.Q6J("ngIf","percent"==t.type),c.xp6(1),c.Q6J("ngIf","freebie"==t.type)}}function it(t,n){if(1&t&&(c.TgZ(0,"div",33),c.TgZ(1,"div"),c.YNc(2,nt,5,4,"div",34),c.qZA(),c.qZA()),2&t){const t=c.oxw(2);c.xp6(2),c.Q6J("ngForOf",t.adapters)}}function ot(t,n){if(1&t&&(c.TgZ(0,"div",6),c.TgZ(1,"div",30),c.TgZ(2,"div",3),c.YNc(3,z,3,0,"button",4),c.YNc(4,S,3,0,"button",4),c.qZA(),c.TgZ(5,"div",5),c.TgZ(6,"div",31),c.TgZ(7,"span"),c._uU(8,"D\xe9tail du prix"),c.qZA(),c.YNc(9,V,4,7,"span",11),c.qZA(),c.YNc(10,it,3,1,"div",32),c.qZA(),c.qZA(),c.qZA()),2&t){const t=c.oxw(),n=c.MAs(1);c.xp6(1),c.ekj("hidden",!t.ready),c.xp6(2),c.Q6J("ngIf",!n.adapters.folded),c.xp6(1),c.Q6J("ngIf",n.adapters.folded),c.xp6(5),c.Q6J("ngIf",t.adapters.length),c.xp6(1),c.Q6J("ngIf",!n.adapters.folded)}}function et(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",24),c.NdJ("click",function(){c.CHM(t),c.oxw(2);const n=c.MAs(1);return n.discounts.folded=!n.discounts.folded}),c.TgZ(1,"mat-icon",25),c._uU(2,"keyboard_arrow_up"),c.qZA(),c.qZA()}}function st(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",24),c.NdJ("click",function(){c.CHM(t),c.oxw(2);const n=c.MAs(1);return n.discounts.folded=!n.discounts.folded}),c.TgZ(1,"mat-icon",25),c._uU(2,"keyboard_arrow_right"),c.qZA(),c.qZA()}}function rt(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"div",38),c.TgZ(1,"div",39),c.TgZ(2,"button",24),c.NdJ("click",function(){const n=c.CHM(t).$implicit;return c.oxw(3).vm.discounts.remove(n)}),c.TgZ(3,"mat-icon"),c._uU(4,"delete"),c.qZA(),c.qZA(),c.qZA(),c._UZ(5,"booking-edit-bookings-group-line-discount",40),c.qZA()}if(2&t){const t=n.index,i=c.oxw(3);c.xp6(5),c.Q6J("discountInput",i._discountOutput[t])("discountOutput",i._discountInput)("lineInput",i.line)("lineOutput",i.lineOutput)}}function at(t,n){if(1&t&&(c.TgZ(0,"div",33),c.TgZ(1,"div",36),c.YNc(2,rt,6,4,"div",37),c.qZA(),c.qZA()),2&t){const t=c.oxw(2);c.xp6(2),c.Q6J("ngForOf",t.discounts)}}function ct(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"div",6),c.TgZ(1,"div",30),c.TgZ(2,"div",3),c.YNc(3,et,3,0,"button",4),c.YNc(4,st,3,0,"button",4),c.qZA(),c.TgZ(5,"div",5),c.TgZ(6,"div",31),c.TgZ(7,"span"),c._uU(8,"R\xe9ductions "),c.TgZ(9,"button",35),c.NdJ("click",function(){c.CHM(t);const n=c.oxw(),i=c.MAs(1);return n.vm.discounts.add(),i.discounts.folded=!1}),c.TgZ(10,"mat-icon"),c._uU(11,"add"),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.YNc(12,at,3,1,"div",32),c.qZA(),c.qZA(),c.qZA()}if(2&t){const t=c.oxw(),n=c.MAs(1);c.xp6(1),c.ekj("hidden",!t.ready),c.xp6(2),c.Q6J("ngIf",!n.discounts.folded),c.xp6(1),c.Q6J("ngIf",n.discounts.folded),c.xp6(8),c.Q6J("ngIf",!n.discounts.folded)}}const dt=function(){return{folded:!0}},pt=function(t,n,i,o,e){return{identification:t,discounts:n,adapters:i,unit_price:o,vat_rate:e}};let ut=(()=>{class t{constructor(t,n,i,o,e){this.api=t,this.auth=n,this.dialog=i,this.zone=o,this.snack=e,this._discountInput=new u.t(1),this._discountOutput=[],this.model_fields={BookingPriceAdapter:["id","type","value","discount_id.name","discount_list_id.name","discount_list_id.rate_min","discount_list_id.rate_max","booking_line_id"]},this.ready=!1,this.line={},this.product=null,this.discounts=[],this.center=null,this.vm={product:{name:"",inputClue:new u.t(1),filteredList:new Z.y,change:t=>this.productChange(t),inputChange:t=>this.productInputChange(t),focus:()=>this.productFocus(),restore:()=>this.productRestore(),reset:()=>this.productReset(),display:t=>this.productDisplay(t)},qty:{value:1,formControl:new v.NI("",v.kI.required),change:()=>this.qtyChange()},free_qty:{value:0},unit_price:{value:0,formControl:new v.NI(""),change:()=>this.unitPriceChange()},discount:{value:0},vat:{value:0,formControl:new v.NI(""),change:()=>this.vatChange()},total_price:{value:0},discounts:{add:()=>this.discountAdd(),remove:t=>this.discountRemove(t)}}}ngOnInit(){this.lineInput.subscribe(t=>this.load(t)),this.bookingInput.subscribe(t=>(0,p.mG)(this,void 0,void 0,function*(){if(t.center_id){let n=yield this.api.read("lodging\\identity\\Center",[t.center_id],["id","name","code","organisation_id","product_groups_ids"]);console.log(n),n&&n.length&&(this.center=n[0])}})),this._discountInput.subscribe(t=>this.updateFromDiscount(t)),this.vm.product.filteredList=this.vm.product.inputClue.pipe((0,C.b)(300),(0,k.U)(t=>"string"==typeof t?t:null==t?"":t.name),(0,b.zg)(t=>(0,p.mG)(this,void 0,void 0,function*(){return this.filterProducts(t)}))),this.vm.qty.formControl.valueChanges.subscribe(t=>{this.vm.qty.value=t}),this.vm.unit_price.formControl.valueChanges.subscribe(t=>{this.vm.unit_price.value=t}),this.vm.vat.formControl.valueChanges.subscribe(t=>{this.vm.vat.value=t})}load(t){return(0,p.mG)(this,void 0,void 0,function*(){this.zone.run(()=>{this.ready=!1}),this.zone.run(()=>(0,p.mG)(this,void 0,void 0,function*(){try{console.log("BookingEditBookingsGroupLineComponent: received changes from parent",t.id,t);for(let n of Object.keys(t))this.line[n]=t[n];if(t.product_id){let n=yield this.api.read("lodging\\sale\\catalog\\Product",[t.product_id],["id","name","sku"]);if(n&&n.length){let t=n[0];this.product=t,this.vm.product.name=t.name+" ("+t.sku+")"}}if(t.hasOwnProperty("price_id")){let n=yield this.api.read("sale\\price\\Price",[t.price_id],["id","price"]);if(n&&n.length){let t=n[0];this.price=t,this.vm.unit_price.value=t.price}else this.price=null,this.vm.unit_price.value=0,this.vm.vat.value=0}if(t.hasOwnProperty("unit_price")&&(this.vm.unit_price.value=t.unit_price,this.vm.unit_price.formControl.setValue(t.unit_price)),t.hasOwnProperty("vat_rate")&&(this.vm.vat.value=t.vat_rate,this.vm.vat.formControl.setValue(t.vat_rate)),t.hasOwnProperty("price")&&(this.vm.total_price.value=t.price),t.hasOwnProperty("qty")&&(this.vm.qty.value=t.qty,this.vm.qty.formControl.setValue(t.qty)),t.manual_discounts_ids){let n=yield this.loadManualDiscounts(t.manual_discounts_ids,this.model_fields.BookingPriceAdapter);if(n){for(let[t,i]of n.entries())if(t>=this.discounts.length){let t=new u.t(1);this._discountOutput.push(t),t.next(i),this.discounts.push(i)}else if(JSON.stringify(this.discounts[t])!=JSON.stringify(i)){let n=new u.t(1);this._discountOutput[t]=n,this.discounts[t]=i,n.next(i)}this.discounts.length>n.length&&(this.discounts.splice(n.length),this._discountOutput.splice(n.length))}let i=0;for(let t of this.discounts)"percent"==t.type&&(i+=t.value);this.vm.discount.value=i}if(t.auto_discounts_ids){let n=0;const i=yield this.loadAutoDiscounts(t.auto_discounts_ids,this.model_fields.BookingPriceAdapter);this.adapters=i;for(let t of this.adapters)"freebie"==t.type&&(n+=t.value);this.vm.free_qty.value=n}}catch(n){console.warn(n)}this.ready=!0}))})}updateFromDiscount(t){return(0,p.mG)(this,void 0,void 0,function*(){console.log("BookingEditBookingsGroupLineComponent: received changes from child",t),console.log(this.discounts);try{let n=!1,i=(this.discounts.findIndex(n=>n.id==t.id),this.discounts.find(n=>n.id==t.id));t.hasOwnProperty("value")&&t.value!=i.value&&(yield this.updateDiscount(t),n=!0),t.hasOwnProperty("type")&&t.type!=i.type&&(yield this.updateDiscount(t),n=!0),n&&this.lineOutput.next({id:this.line.id,price_adapters_ids:!0})}catch(n){console.warn("some changes could not be stored",n),this.snack.open("Erreur - certains changements n'ont pas pu \xeatre enregistr\xe9s.")}})}productInputChange(t){this.vm.product.inputClue.next(t.target.value)}productFocus(){this.vm.product.inputClue.next("")}productDisplay(t){return t?t.name+" ("+t.sku+")":""}productReset(){setTimeout(()=>{this.vm.product.name=""},100)}productRestore(){this.vm.product.name=this.product?this.product.name+" ("+this.product.sku+")":""}productChange(t){if(console.log("BookingEditCustomerComponent::productChange",t),t&&t.option&&t.option.value){let n=t.option.value;this.product=n,this.vm.product.name=n.name+" ("+n.sku+")",this.lineOutput.next({id:this.line.id,product_id:n.id,refresh:{self:["price","vat_rate","unit_price"]}})}}qtyChange(){this.lineOutput.next({id:this.line.id,qty:this.vm.qty.value,refresh:{self:["price"]}})}unitPriceChange(){this.lineOutput.next({id:this.line.id,unit_price:this.vm.unit_price.value,refresh:{self:["price"]}})}vatChange(){this.lineOutput.next({id:this.line.id,vat_rate:this.vm.vat.value,refresh:{self:["price"]}})}filterProducts(t){return(0,p.mG)(this,void 0,void 0,function*(){let n=[];try{let i=[["name","ilike","%"+t+"%"],["can_sell","=",!0]];this.center&&this.center.hasOwnProperty("product_groups_ids")&&this.center.product_groups_ids.length&&i.push(["groups_ids","contains",this.center.product_groups_ids[0]]),n=yield this.api.collect("lodging\\sale\\catalog\\Product",i,["id","name","sku"],"name","asc",0,25)}catch(i){console.log(i)}return n})}loadAutoDiscounts(t,n){return(0,p.mG)(this,void 0,void 0,function*(){return yield this.api.read("lodging\\sale\\booking\\BookingPriceAdapter",t,n)})}loadManualDiscounts(t,n){return(0,p.mG)(this,void 0,void 0,function*(){return yield this.api.read("lodging\\sale\\booking\\BookingPriceAdapter",t,n)})}discountAdd(){return(0,p.mG)(this,void 0,void 0,function*(){try{let t={id:(yield this.api.create("lodging\\sale\\booking\\BookingPriceAdapter",{booking_id:this.line.booking_id,booking_line_group_id:this.line.booking_line_group_id,booking_line_id:this.line.id})).id,type:"percent",value:0},n=new u.t(1);this._discountOutput.push(n),n.next(t),this.discounts.push(t)}catch(t){console.log(t)}})}discountRemove(t){return(0,p.mG)(this,void 0,void 0,function*(){yield this.api.update("lodging\\sale\\booking\\BookingLine",[this.line.id],{price_adapters_ids:[-t.id]},t),this.lineOutput.next({id:this.line.id,price_adapters_ids:!0})})}updateDiscount(t){return(0,p.mG)(this,void 0,void 0,function*(){yield this.api.update("lodging\\sale\\booking\\BookingPriceAdapter",[t.id],t)})}}return t.\u0275fac=function(n){return new(n||t)(c.Y36(r.sM),c.Y36(r.Tq),c.Y36(l.uw),c.Y36(c.R0b),c.Y36(g.ux))},t.\u0275cmp=c.Xpm({type:t,selectors:[["booking-edit-bookings-group-line"]],inputs:{bookingInput:"bookingInput",groupInput:"groupInput",lineOutput:"lineOutput",lineInput:"lineInput"},decls:54,vars:56,consts:[[3,"var"],["vProduct","var"],[1,"part"],[1,"part-toggle"],["mat-icon-button","",3,"click",4,"ngIf"],[1,"part-container"],[1,"row","row-first"],[1,"cell"],["matInput","","type","text","placeholder","Commencez \xe0 taper le nom",3,"matAutocomplete","value","keyup","focus","blur"],["matSuffix","","style","vertical-align: sub;",4,"ngIf"],[3,"align"],[4,"ngIf"],["mat-button","","matSuffix","","mat-icon-button","","aria-label","Clear",3,"click",4,"ngIf"],[3,"displayWith","optionSelected"],["productAutocomplete","matAutocomplete"],[1,"cell","cell-right"],[1,"cell","cell-text","cell-right"],[1,"cell","cell-right",3,"clickOut"],[3,"hidden","click"],[3,"hidden"],["type","number","matInput","",3,"formControl","blur"],["unitPriceInput",""],[1,"cell","cell-actions"],["class","row row-first",4,"ngIf"],["mat-icon-button","",3,"click"],[2,"font-size","15px"],["matSuffix","",2,"vertical-align","sub"],["mat-button","","matSuffix","","mat-icon-button","","aria-label","Clear",3,"click"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],[1,"part","cell"],[1,"row","row-title","row-thin"],["class","row row-thin",4,"ngIf"],[1,"row","row-thin"],[4,"ngFor","ngForOf"],["mat-mini-fab","","color","primary",2,"transform","scale(0.65)",3,"click"],[1,"discounts-list"],["class","discount-item",4,"ngFor","ngForOf"],[1,"discount-item"],[1,"discount-remove"],[3,"discountInput","discountOutput","lineInput","lineOutput"]],template:function(t,n){if(1&t){const t=c.EpF();c._UZ(0,"div",0,1),c.TgZ(2,"div",2),c.TgZ(3,"div",3),c.YNc(4,T,3,0,"button",4),c.YNc(5,I,3,0,"button",4),c.qZA(),c.TgZ(6,"div",5),c.TgZ(7,"div",6),c.TgZ(8,"div",7),c.TgZ(9,"mat-form-field"),c.TgZ(10,"mat-label"),c._uU(11,"Produit"),c.qZA(),c.TgZ(12,"input",8),c.NdJ("keyup",function(t){return n.vm.product.inputChange(t)})("focus",function(){return n.vm.product.focus()})("blur",function(){return n.vm.product.restore()}),c.qZA(),c.YNc(13,J,2,0,"mat-icon",9),c._UZ(14,"mat-hint"),c.TgZ(15,"mat-hint",10),c.YNc(16,U,2,0,"span",11),c.YNc(17,N,2,0,"span",11),c.YNc(18,Q,2,0,"span",11),c.qZA(),c.YNc(19,Y,3,0,"button",12),c.TgZ(20,"mat-autocomplete",13,14),c.NdJ("optionSelected",function(t){return n.vm.product.change(t)}),c.YNc(22,L,3,2,"div",11),c.ALo(23,"async"),c.qZA(),c.qZA(),c.qZA(),c.TgZ(24,"div",15),c.YNc(25,B,2,1,"span",11),c.YNc(26,F,5,2,"mat-form-field",11),c.qZA(),c.TgZ(27,"div",16),c.YNc(28,j,2,1,"span",11),c.qZA(),c.TgZ(29,"div",17),c.NdJ("clickOut",function(){return c.CHM(t),c.MAs(1).unit_price.folded=!0}),c.TgZ(30,"span",18),c.NdJ("click",function(){return c.CHM(t),c.MAs(1).unit_price.folded=!1}),c._uU(31),c.ALo(32,"number"),c.qZA(),c.TgZ(33,"mat-form-field",19),c.TgZ(34,"mat-label"),c._uU(35,"Prix unitaire"),c.qZA(),c.TgZ(36,"input",20,21),c.NdJ("blur",function(){c.CHM(t);const i=c.MAs(1);return n.vm.unit_price.change(),i.unit_price.folded=!0}),c.qZA(),c.qZA(),c.qZA(),c.TgZ(38,"div",16),c.YNc(39,H,3,3,"span",11),c.qZA(),c.TgZ(40,"div",17),c.NdJ("clickOut",function(){return c.CHM(t),c.MAs(1).vat_rate.folded=!0}),c.TgZ(41,"span",18),c.NdJ("click",function(){return c.CHM(t),c.MAs(1).vat_rate.folded=!1}),c._uU(42),c.ALo(43,"percent"),c.qZA(),c.TgZ(44,"mat-form-field",19),c.TgZ(45,"mat-label"),c._uU(46,"Taux TVA"),c.qZA(),c.TgZ(47,"input",20,21),c.NdJ("blur",function(){c.CHM(t);const i=c.MAs(1);return n.vm.vat.change(),i.vat_rate.folded=!0}),c.qZA(),c.qZA(),c.qZA(),c.TgZ(49,"div",16),c.YNc(50,R,3,4,"span",11),c.qZA(),c._UZ(51,"div",22),c.qZA(),c.YNc(52,ot,11,6,"div",23),c.YNc(53,ct,13,5,"div",23),c.qZA(),c.qZA()}if(2&t){const t=c.MAs(1),i=c.MAs(21);c.Q6J("var",c.qbA(50,pt,c.DdM(45,dt),c.DdM(46,dt),c.DdM(47,dt),c.DdM(48,dt),c.DdM(49,dt))),c.xp6(2),c.ekj("hidden",!n.ready),c.xp6(1),c.ekj("hidden",n.groupInput.is_locked),c.xp6(1),c.Q6J("ngIf",!t.identification.folded),c.xp6(1),c.Q6J("ngIf",t.identification.folded),c.xp6(7),c.Q6J("matAutocomplete",i)("value",n.vm.product.name),c.xp6(1),c.Q6J("ngIf","accomodation"==n.line.qty_accounting_method),c.xp6(2),c.Q6J("align","end"),c.xp6(1),c.Q6J("ngIf","accomodation"==n.line.qty_accounting_method),c.xp6(1),c.Q6J("ngIf","person"==n.line.qty_accounting_method),c.xp6(1),c.Q6J("ngIf","unit"==n.line.qty_accounting_method),c.xp6(1),c.Q6J("ngIf",n.vm.product.name.length),c.xp6(1),c.Q6J("displayWith",n.vm.product.display),c.xp6(2),c.Q6J("ngIf",c.lcZ(23,38,n.vm.product.filteredList)),c.xp6(2),c.ekj("cell-text",n.groupInput.is_locked),c.xp6(1),c.Q6J("ngIf",n.groupInput.is_locked),c.xp6(1),c.Q6J("ngIf",!n.groupInput.is_locked),c.xp6(2),c.Q6J("ngIf",!n.groupInput.is_locked),c.xp6(1),c.ekj("cell-text",t.unit_price.folded),c.xp6(1),c.Q6J("hidden",!t.unit_price.folded||n.groupInput.is_locked),c.xp6(1),c.hij("",c.xi3(32,40,n.vm.unit_price.value,"1.2-2")," \u20ac"),c.xp6(2),c.Q6J("hidden",t.unit_price.folded),c.xp6(3),c.Q6J("formControl",n.vm.unit_price.formControl),c.xp6(3),c.Q6J("ngIf",!n.groupInput.is_locked),c.xp6(1),c.ekj("cell-text",t.vat_rate.folded),c.xp6(1),c.Q6J("hidden",!t.vat_rate.folded||n.groupInput.is_locked),c.xp6(1),c.Oqu(c.lcZ(43,43,n.vm.vat.value)),c.xp6(2),c.Q6J("hidden",t.vat_rate.folded),c.xp6(3),c.Q6J("formControl",n.vm.vat.formControl),c.xp6(3),c.Q6J("ngIf",!n.groupInput.is_locked),c.xp6(2),c.Q6J("ngIf",!t.identification.folded&&!n.groupInput.is_locked),c.xp6(1),c.Q6J("ngIf",!t.identification.folded&&!n.groupInput.is_locked)}},directives:[r.gC,f.O5,x.KE,x.hX,O.Nt,P.ZL,x.bx,P.XC,r.e3,v.wV,v.Fj,v.JJ,v.oH,m.lW,_.Hw,x.R9,f.sg,o.ey,x.TO,q],pipes:[f.Ov,f.JJ,f.Zx],styles:["[_nghost-%COMP%]{display:block;width:100%;height:100%}[_nghost-%COMP%]   .hidden[_ngcontent-%COMP%]{visibility:hidden}[_nghost-%COMP%]   [hidden][_ngcontent-%COMP%]{display:none!important}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]{display:flex}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-toggle[_ngcontent-%COMP%]{flex:0 1;display:inline-block;vertical-align:top;padding:2px 0 0 20px}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]{flex:1;display:inline-block;width:100%;min-height:45px}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]{width:100%;display:flex;padding:5px 0;flex:1}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .cell[_ngcontent-%COMP%]{position:relative;padding:0 10px;margin-right:15px;white-space:nowrap;text-overflow:ellipsis;overflow:hidden}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .cell.cell-text[_ngcontent-%COMP%]{line-height:45px}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .cell.cell-right[_ngcontent-%COMP%]{text-align:right}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .cell.cell-actions[_ngcontent-%COMP%]{max-width:35px}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .cell[_ngcontent-%COMP%]:first-child{flex:0 0 calc((100% + 60px)*0.40 - 60px)}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .cell[_ngcontent-%COMP%]:not(:first-child){flex:1 0 calc((100% + 60px)*0.08)}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row.row-first[_ngcontent-%COMP%]     .mat-form-field-wrapper{padding-bottom:15px}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row.row-title[_ngcontent-%COMP%]{height:45px;line-height:45px}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row.row-thin[_ngcontent-%COMP%]{padding:0}[_nghost-%COMP%]   mat-form-field[_ngcontent-%COMP%]{width:100%;padding:0 12px}[_nghost-%COMP%]   mat-form-field.header[_ngcontent-%COMP%]{margin-top:-5px}[_nghost-%COMP%]   mat-form-field.header[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{font-size:22px}[_nghost-%COMP%]   mat-form-field.invisible[_ngcontent-%COMP%]    .mat-form-field-underline{display:none!important}[_nghost-%COMP%]   p[_ngcontent-%COMP%]{font-size:14px;padding:0 12px}[_nghost-%COMP%]   .discounts-list[_ngcontent-%COMP%]{position:relative;padding:0 12px 0 0;width:100%}[_nghost-%COMP%]   .discounts-list[_ngcontent-%COMP%]   .discount-item[_ngcontent-%COMP%]{position:relative;background-color:#fff}[_nghost-%COMP%]   .discounts-list[_ngcontent-%COMP%]   .discount-item[_ngcontent-%COMP%]   .discount-remove[_ngcontent-%COMP%]{position:absolute;right:-5px;top:10px;z-index:2}"]}),t})();function lt(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",7),c.NdJ("click",function(){return c.CHM(t),c.oxw().vm.rental_unit.reset()}),c.TgZ(1,"mat-icon"),c._uU(2,"close"),c.qZA(),c.qZA()}}function gt(t,n){if(1&t&&(c.TgZ(0,"mat-option",9),c._uU(1),c.qZA()),2&t){const t=n.$implicit;c.Q6J("value",t),c.xp6(1),c.AsE(" ",t.name," (",t.capacity,") ")}}function ht(t,n){1&t&&(c.TgZ(0,"mat-option"),c.TgZ(1,"i"),c._uU(2,"pas de r\xe9sultat"),c.qZA(),c.qZA())}function mt(t,n){if(1&t&&(c.TgZ(0,"div"),c.YNc(1,gt,2,3,"mat-option",8),c.YNc(2,ht,3,0,"mat-option",6),c.qZA()),2&t){const t=n.$implicit;c.xp6(1),c.Q6J("ngForOf",t),c.xp6(1),c.Q6J("ngIf",0==t.length)}}let _t=(()=>{class t{constructor(t,n,i,o){this.api=t,this.auth=n,this.zone=i,this.snack=o,this.ready=!1,this.accomodation={},this.product=null,this.rental_unit=null,this.vm={rental_unit:{name:"",inputClue:new u.t(1),filteredList:new Z.y,change:t=>this.rentalUnitChange(t),inputChange:t=>this.rentalUnitInputChange(t),focus:()=>this.rentalUnitFocus(),restore:()=>this.rentalUnitRestore(),reset:()=>this.rentalUnitReset(),display:t=>this.rentalUnitDisplay(t)},product:{id:0,name:""}}}ngOnInit(){this.accomodationInput.subscribe(t=>this.load(t)),this.vm.rental_unit.filteredList=this.vm.rental_unit.inputClue.pipe((0,C.b)(300),(0,k.U)(t=>"string"==typeof t?t:null==t?"":t.name),(0,b.zg)(t=>(0,p.mG)(this,void 0,void 0,function*(){return this.filterRentalUnits(t)})))}load(t){return(0,p.mG)(this,void 0,void 0,function*(){this.zone.run(()=>{this.ready=!1}),this.zone.run(()=>(0,p.mG)(this,void 0,void 0,function*(){try{for(let n of Object.keys(t))this.accomodation[n]=t[n];if(t.product_id){let n=yield this.api.read("lodging\\sale\\catalog\\Product",[t.product_id],["id","name","sku"]);if(n&&n.length){let t=n[0];this.product=t,this.vm.product.name=t.name+" ("+t.sku+")"}}if(t.rental_unit_id){let n=yield this.api.read("lodging\\realestate\\RentalUnit",[t.rental_unit_id],["id","name","capacity"]);if(n&&n.length){let t=n[0];this.rental_unit=t,this.vm.rental_unit.name=t.name+" ("+t.capacity+")"}}}catch(n){console.warn(n)}this.ready=!0}))})}rentalUnitInputChange(t){this.vm.rental_unit.inputClue.next(t.target.value)}rentalUnitFocus(){this.vm.rental_unit.inputClue.next("")}rentalUnitDisplay(t){return t?t.name+" ("+t.capacity+")":""}rentalUnitReset(){setTimeout(()=>{this.vm.rental_unit.name=""},100)}rentalUnitRestore(){this.vm.rental_unit.name=this.rental_unit?this.rental_unit.name+" ("+this.rental_unit.capacity+")":""}rentalUnitChange(t){if(console.log("BookingEditCustomerComponent::rentalUnitChange",t),t&&t.option&&t.option.value){let n=t.option.value;this.rental_unit=n,this.vm.rental_unit.name=n.name+" ("+n.capacity+")",this.accomodationOutput.next({id:this.accomodation.id,rental_unit_id:n.id})}}filterRentalUnits(t){return(0,p.mG)(this,void 0,void 0,function*(){let n=[];try{n=yield this.api.collect("lodging\\realestate\\RentalUnit",[["name","ilike","%"+t+"%"]],["id","name","capacity"],"name","asc",0,25)}catch(i){console.log(i)}return n})}}return t.\u0275fac=function(n){return new(n||t)(c.Y36(r.sM),c.Y36(r.Tq),c.Y36(c.R0b),c.Y36(g.ux))},t.\u0275cmp=c.Xpm({type:t,selectors:[["booking-edit-bookings-group-accomodation"]],inputs:{groupInput:"groupInput",accomodationOutput:"accomodationOutput",accomodationInput:"accomodationInput"},decls:12,vars:9,consts:[[1,"cell"],["matInput","","type","text","placeholder","Commencez \xe0 taper le nom",3,"matAutocomplete","value","keyup","focus","blur"],[3,"align"],["mat-button","","matSuffix","","mat-icon-button","","aria-label","Clear",3,"click",4,"ngIf"],[3,"displayWith","optionSelected"],["rentalUnitAutocomplete","matAutocomplete"],[4,"ngIf"],["mat-button","","matSuffix","","mat-icon-button","","aria-label","Clear",3,"click"],[3,"value",4,"ngFor","ngForOf"],[3,"value"]],template:function(t,n){if(1&t&&(c.TgZ(0,"div",0),c.TgZ(1,"mat-form-field"),c.TgZ(2,"mat-label"),c._uU(3,"Unit\xe9 locative"),c.qZA(),c.TgZ(4,"input",1),c.NdJ("keyup",function(t){return n.vm.rental_unit.inputChange(t)})("focus",function(){return n.vm.rental_unit.focus()})("blur",function(){return n.vm.rental_unit.restore()}),c.qZA(),c.TgZ(5,"mat-hint",2),c._uU(6),c.qZA(),c.YNc(7,lt,3,0,"button",3),c.TgZ(8,"mat-autocomplete",4,5),c.NdJ("optionSelected",function(t){return n.vm.rental_unit.change(t)}),c.YNc(10,mt,3,2,"div",6),c.ALo(11,"async"),c.qZA(),c.qZA(),c.qZA()),2&t){const t=c.MAs(9);c.xp6(4),c.Q6J("matAutocomplete",t)("value",n.vm.rental_unit.name),c.xp6(1),c.Q6J("align","end"),c.xp6(1),c.hij("Logement assign\xe9 \xe0 ",n.vm.product.name,""),c.xp6(1),c.Q6J("ngIf",n.vm.rental_unit.name.length),c.xp6(1),c.Q6J("displayWith",n.vm.rental_unit.display),c.xp6(2),c.Q6J("ngIf",c.lcZ(11,7,n.vm.rental_unit.filteredList))}},directives:[x.KE,x.hX,O.Nt,P.ZL,x.bx,f.O5,P.XC,m.lW,x.R9,_.Hw,f.sg,o.ey],pipes:[f.Ov],styles:["[_nghost-%COMP%]{display:flex;width:100%;height:100%}[_nghost-%COMP%]   .hidden[_ngcontent-%COMP%]{visibility:hidden}[_nghost-%COMP%]   .cell[_ngcontent-%COMP%]{flex:0 1 30%}[_nghost-%COMP%]   .cell[_ngcontent-%COMP%]   mat-form-field[_ngcontent-%COMP%]{width:100%}"]}),t})();function ft(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",19),c.NdJ("click",function(){c.CHM(t),c.oxw();const n=c.MAs(1);return n.identification.folded=!n.identification.folded}),c.TgZ(1,"mat-icon",20),c._uU(2,"keyboard_arrow_up"),c.qZA(),c.qZA()}}function vt(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",19),c.NdJ("click",function(){c.CHM(t),c.oxw();const n=c.MAs(1);return n.identification.folded=!n.identification.folded}),c.TgZ(1,"mat-icon",20),c._uU(2,"keyboard_arrow_right"),c.qZA(),c.qZA()}}function Zt(t,n){1&t&&(c.TgZ(0,"mat-error"),c._uU(1," Ne peut \xeatre vide. "),c.qZA())}function Ct(t,n){1&t&&(c.TgZ(0,"mat-error"),c._uU(1," Doit \xeatre sup\xe9rieur \xe0 0. "),c.qZA())}function kt(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"div",6),c.TgZ(1,"div",7),c.TgZ(2,"div",21),c.TgZ(3,"mat-form-field",22),c.TgZ(4,"mat-label"),c._uU(5,"Intitul\xe9 du s\xe9jour"),c.qZA(),c.TgZ(6,"input",23),c.NdJ("blur",function(){return c.CHM(t),c.oxw().vm.name.change()}),c.qZA(),c.TgZ(7,"mat-hint"),c._uU(8,"Libell\xe9 du regroupement."),c.qZA(),c.YNc(9,Zt,2,0,"mat-error",24),c.qZA(),c.qZA(),c.TgZ(10,"div",25),c.TgZ(11,"mat-form-field"),c.TgZ(12,"mat-label"),c._uU(13,"Dates du s\xe9jour"),c.qZA(),c.TgZ(14,"mat-date-range-input",26),c.TgZ(15,"input",27),c.NdJ("blur",function(){return c.CHM(t),c.oxw().vm.daterange.change()}),c.qZA(),c.TgZ(16,"input",28),c.NdJ("blur",function(){return c.CHM(t),c.oxw().vm.daterange.change()}),c.qZA(),c.qZA(),c._UZ(17,"mat-datepicker-toggle",29),c.TgZ(18,"mat-date-range-picker",30,31),c.NdJ("closed",function(){return c.CHM(t),c.oxw().vm.daterange.change()}),c.qZA(),c.TgZ(20,"mat-hint",32),c.TgZ(21,"strong"),c._uU(22),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.TgZ(23,"div",33),c.TgZ(24,"mat-form-field"),c.TgZ(25,"mat-label"),c._uU(26,"Participants"),c.qZA(),c.TgZ(27,"input",34),c.NdJ("blur",function(){return c.CHM(t),c.oxw().vm.participants_count.change()}),c.qZA(),c.TgZ(28,"mat-hint"),c._uU(29,"Nombre d'h\xf4tes"),c.qZA(),c.YNc(30,Ct,2,0,"mat-error",24),c.qZA(),c.qZA(),c.qZA(),c.qZA()}if(2&t){const t=c.MAs(19),n=c.oxw();c.xp6(6),c.Q6J("formControl",n.vm.name.formControl),c.xp6(3),c.Q6J("ngIf",!n.vm.name.formControl.hasError("required")),c.xp6(5),c.Q6J("rangePicker",t),c.xp6(1),c.Q6J("formControl",n.vm.daterange.start.formControl),c.xp6(1),c.Q6J("formControl",n.vm.daterange.end.formControl),c.xp6(1),c.Q6J("for",t),c.xp6(3),c.Q6J("align","end"),c.xp6(2),c.AsE("",n.vm.daterange.nights_count," ",n.vm.daterange.nights_count>1?"nuit\xe9es":"nuit\xe9e",""),c.xp6(5),c.Q6J("value",n.vm.participants_count.value)("formControl",n.vm.participants_count.formControl),c.xp6(3),c.Q6J("ngIf",!n.vm.participants_count.formControl.hasError("required"))}}function bt(t,n){1&t&&(c.TgZ(0,"mat-error"),c._uU(1," Ne peut \xeatre vide. "),c.qZA())}function xt(t,n){1&t&&(c.TgZ(0,"mat-error"),c._uU(1," Doit \xeatre sup\xe9rieur \xe0 0. "),c.qZA())}function Ot(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",51),c.NdJ("click",function(){return c.CHM(t),c.oxw(2).vm.rate_class.reset()}),c.TgZ(1,"mat-icon"),c._uU(2,"close"),c.qZA(),c.qZA()}}function yt(t,n){if(1&t&&(c.TgZ(0,"mat-option",53),c._uU(1),c.qZA()),2&t){const t=n.$implicit;c.Q6J("value",t),c.xp6(1),c.AsE(" ",t.name," - ",t.description," ")}}function Pt(t,n){1&t&&(c.TgZ(0,"mat-option"),c.TgZ(1,"i"),c._uU(2,"pas de r\xe9sultat"),c.qZA(),c.qZA())}function Mt(t,n){if(1&t&&(c.TgZ(0,"div"),c.YNc(1,yt,2,3,"mat-option",52),c.YNc(2,Pt,3,0,"mat-option",24),c.qZA()),2&t){const t=n.$implicit;c.xp6(1),c.Q6J("ngForOf",t),c.xp6(1),c.Q6J("ngIf",0==t.length)}}function At(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",51),c.NdJ("click",function(){return c.CHM(t),c.oxw(3).vm.pack.reset()}),c.TgZ(1,"mat-icon"),c._uU(2,"close"),c.qZA(),c.qZA()}}function wt(t,n){if(1&t&&(c.TgZ(0,"mat-option",53),c._uU(1),c.qZA()),2&t){const t=n.$implicit;c.Q6J("value",t),c.xp6(1),c.hij(" ",t.name," ")}}function qt(t,n){1&t&&(c.TgZ(0,"mat-option"),c.TgZ(1,"i"),c._uU(2,"pas de r\xe9sultat"),c.qZA(),c.qZA())}function Tt(t,n){if(1&t&&(c.TgZ(0,"div"),c.YNc(1,wt,2,2,"mat-option",52),c.YNc(2,qt,3,0,"mat-option",24),c.qZA()),2&t){const t=n.$implicit;c.xp6(1),c.Q6J("ngForOf",t),c.xp6(1),c.Q6J("ngIf",0==t.length)}}function It(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"div",35),c.TgZ(1,"mat-form-field"),c.TgZ(2,"mat-label"),c._uU(3,"Pack de r\xe9f\xe9rence"),c.qZA(),c.TgZ(4,"input",36),c.NdJ("keyup",function(n){return c.CHM(t),c.oxw(2).vm.pack.inputChange(n)})("focus",function(){return c.CHM(t),c.oxw(2).vm.pack.focus()})("blur",function(){return c.CHM(t),c.oxw(2).vm.pack.restore()}),c.qZA(),c.YNc(5,At,3,0,"button",37),c.TgZ(6,"mat-autocomplete",38,54),c.NdJ("optionSelected",function(n){return c.CHM(t),c.oxw(2).vm.pack.change("name",n.option.value)}),c.YNc(8,Tt,3,2,"div",24),c.ALo(9,"async"),c.qZA(),c.TgZ(10,"mat-hint",40),c.TgZ(11,"span"),c._uU(12,"Type de s\xe9jour de la r\xe9servation"),c.qZA(),c.qZA(),c.qZA(),c.qZA()}if(2&t){const t=c.MAs(7),n=c.oxw(2);c.xp6(4),c.Q6J("matAutocomplete",t)("value",n.vm.pack.name),c.xp6(1),c.Q6J("ngIf",n.vm.pack.name.length),c.xp6(1),c.Q6J("displayWith",n.vm.pack.display),c.xp6(2),c.Q6J("ngIf",c.lcZ(9,6,n.vm.pack.filteredList)),c.xp6(2),c.Q6J("align","start")}}function Jt(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"div",55),c.TgZ(1,"mat-form-field",46),c.TgZ(2,"mat-slide-toggle",56),c.NdJ("change",function(n){return c.CHM(t),c.oxw(2).vm.pack.change("is_locked",n.checked)}),c._uU(3,"Liste des produits verrouill\xe9e"),c.qZA(),c._UZ(4,"textarea",48),c.qZA(),c.qZA()}if(2&t){const t=c.oxw(2);c.xp6(2),c.Q6J("ngModel",t.vm.pack.is_locked)}}function Ut(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"div",6),c.TgZ(1,"div",7),c.TgZ(2,"div",21),c.TgZ(3,"mat-form-field",22),c.TgZ(4,"mat-label"),c._uU(5,"Intitul\xe9 du s\xe9jour"),c.qZA(),c.TgZ(6,"input",23),c.NdJ("blur",function(){return c.CHM(t),c.oxw().vm.name.change()}),c.qZA(),c.TgZ(7,"mat-hint"),c._uU(8,"Libell\xe9 du regroupement."),c.qZA(),c.YNc(9,bt,2,0,"mat-error",24),c.qZA(),c.qZA(),c.TgZ(10,"div",25),c.TgZ(11,"mat-form-field"),c.TgZ(12,"mat-label"),c._uU(13,"Dates du s\xe9jour"),c.qZA(),c.TgZ(14,"mat-date-range-input",26),c.TgZ(15,"input",27),c.NdJ("blur",function(){return c.CHM(t),c.oxw().vm.daterange.change()}),c.qZA(),c.TgZ(16,"input",28),c.NdJ("blur",function(){return c.CHM(t),c.oxw().vm.daterange.change()}),c.qZA(),c.qZA(),c._UZ(17,"mat-datepicker-toggle",29),c.TgZ(18,"mat-date-range-picker",30,31),c.NdJ("closed",function(){return c.CHM(t),c.oxw().vm.daterange.change()}),c.qZA(),c.TgZ(20,"mat-hint",32),c.TgZ(21,"strong"),c._uU(22),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.TgZ(23,"div",33),c.TgZ(24,"mat-form-field"),c.TgZ(25,"mat-label"),c._uU(26,"Participants"),c.qZA(),c.TgZ(27,"input",34),c.NdJ("blur",function(){return c.CHM(t),c.oxw().vm.participants_count.change()}),c.qZA(),c.TgZ(28,"mat-hint"),c._uU(29,"Nombre d'h\xf4tes"),c.qZA(),c.YNc(30,xt,2,0,"mat-error",24),c.qZA(),c.qZA(),c.qZA(),c.TgZ(31,"div",7),c.TgZ(32,"div",35),c.TgZ(33,"mat-form-field"),c.TgZ(34,"mat-label"),c._uU(35,"Cat\xe9gorie tarifaire"),c.qZA(),c.TgZ(36,"input",36),c.NdJ("keyup",function(n){return c.CHM(t),c.oxw().vm.rate_class.inputChange(n)})("focus",function(){return c.CHM(t),c.oxw().vm.rate_class.focus()})("blur",function(){return c.CHM(t),c.oxw().vm.rate_class.restore()}),c.qZA(),c.YNc(37,Ot,3,0,"button",37),c.TgZ(38,"mat-autocomplete",38,39),c.NdJ("optionSelected",function(n){return c.CHM(t),c.oxw().vm.rate_class.change(n)}),c.YNc(40,Mt,3,2,"div",24),c.ALo(41,"async"),c.qZA(),c.TgZ(42,"mat-hint",40),c.TgZ(43,"span"),c._uU(44,"Cat\xe9gorie tarifaire de facturation"),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.TgZ(45,"div",41),c.TgZ(46,"mat-form-field"),c.TgZ(47,"mat-label"),c._uU(48,"Type de s\xe9jour"),c.qZA(),c.TgZ(49,"mat-select",42),c.NdJ("selectionChange",function(n){return c.CHM(t),c.oxw().vm.sojourn_type.change(n)}),c.TgZ(50,"mat-option",43),c._uU(51,"GG"),c.qZA(),c.TgZ(52,"mat-option",44),c._uU(53,"GA"),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.TgZ(54,"div",7),c.TgZ(55,"div",45),c.TgZ(56,"mat-form-field",46),c.TgZ(57,"mat-slide-toggle",47),c.NdJ("change",function(n){return c.CHM(t),c.oxw().vm.pack.change("has_pack",n.checked)}),c._uU(58,"Utiliser un pack ?"),c.qZA(),c._UZ(59,"textarea",48),c.qZA(),c.qZA(),c.YNc(60,It,13,8,"div",49),c.YNc(61,Jt,5,1,"div",50),c.qZA(),c.qZA()}if(2&t){const t=c.MAs(19),n=c.MAs(39),i=c.oxw();c.xp6(6),c.Q6J("formControl",i.vm.name.formControl),c.xp6(3),c.Q6J("ngIf",!i.vm.name.formControl.hasError("required")),c.xp6(5),c.Q6J("rangePicker",t),c.xp6(1),c.Q6J("formControl",i.vm.daterange.start.formControl),c.xp6(1),c.Q6J("formControl",i.vm.daterange.end.formControl),c.xp6(1),c.Q6J("for",t),c.xp6(3),c.Q6J("align","end"),c.xp6(2),c.AsE("",i.vm.daterange.nights_count," ",i.vm.daterange.nights_count>1?"nuit\xe9es":"nuit\xe9e",""),c.xp6(5),c.Q6J("value",i.vm.participants_count.value)("formControl",i.vm.participants_count.formControl),c.xp6(3),c.Q6J("ngIf",!i.vm.participants_count.formControl.hasError("required")),c.xp6(6),c.Q6J("matAutocomplete",n)("value",i.vm.rate_class.name),c.xp6(1),c.Q6J("ngIf",i.vm.rate_class.name.length),c.xp6(1),c.Q6J("displayWith",i.vm.rate_class.display),c.xp6(2),c.Q6J("ngIf",c.lcZ(41,22,i.vm.rate_class.filteredList)),c.xp6(2),c.Q6J("align","start"),c.xp6(7),c.Q6J("ngModel",i.vm.sojourn_type.value),c.xp6(8),c.Q6J("ngModel",i.vm.pack.has_pack),c.xp6(3),c.Q6J("ngIf",i.vm.pack.has_pack),c.xp6(1),c.Q6J("ngIf",i.vm.pack.has_pack)}}function Nt(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",19),c.NdJ("click",function(){c.CHM(t),c.oxw();const n=c.MAs(1);return n.products.folded=!n.products.folded}),c.TgZ(1,"mat-icon",20),c._uU(2,"keyboard_arrow_up"),c.qZA(),c.qZA()}}function Qt(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",19),c.NdJ("click",function(){c.CHM(t),c.oxw();const n=c.MAs(1);return n.products.folded=!n.products.folded}),c.TgZ(1,"mat-icon",20),c._uU(2,"keyboard_arrow_right"),c.qZA(),c.qZA()}}function Yt(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",57),c.NdJ("click",function(){return c.CHM(t),c.oxw().vm.lines.add()}),c.TgZ(1,"mat-icon"),c._uU(2,"add"),c.qZA(),c.qZA()}}function Gt(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",19),c.NdJ("click",function(){c.CHM(t);const n=c.oxw().$implicit;return c.oxw().vm.lines.remove(n)}),c.TgZ(1,"mat-icon"),c._uU(2,"delete"),c.qZA(),c.qZA()}}function Dt(t,n){if(1&t&&(c.TgZ(0,"div",58),c.TgZ(1,"div",59),c.TgZ(2,"mat-icon",60),c._uU(3,"drag_indicator"),c.qZA(),c.qZA(),c.TgZ(4,"div",61),c.YNc(5,Gt,3,0,"button",4),c.qZA(),c._UZ(6,"booking-edit-bookings-group-line",62),c.qZA()),2&t){const t=n.$implicit,i=n.index,o=c.oxw();c.Q6J("cdkDragData",t),c.xp6(5),c.Q6J("ngIf",!o.vm.pack.is_locked),c.xp6(1),c.Q6J("bookingInput",o.bookingInput)("groupInput",o.group)("lineInput",o._lineOutput[i])("lineOutput",o._lineInput)}}function Lt(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",19),c.NdJ("click",function(){c.CHM(t),c.oxw();const n=c.MAs(1);return n.accomodations.folded=!n.accomodations.folded}),c.TgZ(1,"mat-icon",20),c._uU(2,"keyboard_arrow_up"),c.qZA(),c.qZA()}}function Bt(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",19),c.NdJ("click",function(){c.CHM(t),c.oxw();const n=c.MAs(1);return n.accomodations.folded=!n.accomodations.folded}),c.TgZ(1,"mat-icon",20),c._uU(2,"keyboard_arrow_right"),c.qZA(),c.qZA()}}function Et(t,n){1&t&&(c.TgZ(0,"div",6),c.TgZ(1,"div",7),c.TgZ(2,"div",63),c._uU(3,"Logements "),c.qZA(),c.qZA(),c.qZA())}function Ft(t,n){if(1&t&&(c.TgZ(0,"div",66),c._UZ(1,"booking-edit-bookings-group-accomodation",67),c.qZA()),2&t){const t=n.index,i=c.oxw(2);c.xp6(1),c.Q6J("groupInput",i.group)("accomodationInput",i._accomodationOutput[t])("accomodationOutput",i._accomodationInput)}}function jt(t,n){if(1&t&&(c.TgZ(0,"div",6),c.TgZ(1,"div",7),c.TgZ(2,"div",63),c._uU(3,"Logements "),c.qZA(),c.qZA(),c.TgZ(4,"div",64),c.YNc(5,Ft,2,3,"div",65),c.qZA(),c.qZA()),2&t){const t=c.oxw();c.xp6(5),c.Q6J("ngForOf",t.accomodations)}}const Ht=function(){return{folded:!0}},Rt=function(t,n,i){return{identification:t,products:n,accomodations:i}};let zt=(()=>{class t{constructor(t,n,i,o,e){this.api=t,this.auth=n,this.dialog=i,this.zone=o,this.snack=e,this._lineInput=new u.t(1),this._lineOutput=[],this._accomodationInput=new u.t(1),this._accomodationOutput=[],this.model_fields={BookingLine:["id","product_id","order","qty","price_id","vat_rate","unit_price","price","booking_id","booking_line_group_id","price_adapters_ids","auto_discounts_ids","manual_discounts_ids","qty_accounting_method"],Consumption:["id","product_id","rental_unit_id"]},this.ready=!1,this.group={},this.rate_class=null,this.pack=null,this.lines=[],this.accomodations=[],this.center=null,this.vm={price:{value:0},name:{value:"",formControl:new v.NI("",v.kI.required),change:()=>this.nameChange()},daterange:{start:{formControl:new v.NI},end:{formControl:new v.NI},nights_count:0,change:()=>this.dateRangeChange()},participants_count:{value:1,formControl:new v.NI("",v.kI.required),change:()=>this.nbPersChange()},sojourn_type:{value:"GG",change:t=>this.sojournTypeChange(t)},pack:{name:"",has_pack:!1,is_locked:!1,inputClue:new u.t(1),filteredList:new Z.y,change:(t,n)=>this.packChange(t,n),inputChange:t=>this.packInputChange(t),focus:()=>this.packFocus(),restore:()=>this.packRestore(),reset:()=>this.packReset(),display:t=>this.packDisplay(t)},rate_class:{name:"",inputClue:new u.t(1),filteredList:new Z.y,change:t=>this.rateClassChange(t),inputChange:t=>this.rateClassInputChange(t),focus:()=>this.rateClassFocus(),restore:()=>this.rateClassRestore(),reset:()=>this.rateClassReset(),display:t=>this.rateClassDisplay(t)},lines:{add:()=>this.lineAdd(),remove:t=>this.lineRemove(t),drop:t=>this.lineDrop(t)}}}ngOnInit(){this.groupInput.subscribe(t=>this.load(t)),this.bookingInput.subscribe(t=>(0,p.mG)(this,void 0,void 0,function*(){if(t.center_id){let n=yield this.api.read("lodging\\identity\\Center",[t.center_id],["id","name","code","organisation_id","product_groups_ids"]);n&&n.length&&(this.center=n[0])}})),this._lineInput.subscribe(t=>this.updateFromLine(t)),this._accomodationInput.subscribe(t=>this.updateFromAccomodation(t)),this.vm.pack.filteredList=this.vm.pack.inputClue.pipe((0,C.b)(300),(0,k.U)(t=>"string"==typeof t?t:null==t?"":t.name),(0,b.zg)(t=>(0,p.mG)(this,void 0,void 0,function*(){return this.filterPacks(t)}))),this.vm.rate_class.filteredList=this.vm.rate_class.inputClue.pipe((0,C.b)(300),(0,k.U)(t=>"string"==typeof t?t:null==t?"":t.name),(0,b.zg)(t=>(0,p.mG)(this,void 0,void 0,function*(){return this.filterRateClasses(t)}))),this.vm.daterange.start.formControl.valueChanges.subscribe(t=>{this.dateRangeUpdate()}),this.vm.daterange.end.formControl.valueChanges.subscribe(t=>{this.dateRangeUpdate()}),this.vm.participants_count.formControl.valueChanges.subscribe(t=>{this.vm.participants_count.value=t}),this.vm.name.formControl.valueChanges.subscribe(t=>{this.vm.name.value=t})}load(t){return(0,p.mG)(this,void 0,void 0,function*(){this.zone.run(()=>{}),this.zone.run(()=>(0,p.mG)(this,void 0,void 0,function*(){try{console.log("BookingEditBookingsGroupComponent: received changes from parent",t.id,t);for(let n of Object.keys(t))this.group[n]=t[n];if(t.name&&this.vm.name.formControl.setValue(t.name),t.hasOwnProperty("price")&&(this.vm.price.value=t.price),t.rate_class_id){let n=yield this.api.read("sale\\customer\\RateClass",[t.rate_class_id],["id","name","description"]);if(n&&n.length){let t=n[0];this.rate_class=t,this.vm.rate_class.name=t.name}}if(t.pack_id){let n=yield this.api.read("lodging\\sale\\catalog\\Product",[t.pack_id],["id","name","sku"]);if(n&&n.length){let t=n[0];this.pack=t,this.vm.pack.name=t.name}}if(t.hasOwnProperty("has_pack")&&(this.vm.pack.has_pack=t.has_pack),t.hasOwnProperty("is_locked")&&(this.vm.pack.is_locked=t.is_locked),t.hasOwnProperty("nb_pers")&&this.vm.participants_count.formControl.setValue(t.nb_pers),t.sojourn_type&&(this.vm.sojourn_type.value=t.sojourn_type),t.date_from&&this.vm.daterange.start.formControl.setValue(t.date_from),t.date_to&&this.vm.daterange.end.formControl.setValue(t.date_to),t.booking_lines_ids){let n=yield this.loadLines(t.booking_lines_ids,this.model_fields.BookingLine);if(n){for(let[t,i]of n.entries())if(t>=this.lines.length){let t=new u.t(1);this._lineOutput.push(t),t.next(i),this.lines.push(i)}else if(JSON.stringify(this.lines[t])!=JSON.stringify(i)){let n=new u.t(1);this._lineOutput[t]=n,this.lines[t]=i,n.next(i)}this.lines.length>n.length&&(this.lines.splice(n.length),this._lineOutput.splice(n.length))}}if(t.accomodations_ids){let n=yield this.loadAccomodations(t.accomodations_ids,this.model_fields.Consumption);if(n){for(let[t,i]of n.entries())if(t>=this.accomodations.length){let t=new u.t(1);this._accomodationOutput.push(t),t.next(i),this.accomodations.push(i)}else if(JSON.stringify(this.accomodations[t])!=JSON.stringify(i)){let n=new u.t(1);this._accomodationOutput[t]=n,this.accomodations[t]=i,n.next(i)}this.accomodations.length>n.length&&(this.accomodations.splice(n.length),this._accomodationOutput.splice(n.length))}}}catch(n){console.warn(n)}this.ready=!0}))})}updateFromAccomodation(t){return(0,p.mG)(this,void 0,void 0,function*(){console.log("BookingEditBookingsGroupComponent: received changes from child",t);let n=!1;try{let i=this.lines.findIndex(n=>n.id==t.id),o=this.lines.find(n=>n.id==t.id);if(t.hasOwnProperty("rental_unit_id")&&t.rental_unit_id!=o.rental_unit_id&&(n=!0,yield this.updateRentalUnit(t)),n){let n=(yield this.loadAccomodations([t.id],this.model_fields.Consumption))[0];for(let t of Object.keys(n))this.accomodations[i][t]=n[t];this._accomodationOutput[i].next(this.accomodations[i]),this.snack.open("Logement mis \xe0 jour")}}catch(i){console.warn(i)}})}updateFromLine(t){return(0,p.mG)(this,void 0,void 0,function*(){console.log("BookingEditBookingsGroupComponent: received changes from child",t);try{let n=!1,i={},o=this.lines.findIndex(n=>n.id==t.id),e=this.lines.find(n=>n.id==t.id);if(t.hasOwnProperty("product_id")&&t.product_id!=e.product_id&&(yield this.updateProduct(t),n=!0,i.booking_id=["price"],i.self=["price"]),t.hasOwnProperty("qty")&&t.qty!=e.qty&&(yield this.updateQuantity(t),n=!0,i.booking_id=["price"],i.self=["price"]),t.hasOwnProperty("unit_price")&&t.qty!=e.qty&&(yield this.updateUnitPrice(t),n=!0,i.booking_id=["price"],i.self=["price"]),t.hasOwnProperty("vat_rate")&&t.qty!=e.qty&&(yield this.updateVatRate(t),n=!0,i.booking_id=["price"],i.self=["price"]),t.hasOwnProperty("price_adapters_ids")&&(n=!0,i.booking_id=["price"],i.self=["price"]),t.hasOwnProperty("refresh")){let n=this.model_fields.BookingLine;if(t.refresh.hasOwnProperty("self")){Array.isArray(t.refresh.self)&&(n=t.refresh.self);let i=yield this.loadLines([t.id],n);this._lineOutput[o].next(i[0])}t.refresh.hasOwnProperty("booking_line_group_id")&&(i.self=i.hasOwnPropertyKey("self")?[...i.self,...t.refresh.booking_line_group_id]:t.refresh.booking_line_group_id)}else if(n){let n=(yield this.loadLines([t.id],this.model_fields.BookingLine))[0];for(let t of Object.keys(n))this.lines[o][t]=n[t];this._lineOutput[o].next(this.lines[o]),this.snack.open("Regroupement mis \xe0 jour")}Object.keys(i).length&&this.groupOutput.next({id:this.group.id,refresh:i})}catch(n){console.warn("some changes could not be stored",n),this.snack.open("Erreur - certains changements n'ont pas pu \xeatre enregistr\xe9s.")}})}loadLines(t,n){return(0,p.mG)(this,void 0,void 0,function*(){return yield this.api.read("lodging\\sale\\booking\\BookingLine",t,n,"order")})}loadAccomodations(t,n){return(0,p.mG)(this,void 0,void 0,function*(){return yield this.api.read("lodging\\sale\\booking\\BookingLine",t,n)})}dateRangeUpdate(){let t=this.vm.daterange.start.formControl.value,n=this.vm.daterange.end.formControl.value;if(t&&n){let i=Math.floor((Date.parse(n.toString())-Date.parse(t.toString()))/864e5);this.vm.daterange.nights_count=i<0?0:i}}nbPersChange(){console.log("BookingEditCustomerComponent::nbPersChange"),this.groupOutput.next({id:this.group.id,nb_pers:this.vm.participants_count.value,refresh:{self:["price","booking_lines_ids"],booking_id:["price"]}})}nameChange(){console.log("BookingEditCustomerComponent::nameChange"),this.groupOutput.next({id:this.group.id,name:this.vm.name.value})}dateRangeChange(){console.log("BookingEditCustomerComponent::dateRangeChange"),this.groupOutput.next({id:this.group.id,date_from:this.vm.daterange.start.formControl.value,date_to:this.vm.daterange.end.formControl.value})}packChange(t,n){switch(console.log("BookingEditCustomerComponent::packChange",n),t){case"name":let t=n;this.pack=t,this.vm.pack.name=t.name,this.groupOutput.next({id:this.group.id,pack_id:t.id});break;case"has_pack":this.vm.pack.has_pack=n,!1===n&&(this.pack=null,this.vm.pack.name=""),this.groupOutput.next({id:this.group.id,has_pack:n});break;case"is_locked":this.vm.pack.is_locked=n,this.groupOutput.next({id:this.group.id,is_locked:n})}}packInputChange(t){this.vm.pack.inputClue.next(t.target.value)}packFocus(){this.vm.pack.inputClue.next("")}packDisplay(t){return t?t.name:""}packReset(){setTimeout(()=>{this.vm.pack.name=""},100)}packRestore(){this.vm.pack.name=this.pack?this.pack.name:""}sojournTypeChange(t){this.vm.sojourn_type.value=t.value,this.groupOutput.next({id:this.group.id,sojourn_type:this.vm.sojourn_type.value,refresh:{self:["price","booking_lines_ids"],booking_id:["price"]}})}rateClassChange(t){if(console.log("BookingEditCustomerComponent::rateClassChange",t),t&&t.option&&t.option.value){let n=t.option.value;this.rate_class=n,this.vm.rate_class.name=n.name,this.groupOutput.next({id:this.group.id,rate_class_id:n.id,refresh:{self:["price","booking_lines_ids"],booking_id:["price"]}})}}rateClassInputChange(t){this.vm.rate_class.inputClue.next(t.target.value)}rateClassFocus(){this.vm.rate_class.inputClue.next("")}rateClassDisplay(t){return t?t.name+" - "+t.description:""}rateClassReset(){setTimeout(()=>{this.vm.rate_class.name=""},100)}rateClassRestore(){this.vm.rate_class.name=this.rate_class?this.rate_class.name:""}filterPacks(t){return(0,p.mG)(this,void 0,void 0,function*(){let n=[];try{let i=[["name","ilike","%"+t+"%"],["is_pack","=","true"],["can_sell","=",!0]];this.center&&this.center.hasOwnProperty("product_groups_ids")&&this.center.product_groups_ids.length&&i.push(["groups_ids","contains",this.center.product_groups_ids[0]]),n=yield this.api.collect("lodging\\sale\\catalog\\Product",i,["id","name","sku"],"name","asc",0,25)}catch(i){console.log(i)}return n})}filterRateClasses(t){return(0,p.mG)(this,void 0,void 0,function*(){let n=[];try{n=yield this.api.collect("sale\\customer\\RateClass",[["name","ilike","%"+t+"%"]],["id","name","description"],"name","asc",0,25)}catch(i){console.log(i)}return n})}lineAdd(){return(0,p.mG)(this,void 0,void 0,function*(){try{const t=yield this.api.create("lodging\\sale\\booking\\BookingLine",{order:this.lines.length+1,booking_id:this.group.booking_id,booking_line_group_id:this.group.id});this.groupOutput.next({id:this.group.id,booking_lines_ids:[t.id]})}catch(t){console.log(t)}})}lineRemove(t){return(0,p.mG)(this,void 0,void 0,function*(){this.groupOutput.next({id:this.group.id,booking_lines_ids:[-t.id]})})}lineDrop(t){(0,h.bA)(this.lines,t.previousIndex,t.currentIndex),(0,h.bA)(this._lineOutput,t.previousIndex,t.currentIndex);for(let n in this.lines)this.updateFromLine({id:this.lines[n].id,order:parseInt(n)+1})}updateProduct(t){return(0,p.mG)(this,void 0,void 0,function*(){yield this.api.update("lodging\\sale\\booking\\BookingLine",[t.id],{product_id:t.product_id})})}updateQuantity(t){return(0,p.mG)(this,void 0,void 0,function*(){yield this.api.update("lodging\\sale\\booking\\BookingLine",[t.id],{qty:t.qty})})}updateUnitPrice(t){return(0,p.mG)(this,void 0,void 0,function*(){yield this.api.update("lodging\\sale\\booking\\BookingLine",[t.id],{unit_price:t.unit_price})})}updateVatRate(t){return(0,p.mG)(this,void 0,void 0,function*(){yield this.api.update("lodging\\sale\\booking\\BookingLine",[t.id],{vat_rate:t.vat_rate})})}updateRentalUnit(t){return(0,p.mG)(this,void 0,void 0,function*(){yield this.api.update("lodging\\sale\\booking\\BookingLine",[t.id],{rental_unit_id:t.rental_unit_id})})}}return t.\u0275fac=function(n){return new(n||t)(c.Y36(r.sM),c.Y36(r.Tq),c.Y36(l.uw),c.Y36(c.R0b),c.Y36(g.ux))},t.\u0275cmp=c.Xpm({type:t,selectors:[["booking-edit-bookings-group"]],inputs:{bookingInput:"bookingInput",groupOutput:"groupOutput",groupInput:"groupInput"},decls:48,vars:29,consts:[[3,"var"],["vGroup","var"],[1,"part"],[1,"part-toggle"],["mat-icon-button","",3,"click",4,"ngIf"],["class","part-container",4,"ngIf"],[1,"part-container"],[1,"row"],[1,"row-products-title"],["mat-mini-fab","","color","primary","style","transform: scale(0.65);",3,"click",4,"ngIf"],[1,"row-products-price"],[2,"width","100%"],[1,"products-header"],[2,"display","flex","width","100%","margin-bottom","6px"],[1,"product-cell",2,"text-align","left"],[1,"product-cell"],[1,"product-cell",2,"max-width","35px"],["cdkDropList","",1,"products-list",3,"cdkDropListDropped"],["class","product-item","cdkDrag","",3,"cdkDragData",4,"ngFor","ngForOf"],["mat-icon-button","",3,"click"],[2,"font-size","15px"],[1,"",2,"min-width","350px"],[1,"header"],["type","text","matInput","",3,"formControl","blur"],[4,"ngIf"],[1,"cell",2,"max-width","260px"],[3,"rangePicker"],["matStartDate","","placeholder","dd/mm/yyyy",3,"formControl","blur"],["matEndDate","","placeholder","dd/mm/yyyy",3,"formControl","blur"],["matSuffix","",3,"for"],[3,"closed"],["sojournDateRangePicker",""],[3,"align"],[1,"cell",2,"max-width","150px"],["type","number","matInput","",3,"value","formControl","blur"],[1,"cell",2,"max-width","350px"],["matInput","","type","text","placeholder","Commencez \xe0 taper le nom",3,"matAutocomplete","value","keyup","focus","blur"],["mat-button","","matSuffix","","mat-icon-button","","aria-label","Clear",3,"click",4,"ngIf"],[3,"displayWith","optionSelected"],["rateClassAutocomplete","matAutocomplete"],[2,"opacity","1",3,"align"],[1,"cell",2,"max-width","120px"],[3,"ngModel","selectionChange"],["value","GG"],["value","GA"],[1,"cell",2,"max-width","200px"],["floatLabel","always",1,"invisible"],["color","primary",3,"ngModel","change"],["matInput","","hidden",""],["class","cell","style","max-width: 350px;",4,"ngIf"],["class","cell",4,"ngIf"],["mat-button","","matSuffix","","mat-icon-button","","aria-label","Clear",3,"click"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["packAutocomplete","matAutocomplete"],[1,"cell"],[3,"ngModel","change"],["mat-mini-fab","","color","primary",2,"transform","scale(0.65)",3,"click"],["cdkDrag","",1,"product-item",3,"cdkDragData"],["cdkDragHandle","",1,"product-handle"],[2,"font-size","16px"],[1,"product-remove"],[3,"bookingInput","groupInput","lineInput","lineOutput"],[2,"margin-top","8px"],[1,"row",2,"display","block"],["class","accomodation-item",4,"ngFor","ngForOf"],[1,"accomodation-item"],[3,"groupInput","accomodationInput","accomodationOutput"]],template:function(t,n){if(1&t&&(c._UZ(0,"div",0,1),c.TgZ(2,"div"),c.TgZ(3,"div",2),c.TgZ(4,"div",3),c.YNc(5,ft,3,0,"button",4),c.YNc(6,vt,3,0,"button",4),c.qZA(),c.YNc(7,kt,31,12,"div",5),c.YNc(8,Ut,62,24,"div",5),c.qZA(),c.TgZ(9,"div",2),c.TgZ(10,"div",3),c.YNc(11,Nt,3,0,"button",4),c.YNc(12,Qt,3,0,"button",4),c.qZA(),c.TgZ(13,"div",6),c.TgZ(14,"div",7),c.TgZ(15,"div",8),c._uU(16),c.YNc(17,Yt,3,0,"button",9),c.qZA(),c.TgZ(18,"div",10),c._uU(19),c.ALo(20,"number"),c.qZA(),c.qZA(),c.TgZ(21,"div",7),c.TgZ(22,"div",11),c.TgZ(23,"div",12),c.TgZ(24,"div",13),c.TgZ(25,"div",14),c._uU(26,"SKU"),c.qZA(),c.TgZ(27,"div",15),c._uU(28,"QT\xc9"),c.qZA(),c.TgZ(29,"div",15),c._uU(30,"GT\xc9"),c.qZA(),c.TgZ(31,"div",15),c._uU(32,"P.U."),c.qZA(),c.TgZ(33,"div",15),c._uU(34,"R\xc9DUC"),c.qZA(),c.TgZ(35,"div",15),c._uU(36,"TAX"),c.qZA(),c.TgZ(37,"div",15),c._uU(38,"PRIX"),c.qZA(),c._UZ(39,"div",16),c.qZA(),c.qZA(),c.TgZ(40,"div",17),c.NdJ("cdkDropListDropped",function(t){return n.vm.lines.drop(t)}),c.YNc(41,Dt,7,6,"div",18),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.TgZ(42,"div",2),c.TgZ(43,"div",3),c.YNc(44,Lt,3,0,"button",4),c.YNc(45,Bt,3,0,"button",4),c.qZA(),c.YNc(46,Et,4,0,"div",5),c.YNc(47,jt,6,1,"div",5),c.qZA(),c.qZA()),2&t){const t=c.MAs(1);c.Q6J("var",c.kEZ(25,Rt,c.DdM(22,Ht),c.DdM(23,Ht),c.DdM(24,Ht))),c.xp6(2),c.ekj("hidden",!n.ready),c.xp6(3),c.Q6J("ngIf",!t.identification.folded),c.xp6(1),c.Q6J("ngIf",t.identification.folded),c.xp6(1),c.Q6J("ngIf",t.identification.folded),c.xp6(1),c.Q6J("ngIf",!t.identification.folded),c.xp6(3),c.Q6J("ngIf",!t.products.folded),c.xp6(1),c.Q6J("ngIf",t.products.folded),c.xp6(4),c.hij("Produits (",n.lines.length,") "),c.xp6(1),c.Q6J("ngIf",!n.vm.pack.is_locked),c.xp6(2),c.hij("TOTAL TTC \xa0:\xa0 ",c.xi3(20,19,n.vm.price.value,"1.2-2")," \u20ac"),c.xp6(2),c.ekj("hidden",t.products.folded),c.xp6(20),c.Q6J("ngForOf",n.lines),c.xp6(3),c.Q6J("ngIf",!t.accomodations.folded),c.xp6(1),c.Q6J("ngIf",t.accomodations.folded),c.xp6(1),c.Q6J("ngIf",t.accomodations.folded),c.xp6(1),c.Q6J("ngIf",!t.accomodations.folded)}},directives:[r.gC,f.O5,h.Wj,f.sg,m.lW,_.Hw,x.KE,x.hX,O.Nt,v.Fj,v.JJ,v.oH,x.bx,y.wx,y.zY,y.By,y.nW,x.R9,y._g,v.wV,x.TO,P.ZL,P.XC,M.gD,v.On,o.ey,A.Rr,h.Zt,h.Bh,ut,_t],pipes:[f.JJ,f.Ov],styles:["[_nghost-%COMP%]{display:block;width:100%;height:100%;padding-top:10px}[_nghost-%COMP%]   .hidden[_ngcontent-%COMP%]{display:none!important}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]{display:flex}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-toggle[_ngcontent-%COMP%]{flex:0 1;display:inline-block;vertical-align:top;padding:5px 0 0 20px}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]{flex:1;display:inline-block;width:100%;min-height:45px}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]{width:100%;display:flex;padding:5px 0;flex:1}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .row-products-title[_ngcontent-%COMP%]{flex:0 1 50%;height:40px;line-height:40px}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .row-products-price[_ngcontent-%COMP%]{flex:0 1 20%;margin-left:auto;text-align:right;margin-right:65px}[_nghost-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .cell[_ngcontent-%COMP%]{flex:1}[_nghost-%COMP%]   mat-form-field[_ngcontent-%COMP%]{width:100%;padding:0 12px}[_nghost-%COMP%]   mat-form-field.header[_ngcontent-%COMP%]{margin-top:-5px}[_nghost-%COMP%]   mat-form-field.header[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{font-size:22px}[_nghost-%COMP%]   mat-form-field.invisible[_ngcontent-%COMP%]    .mat-form-field-underline{display:none!important}[_nghost-%COMP%]   p[_ngcontent-%COMP%]{font-size:14px;padding:0 12px}[_nghost-%COMP%]   .products-header[_ngcontent-%COMP%]{padding:0 12px 0 0;width:100%;margin-bottom:1px}[_nghost-%COMP%]   .products-header[_ngcontent-%COMP%]   .product-cell[_ngcontent-%COMP%]{font-weight:600;outline:1px solid #0003;line-height:34px;position:relative;flex:1 0 8%;text-align:right;padding:0 10px;margin-right:15px;white-space:nowrap;text-overflow:ellipsis;overflow:hidden}[_nghost-%COMP%]   .products-header[_ngcontent-%COMP%]   .product-cell[_ngcontent-%COMP%]:last-child{outline:none}[_nghost-%COMP%]   .products-header[_ngcontent-%COMP%]   .product-cell[_ngcontent-%COMP%]:first-child{flex:1 0 40%}[_nghost-%COMP%]   .products-list[_ngcontent-%COMP%]{position:relative;padding:0 12px 0 0;width:100%}[_nghost-%COMP%]   .products-list[_ngcontent-%COMP%]   .product-item[_ngcontent-%COMP%]{position:relative;background-color:#fff}[_nghost-%COMP%]   .products-list[_ngcontent-%COMP%]   .product-item[_ngcontent-%COMP%]   .product-handle[_ngcontent-%COMP%]{position:absolute;top:10px;left:5px;z-index:3}[_nghost-%COMP%]   .products-list[_ngcontent-%COMP%]   .product-item[_ngcontent-%COMP%]   .product-remove[_ngcontent-%COMP%]{position:absolute;right:-5px;top:10px;z-index:2}.cdk-drag-preview[_ngcontent-%COMP%]{box-sizing:border-box;border-radius:4px;box-shadow:0 5px 5px -3px #0003,0 8px 10px 1px #00000024,0 3px 14px 2px #0000001f;background-color:#d3d3d3!important}.cdk-drag-preview[_ngcontent-%COMP%]   .product-handle[_ngcontent-%COMP%], .cdk-drag-preview[_ngcontent-%COMP%]   .product-remove[_ngcontent-%COMP%]{display:none}.cdk-drag-placeholder[_ngcontent-%COMP%]{opacity:0}"]}),t})();function St(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"div",10),c.TgZ(1,"div",11),c.TgZ(2,"mat-icon",12),c._uU(3,"drag_indicator"),c.qZA(),c.qZA(),c.TgZ(4,"div",13),c.TgZ(5,"button",14),c.NdJ("click",function(){const n=c.CHM(t).$implicit;return c.oxw(2).vm.groups.remove(n)}),c.TgZ(6,"mat-icon"),c._uU(7,"delete"),c.qZA(),c.qZA(),c.qZA(),c._UZ(8,"booking-edit-bookings-group",15),c.qZA()}if(2&t){const t=n.$implicit,i=n.index,o=c.oxw(2);c.Q6J("cdkDragData",t),c.xp6(8),c.Q6J("bookingInput",o.bookingInput)("groupInput",o._groupOutput[i])("groupOutput",o._groupInput)}}function $t(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"div",7),c.TgZ(1,"div",8),c.NdJ("cdkDropListDropped",function(n){return c.CHM(t),c.oxw().vm.groups.drop(n)}),c.YNc(2,St,9,4,"div",9),c.qZA(),c.qZA()}if(2&t){const t=c.oxw();c.xp6(2),c.Q6J("ngForOf",t.groups)}}let Vt=(()=>{class t{constructor(t,n,i,o){this.api=t,this.auth=n,this.zone=i,this.snack=o,this._groupInput=new u.t(1),this._groupOutput=[],this.model_fields={BookingLineGroup:["id","booking_id","name","order","has_pack","pack_id","price","is_locked","date_from","date_to","sojourn_type","nb_pers","rate_class_id","booking_lines_ids","accomodations_ids"]},this.booking={},this.center=null,this.customer=null,this.groups=[],this.vm={price:{value:0},groups:{add:()=>this.groupAdd(),remove:t=>this.groupRemove(t),drop:t=>this.groupDrop(t)}}}ngOnInit(){this.bookingInput.subscribe(t=>(0,p.mG)(this,void 0,void 0,function*(){return this.load(t)})),this._groupInput.subscribe(t=>this.updateFromGroup(t))}load(t){return(0,p.mG)(this,void 0,void 0,function*(){this.zone.run(()=>(0,p.mG)(this,void 0,void 0,function*(){try{console.log("BookingEditBookingsComponent: received changes from parent",t);for(let n of Object.keys(t))this.booking[n]=t[n];if(t.hasOwnProperty("price")&&(this.vm.price.value=t.price),t.booking_lines_groups_ids&&t.booking_lines_groups_ids.length){let n=yield this.loadGroups(t.booking_lines_groups_ids,this.model_fields.BookingLineGroup);if(n){for(let[t,i]of n.entries())if(t>=this.groups.length){let t=new u.t(1);this._groupOutput.push(t),t.next(i),this.groups.push(i)}else if(JSON.stringify(this.groups[t])!=JSON.stringify(i)){let n=new u.t(1);this._groupOutput[t]=n,this.groups[t]=i,n.next(i)}this.groups.length>n.length&&(this.groups.splice(n.length),this._groupOutput.splice(n.length))}}if(t.center_id){let n=yield this.api.read("lodging\\identity\\Center",[t.center_id],["id","name","code","organisation_id","discount_list_category_id"]);n&&n.length&&(this.center=n[0])}if(t.customer_id){let n=yield this.api.read("sale\\customer\\Customer",[t.customer_id],["id","name","rate_class_id"]);n&&n.length&&(this.customer=n[0])}}catch(n){console.warn(n)}}))})}loadGroups(t,n){return(0,p.mG)(this,void 0,void 0,function*(){return yield this.api.read("lodging\\sale\\booking\\BookingLineGroup",t,n,"order")})}groupAdd(){return(0,p.mG)(this,void 0,void 0,function*(){console.log("group add");try{let t=4;this.customer&&this.customer.rate_class_id&&(t=this.customer.rate_class_id);const n=yield this.api.create("lodging\\sale\\booking\\BookingLineGroup",{name:"S\xe9jour "+this.center.name,order:this.groups.length+1,booking_id:this.booking.id,rate_class_id:t,sojourn_type:this.center.discount_list_category_id});let i=yield this.loadGroups([n.id],this.model_fields.BookingLineGroup),o=new u.t(1);this._groupOutput.push(o),this.groups.push(i[0]),o.next(i[0])}catch(t){console.log(t)}})}groupRemove(t){return(0,p.mG)(this,void 0,void 0,function*(){try{yield this.api.remove("lodging\\sale\\booking\\BookingLineGroup",[t.id],!0);let n=this.groups.findIndex(n=>n.id==t.id);this.groups.splice(n,1),this._groupOutput.splice(n,1)}catch(n){console.warn(n)}})}groupDrop(t){console.log(t.previousIndex,t.currentIndex),(0,h.bA)(this.groups,t.previousIndex,t.currentIndex),(0,h.bA)(this._groupOutput,t.previousIndex,t.currentIndex);for(let n in this.groups)this.updateFromGroup({id:this.groups[n].id,order:parseInt(n)+1})}updateFromGroup(t){return(0,p.mG)(this,void 0,void 0,function*(){console.log("BookingEditBookingsComponent: received changes from child",t);try{let n=this.groups.findIndex(n=>n.id==t.id),i=this.groups.find(n=>n.id==t.id),o=!1,e=[];if(t.hasOwnProperty("name")&&t.name!=i.name&&(yield this.updateName(t),o=!0),t.hasOwnProperty("pack_id")&&t.pack_id!=i.pack_id&&(yield this.updatePack(t),e.push("price"),o=!0),t.hasOwnProperty("rate_class_id")&&t.rate_class_id!=i.rate_class_id&&(yield this.updateRateClass(t),o=!0),t.hasOwnProperty("is_locked")&&t.is_locked!=i.is_locked&&(yield this.updateIsLocked(t),e.push("price"),o=!0),t.hasOwnProperty("has_pack")&&t.has_pack!=i.has_pack&&(yield this.updateHasPack(t),o=!0),(t.hasOwnProperty("date_from")&&t.date_from!=i.date_from||t.hasOwnProperty("date_to")&&t.date_to!=i.date_to)&&(yield this.updateDate(t),e.push("price"),o=!0),t.hasOwnProperty("nb_pers")&&t.nb_pers!=i.nb_pers&&(yield this.updateNbPers(t),e.push("price"),o=!0),t.hasOwnProperty("sojourn_type")&&t.sojourn_type!=i.sojourn_type&&(yield this.updateSojournType(t),e.push("price"),o=!0),t.hasOwnProperty("order")&&t.order!=i.order&&(yield this.updateOrder(t),o=!0),t.hasOwnProperty("booking_lines_ids")&&t.booking_lines_ids.filter(t=>-1===i.booking_lines_ids.indexOf(t)).length&&(yield this.updateBookingLinesIds(t),o=!0),t.hasOwnProperty("refresh")){let i=this.model_fields.BookingLineGroup;if(t.refresh.hasOwnProperty("self")){Array.isArray(t.refresh.self)&&(i=t.refresh.self);let o=yield this.loadGroups([t.id],i);this._groupOutput[n].next(o[0])}t.refresh.hasOwnProperty("booking_id")&&(e=[...e,...t.refresh.booking_id])}else if(o){let i=(yield this.loadGroups([t.id],this.model_fields.BookingLineGroup))[0];for(let t of Object.keys(i))this.groups[n][t]=i[t];this._groupOutput[n].next(this.groups[n]),this.snack.open("Regroupement mis \xe0 jour")}e.length&&this.bookingOutput.next({id:this.booking.id,refresh:e})}catch(n){console.warn("some changes could not be stored",n);let t="unknonw";if(n&&n.hasOwnProperty("error")&&n.error.hasOwnProperty("errors")){let i=n.error.errors;i.hasOwnProperty("INVALID_PARAM")?t="invalid_param":i.hasOwnProperty("NOT_ALLOWED")?t="not_allowed":i.hasOwnProperty("CONFLICT_OBJECT")&&(t="conflict_object")}switch(t){case"not_allowed":this.snack.open("Erreur - Vous n'avez pas les autorisations pour cette op\xe9ration.");break;case"conflict_object":this.snack.open("Erreur - Cette r\xe9servation a \xe9t\xe9 modifi\xe9e par un autre utilisateur.");break;case"unknonw":case"invalid_param":default:this.snack.open("Erreur - certains changements n'ont pas pu \xeatre enregistr\xe9s.")}}})}updateName(t){return(0,p.mG)(this,void 0,void 0,function*(){console.log("BookingEditBookingsComponent::updateName",t),yield this.api.update("lodging\\sale\\booking\\BookingLineGroup",[t.id],{name:t.name})})}updatePack(t){return(0,p.mG)(this,void 0,void 0,function*(){console.log("BookingEditBookingsComponent::updatePack",t),yield this.api.update("lodging\\sale\\booking\\BookingLineGroup",[t.id],{pack_id:t.pack_id}),this.groups.find(n=>n.id==t.id).pack_id=t.pack_id})}updateRateClass(t){return(0,p.mG)(this,void 0,void 0,function*(){console.log("BookingEditBookingsComponent::updateRateClass",t),yield this.api.update("lodging\\sale\\booking\\BookingLineGroup",[t.id],{rate_class_id:t.rate_class_id}),this.groups.find(n=>n.id==t.id).rate_class_id=t.rate_class_id})}updateHasPack(t){return(0,p.mG)(this,void 0,void 0,function*(){console.log("BookingEditBookingsComponent::updateHasPack",t),yield this.api.update("lodging\\sale\\booking\\BookingLineGroup",[t.id],{has_pack:t.has_pack}),this.groups.find(n=>n.id==t.id).has_pack=t.has_pack})}updateNbPers(t){return(0,p.mG)(this,void 0,void 0,function*(){console.log("BookingEditBookingsComponent::updateNbPers",t),yield this.api.update("lodging\\sale\\booking\\BookingLineGroup",[t.id],{nb_pers:t.nb_pers}),this.groups.find(n=>n.id==t.id).nb_pers=t.nb_pers})}updateSojournType(t){return(0,p.mG)(this,void 0,void 0,function*(){console.log("BookingEditBookingsComponent::updateSojournType",t),yield this.api.update("lodging\\sale\\booking\\BookingLineGroup",[t.id],{sojourn_type:t.sojourn_type}),this.groups.find(n=>n.id==t.id).sojourn_type=t.sojourn_type})}updateOrder(t){return(0,p.mG)(this,void 0,void 0,function*(){console.log("BookingEditBookingsComponent::updateOrder",t),yield this.api.update("lodging\\sale\\booking\\BookingLineGroup",[t.id],{order:t.order}),this.groups.find(n=>n.id==t.id).order=t.order})}updateIsLocked(t){return(0,p.mG)(this,void 0,void 0,function*(){console.log("BookingEditBookingsComponent::updateIsLocked",t),yield this.api.update("lodging\\sale\\booking\\BookingLineGroup",[t.id],{is_locked:t.is_locked})})}updateDate(t){return(0,p.mG)(this,void 0,void 0,function*(){if(console.log("BookingEditBookingsComponent::updateDate",t),t.date_from&&t.date_to){yield this.api.update("lodging\\sale\\booking\\BookingLineGroup",[t.id],{date_from:t.date_from,date_to:t.date_to});let n=this.groups.find(n=>n.id==t.id);n.date_from=t.date_from,n.date_to=t.date_to}else t.date_from?(yield this.api.update("lodging\\sale\\booking\\BookingLineGroup",[t.id],{date_from:t.date_from}),this.groups.find(n=>n.id==t.id).date_from=t.date_from):(yield this.api.update("lodging\\sale\\booking\\BookingLineGroup",[t.id],{date_to:t.date_to}),this.groups.find(n=>n.id==t.id).date_to=t.date_to)})}updateBookingLinesIds(t){return(0,p.mG)(this,void 0,void 0,function*(){yield this.api.update("lodging\\sale\\booking\\BookingLineGroup",[t.id],{booking_lines_ids:t.booking_lines_ids})})}}return t.\u0275fac=function(n){return new(n||t)(c.Y36(r.sM),c.Y36(r.Tq),c.Y36(c.R0b),c.Y36(g.ux))},t.\u0275cmp=c.Xpm({type:t,selectors:[["booking-edit-bookings"]],inputs:{bookingInput:"bookingInput",bookingOutput:"bookingOutput"},decls:12,vars:5,consts:[[1,"container"],[1,"outer-wrapper",2,"width","100%"],[1,"header",2,"display","flex","width","100%"],[2,"flex","1"],["mat-mini-fab","","color","primary",2,"transform","scale(0.65)",3,"click"],[2,"margin-left","auto","font-size","20px"],["class","inner-wrapper",4,"ngIf"],[1,"inner-wrapper"],["cdkDropList","",1,"groups-list",3,"cdkDropListDropped"],["class","group-item","cdkDrag","",3,"cdkDragData",4,"ngFor","ngForOf"],["cdkDrag","",1,"group-item",3,"cdkDragData"],["cdkDragHandle","",1,"group-handle"],[2,"font-size","16px"],[1,"group-remove"],["mat-icon-button","",3,"click"],[3,"bookingInput","groupInput","groupOutput"]],template:function(t,n){1&t&&(c.TgZ(0,"div",0),c.TgZ(1,"div",1),c.TgZ(2,"div",2),c.TgZ(3,"div",3),c._uU(4,"Ajouter un s\xe9jour "),c.TgZ(5,"button",4),c.NdJ("click",function(){return n.vm.groups.add()}),c.TgZ(6,"mat-icon"),c._uU(7,"add"),c.qZA(),c.qZA(),c.qZA(),c.TgZ(8,"div",5),c._uU(9),c.ALo(10,"number"),c.qZA(),c.qZA(),c.YNc(11,$t,3,1,"div",6),c.qZA(),c.qZA()),2&t&&(c.xp6(9),c.hij("Total TTC ",c.xi3(10,2,n.vm.price.value,"1.2-2")," \u20ac"),c.xp6(2),c.Q6J("ngIf",n.groups.length))},directives:[m.lW,_.Hw,f.O5,h.Wj,f.sg,h.Zt,h.Bh,zt],pipes:[f.JJ],styles:["[_nghost-%COMP%]{width:100%;height:100%}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]{display:flex;height:100%;width:100%}[_nghost-%COMP%]   .inner-wrapper[_ngcontent-%COMP%]{border:1px solid #d3d3d3}[_nghost-%COMP%]   .group-item[_ngcontent-%COMP%]{position:relative;margin:12px;padding-bottom:12px;background-color:#0000000a}[_nghost-%COMP%]   .group-item[_ngcontent-%COMP%]   .group-handle[_ngcontent-%COMP%]{position:absolute;top:10px;left:5px;z-index:3}[_nghost-%COMP%]   .group-item[_ngcontent-%COMP%]   .group-remove[_ngcontent-%COMP%]{position:absolute;right:10px;top:10px}.cdk-drag-preview[_ngcontent-%COMP%]{box-sizing:border-box;border-radius:4px;box-shadow:0 5px 5px -3px #0003,0 8px 10px 1px #00000024,0 3px 14px 2px #0000001f;background-color:#d3d3d3!important}.cdk-drag-preview[_ngcontent-%COMP%]   .group-handle[_ngcontent-%COMP%], .cdk-drag-preview[_ngcontent-%COMP%]   .group-remove[_ngcontent-%COMP%]{display:none}.cdk-drag-placeholder[_ngcontent-%COMP%]{opacity:0}"]}),t})();class Wt{constructor(t=0,n="",i=new Date,o=0,e="",s=0,r=!1,a=0,c=0,d=0,p="",u=[],l=[]){this.id=t,this.name=n,this.created=i,this.price=o,this.status=e,this.customer_id=s,this.has_payer_organisation=r,this.payer_organisation_id=a,this.center_id=c,this.type_id=d,this.description=p,this.contacts_ids=u,this.booking_lines_groups_ids=l}}let Xt=(()=>{class t{constructor(t,n,i,o,e,s,r){this.auth=t,this.api=n,this.router=i,this.dialog=o,this.route=e,this.snack=s,this.zone=r,this.booking=new Wt,this.id=0,this._bookingInput=new u.t(1),this._bookingOutput=new u.t(1),this.showSbContainer=!1}ngAfterViewInit(){$("#sb-booking-container").on("_close",(t,n)=>{this.zone.run(()=>{this.showSbContainer=!1})}),$("#sb-booking-container").on("_open",(t,n)=>{this.zone.run(()=>{this.showSbContainer=!0})})}ngOnInit(){this._bookingInput.subscribe(t=>this.update(t)),this.route.params.subscribe(t=>(0,p.mG)(this,void 0,void 0,function*(){if(t&&t.hasOwnProperty("id")){this.id=t.id;try{let t=yield this.load(Object.getOwnPropertyNames(new Wt));this.booking=new Wt(t.id,t.name,new Date(t.created),t.price,t.status,t.customer_id,t.has_payer_organisation,t.payer_organisation_id,t.center_id,t.type_id,t.description,t.contacts_ids,t.booking_lines_groups_ids),this._bookingOutput.next(this.booking)}catch(n){console.warn(n)}}}))}load(t){return(0,p.mG)(this,void 0,void 0,function*(){const n=yield this.api.read("lodging\\sale\\booking\\Booking",[this.id],t);return n&&n.length?n[0]:{}})}update(t){return(0,p.mG)(this,void 0,void 0,function*(){console.log("BookingEditComponent: received change",t,this.booking);try{if(t.hasOwnProperty("refresh")){let n=Object.getOwnPropertyNames(new Wt);Array.isArray(t.refresh)&&(n=t.refresh);let i=yield this.load(n);return this.booking=new Wt(i.id,i.name,new Date(i.created),i.price,i.customer_id,i.has_payer_organisation,i.payer_organisation_id,i.center_id,i.type_id,i.description,i.contacts_ids,i.booking_lines_groups_ids),void this._bookingOutput.next(i)}let n=!1;if(t.hasOwnProperty("customer_id")&&t.customer_id!=this.booking.customer_id&&(yield this.updateCustomer(t.customer_id),n=!0),(t.hasOwnProperty("payer_organisation_id")&&t.payer_organisation_id!=this.booking.payer_organisation_id||t.hasOwnProperty("has_payer_organisation")&&t.has_payer_organisation!=this.booking.has_payer_organisation)&&(yield this.updatePayer(t.payer_organisation_id),n=!0),t.hasOwnProperty("center_id")&&t.center_id!=this.booking.center_id&&(yield this.updateCenter(t.center_id),n=!0),t.hasOwnProperty("type_id")&&t.type_id!=this.booking.type_id&&(yield this.updateType(t.type_id),n=!0),t.hasOwnProperty("description")&&t.description!=this.booking.description&&(yield this.updateDescription(t.description),n=!0),t.hasOwnProperty("contacts_ids")&&t.contacts_ids.length!=this.booking.contacts_ids.length&&(this.booking.contacts_ids=t.contacts_ids,n=!0),t.hasOwnProperty("booking_lines_groups_ids")&&t.booking_lines_groups_ids.length!=this.booking.booking_lines_groups_ids.length&&(this.booking.booking_lines_groups_ids=t.booking_lines_groups_ids,n=!0),n){let t=yield this.load(Object.getOwnPropertyNames(new Wt));for(let n of Object.keys(t))this.booking[n]=t[n];this._bookingOutput.next(this.booking),this.snack.open("R\xe9servation mise \xe0 jour")}}catch(n){console.warn("some changes could not be stored",n);let t="unknonw";if(n&&n.hasOwnProperty("error")&&n.error.hasOwnProperty("errors")){let i=n.error.errors;i.hasOwnProperty("INVALID_PARAM")?t="invalid_param":i.hasOwnProperty("NOT_ALLOWED")?t="not_allowed":i.hasOwnProperty("CONFLICT_OBJECT")&&(t="conflict_object")}switch(t){case"not_allowed":this.snack.open("Erreur - Vous n'avez pas les autorisations pour cette op\xe9ration.");break;case"conflict_object":this.snack.open("Erreur - Cette r\xe9servation a \xe9t\xe9 modifi\xe9e par un autre utilisateur.");break;case"unknonw":case"invalid_param":default:this.snack.open("Erreur - certains changements n'ont pas pu \xeatre enregistr\xe9s.")}}})}updateCustomer(t){return(0,p.mG)(this,void 0,void 0,function*(){console.log("BookingEditComponent::updateCustomer",t),yield this.api.update("lodging\\sale\\booking\\Booking",[this.id],{customer_id:t})})}updateDescription(t){return(0,p.mG)(this,void 0,void 0,function*(){console.log("BookingEditComponent::updateDescription",t),yield this.api.update("lodging\\sale\\booking\\Booking",[this.id],{description:t})})}updatePayer(t){return(0,p.mG)(this,void 0,void 0,function*(){console.log("BookingEditComponent::updatePayer",t);let n={};t<=0?(n.has_payer_organisation=!1,n.payer_organisation_id=0):(n.has_payer_organisation=!0,n.payer_organisation_id=t),yield this.api.update("lodging\\sale\\booking\\Booking",[this.id],n)})}updateCenter(t){return(0,p.mG)(this,void 0,void 0,function*(){console.log("BookingEditComponent::updateCenter",t),yield this.api.update("lodging\\sale\\booking\\Booking",[this.id],{center_id:t})})}updateType(t){return(0,p.mG)(this,void 0,void 0,function*(){console.log("BookingEditComponent::updateType",t),yield this.api.update("lodging\\sale\\booking\\Booking",[this.id],{type_id:t})})}}return t.\u0275fac=function(n){return new(n||t)(c.Y36(r.Tq),c.Y36(r.sM),c.Y36(a.F0),c.Y36(l.uw),c.Y36(a.gz),c.Y36(g.ux),c.Y36(c.R0b))},t.\u0275cmp=c.Xpm({type:t,selectors:[["booking-edit"]],decls:14,vars:5,consts:[[1,"container"],[1,"booking-header"],[1,"booking-body"],[2,"height","46px","margin-top","10px","display","flex"],[2,"flex","0 1 50%"],[2,"margin-left","auto"],[2,"line-height","40px"],[3,"bookingInput","bookingOutput"],["id","sb-booking-container",1,"sb-container"]],template:function(t,n){1&t&&(c.TgZ(0,"div",0),c.TgZ(1,"div",1),c._uU(2,"\xc9dition r\xe9servation"),c.qZA(),c.TgZ(3,"div",2),c.TgZ(4,"div",3),c._UZ(5,"div",4),c.TgZ(6,"div",5),c.TgZ(7,"span",6),c._uU(8,"Statut de la r\xe9servation: "),c.TgZ(9,"strong"),c._uU(10),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.TgZ(11,"div"),c._UZ(12,"booking-edit-bookings",7),c.qZA(),c.qZA(),c.qZA(),c._UZ(13,"div",8)),2&t&&(c.ekj("hidden",n.showSbContainer),c.xp6(10),c.Oqu(n.booking.status),c.xp6(2),c.Q6J("bookingInput",n._bookingOutput)("bookingOutput",n._bookingInput))},directives:[Vt],styles:["[_nghost-%COMP%]{width:100%;height:100%;overflow:hidden;box-sizing:border-box}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]{height:100%;width:100%}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]   .booking-header[_ngcontent-%COMP%]{width:100%;padding-left:12px;height:48px;line-height:48px;border-bottom:1px solid #d3d3d3;font-size:22px}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]   .booking-body[_ngcontent-%COMP%]{height:calc(100vh - 123px);width:100%;overflow-y:scroll;padding:0 12px}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]   .booking-body[_ngcontent-%COMP%]     mat-tab-group .mat-tab-header{margin-bottom:20px}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]   .booking-body[_ngcontent-%COMP%]::-webkit-scrollbar{width:6px;overflow-y:scroll;background:#0000}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]   .booking-body[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:var(--mdc-theme-primary,#6200ee);border-radius:10px}[_nghost-%COMP%]   .container.hidden[_ngcontent-%COMP%]{display:none}"]}),t})();var Kt=i(5939),tn=i(4885);function nn(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",9),c.NdJ("click",function(){c.CHM(t);const n=c.oxw().index;c.oxw();const i=c.MAs(1);return i.items[n]=!i.items[n]}),c.TgZ(1,"mat-icon",18),c._uU(2,"keyboard_arrow_right"),c.qZA(),c.qZA()}}function on(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"button",9),c.NdJ("click",function(){c.CHM(t);const n=c.oxw().index;c.oxw();const i=c.MAs(1);return i.items[n]=!i.items[n]}),c.TgZ(1,"mat-icon",18),c._uU(2,"keyboard_arrow_up"),c.qZA(),c.qZA()}}function en(t,n){1&t&&(c.TgZ(0,"div"),c._uU(1,"Voir le listing"),c.qZA())}function sn(t,n){if(1&t&&(c.TgZ(0,"div",27),c.TgZ(1,"div",28),c._uU(2),c.qZA(),c.qZA()),2&t){const t=c.oxw(4);c.xp6(2),c.Oqu(t.selection.length>0?t.selection.length:1)}}function rn(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"div",23),c.NdJ("click",function(n){const i=c.CHM(t).$implicit;return c.oxw(3).onToggle(n,i)})("cdkDragStarted",function(n){return c.CHM(t),c.oxw(3).onDragStart(n)}),c.YNc(1,sn,3,1,"div",24),c.TgZ(2,"div",25),c._uU(3),c.qZA(),c.TgZ(4,"div",25),c._uU(5),c.qZA(),c.TgZ(6,"div",25),c._uU(7),c.qZA(),c.TgZ(8,"div",25),c._uU(9),c.qZA(),c.TgZ(10,"div",26),c.TgZ(11,"button",9),c.NdJ("click",function(){const n=c.CHM(t).$implicit;return c.oxw(3).onOpenCompositionItem(n.id)}),c.TgZ(12,"mat-icon"),c._uU(13,"open_in_new"),c.qZA(),c.qZA(),c.qZA(),c.qZA()}if(2&t){const t=n.$implicit,i=n.index,o=c.oxw(3);c.ekj("selected",t.selected)("dragging",o.dragging),c.Q6J("cdkDragDisabled",!t.selected),c.xp6(3),c.hij("",i+1,"."),c.xp6(2),c.Oqu(t.firstname),c.xp6(2),c.Oqu(t.lastname),c.xp6(2),c.Oqu(t.gender)}}function an(t,n){if(1&t&&(c.TgZ(0,"div",19),c.TgZ(1,"div",20),c.TgZ(2,"div",21),c._uU(3,"#"),c.qZA(),c.TgZ(4,"div",21),c._uU(5,"Nom"),c.qZA(),c.TgZ(6,"div",21),c._uU(7,"Pr\xe9nom"),c.qZA(),c.TgZ(8,"div",21),c._uU(9,"Genre"),c.qZA(),c._UZ(10,"div",21),c.qZA(),c.YNc(11,rn,14,9,"div",22),c.qZA()),2&t){const t=c.oxw().$implicit,n=c.oxw();c.xp6(11),c.Q6J("ngForOf",n.composition_items[t.id])}}function cn(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"tr"),c.TgZ(1,"td"),c.TgZ(2,"div",6),c.TgZ(3,"div",7),c._uU(4),c.qZA(),c.TgZ(5,"div",8),c.TgZ(6,"button",9),c.NdJ("click",function(){const n=c.CHM(t).$implicit;return c.oxw().onOpenRentalUnit(n.id)}),c.TgZ(7,"mat-icon"),c._uU(8,"open_in_new"),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c.TgZ(9,"td",10),c.TgZ(10,"div",11),c._uU(11),c.qZA(),c.qZA(),c.TgZ(12,"td"),c.TgZ(13,"div",12),c.TgZ(14,"div",13),c.YNc(15,nn,3,0,"button",14),c.YNc(16,on,3,0,"button",14),c.qZA(),c.TgZ(17,"div",15),c.NdJ("cdkDropListDropped",function(n){return c.CHM(t),c.oxw().onDrop(n)}),c.YNc(18,en,2,0,"div",16),c.YNc(19,an,12,1,"div",17),c.qZA(),c.qZA(),c.qZA(),c.qZA()}if(2&t){const t=n.$implicit,i=n.index,o=c.oxw(),e=c.MAs(1);c.xp6(4),c.lnq("",t.name,", ",t.code," (",t.capacity,")"),c.xp6(7),c.Oqu(o.composition_items[t.id].length),c.xp6(4),c.Q6J("ngIf",!e.items[i]),c.xp6(1),c.Q6J("ngIf",e.items[i]),c.xp6(1),c.s9C("id",t.id),c.Q6J("cdkDropListData",t.id),c.xp6(1),c.Q6J("ngIf",!e.items[i]),c.xp6(1),c.Q6J("ngIf",e.items[i])}}const dn=function(){return[]},pn=function(t){return{items:t}};class un{constructor(t=0,n=0){this.id=t,this.booking_id=n}}class ln{constructor(t=0,n="",i="",o="",e="",s="",r="",a="",c="",d="",p=""){this.id=t,this.firstname=n,this.lastname=i,this.gender=o,this.date_of_birth=e,this.place_of_birth=s,this.email=r,this.phone=a,this.address=c,this.country=d,this.rental_unit_id=p}}class gn{constructor(t=0,n="",i="",o=0){this.id=t,this.name=n,this.code=i,this.capacity=o}}let hn=(()=>{class t{constructor(t,n,i,o,e){this.api=t,this.cd=n,this.context=i,this.zone=o,this.snack=e,this.composition=new un,this.composition_items={},this.rental_units=[],this.selection=[],this.dragging=!1}ngOnInit(){}ngOnChanges(t){return(0,p.mG)(this,void 0,void 0,function*(){if(t.composition_id)try{const t=yield this.api.read("sale\\booking\\Composition",[this.composition_id],Object.getOwnPropertyNames(new un));if(t.length){this.composition=t[0];{const t=yield this.load(Object.getOwnPropertyNames(new ln));for(let n of t)this.composition_items.hasOwnProperty(n.rental_unit_id)||(this.composition_items[n.rental_unit_id]=[]),this.composition_items[n.rental_unit_id].push(n)}console.log(this.composition_items);{const t=yield this.api.read("lodging\\realestate\\RentalUnit",Object.keys(this.composition_items),Object.getOwnPropertyNames(new gn));this.rental_units=t}console.log(this.rental_units)}}catch(n){console.warn(n),this.snack.open("unknonw error")}})}onToggle(t,n){console.log("selecting",t,n),n.hasOwnProperty("selected")||(n.selected=!1);let i=n.rental_unit_id;if(n.selected)n.selected=!1;else{for(let t of Object.keys(this.composition_items))if(t!=i)for(let n in this.composition_items[t])this.composition_items[t][n].selected=!1;n.selected=!0}this.selection=this.composition_items[i].filter(t=>t.selected),console.log(this.selection)}onDragStart(t){this.dragging=!0}onDrop(t){if(t.previousContainer!=t.container){console.log("from",t.previousContainer.data,"to",t.container.data);let n=t.currentIndex,i=t.container.data,o=t.previousContainer.data;for(let t of this.selection){let e=this.composition_items[o].findIndex(n=>n.id==t.id);(0,h.EA)(this.composition_items[o],this.composition_items[i],e,n),++n,t.rental_unit_id=i,t.selected=!1}this.selection=[]}this.dragging=!1,console.log("dropped",t)}onOpenRentalUnit(t){this.context.change({context:{entity:"lodging\\realestate\\RentalUnit",type:"form",name:"default",domain:["id","=",t],mode:"view",purpose:"view",target:"#sb-composition-container",callback:t=>{}}})}onOpenCompositionItem(t){this.context.change({context:{entity:"sale\\booking\\CompositionItem",type:"form",name:"default",domain:["id","=",t],mode:"edit",purpose:"view",target:"#sb-composition-container",callback:t=>{}}})}load(t){return(0,p.mG)(this,void 0,void 0,function*(){return yield this.api.collect("sale\\booking\\CompositionItem",["composition_id","=",this.composition.id],t,"id","asc",0,500)})}}return t.\u0275fac=function(n){return new(n||t)(c.Y36(r.sM),c.Y36(c.sBO),c.Y36(r.Ob),c.Y36(c.R0b),c.Y36(g.ux))},t.\u0275cmp=c.Xpm({type:t,selectors:[["booking-composition-lines"]],inputs:{composition_id:"composition_id"},features:[c.TTD],decls:11,vars:5,consts:[[3,"var"],["vUnit","var"],[2,"width","25%"],["colspan","2"],["cdkDropListGroup",""],[4,"ngFor","ngForOf"],[2,"display","flex"],[1,"cell",2,"flex","0 1 66%"],[1,"cell",2,"margin-left","auto"],["mat-icon-button","",3,"click"],[2,"width","8%","text-align","center"],[1,"cell"],[1,"part"],[1,"part-toggle"],["mat-icon-button","",3,"click",4,"ngIf"],["cdkDropList","",1,"part-container",3,"id","cdkDropListData","cdkDropListDropped"],[4,"ngIf"],["class","composition-container",4,"ngIf"],[2,"font-size","15px"],[1,"composition-container"],[1,"composition-container-header"],[1,"composition-container-column","header"],["cdkDrag","","class","composition-container-item",3,"selected","dragging","cdkDragDisabled","click","cdkDragStarted",4,"ngFor","ngForOf"],["cdkDrag","",1,"composition-container-item",3,"cdkDragDisabled","click","cdkDragStarted"],["class","drag-preview",4,"cdkDragPreview"],[1,"composition-container-column"],[1,"composition-container-column",2,"text-align","right"],[1,"drag-preview"],[1,"drag-preview-inner"]],template:function(t,n){1&t&&(c._UZ(0,"div",0,1),c.TgZ(2,"table"),c.TgZ(3,"thead"),c.TgZ(4,"tr"),c.TgZ(5,"th",2),c._uU(6,"Unit\xe9 locative"),c.qZA(),c.TgZ(7,"th",3),c._uU(8,"occupation"),c.qZA(),c.qZA(),c.qZA(),c.TgZ(9,"tbody",4),c.YNc(10,cn,20,10,"tr",5),c.qZA(),c.qZA()),2&t&&(c.Q6J("var",c.VKq(3,pn,c.DdM(2,dn))),c.xp6(10),c.Q6J("ngForOf",n.rental_units))},directives:[r.gC,h.Fd,f.sg,m.lW,_.Hw,f.O5,h.Wj,h.Zt,h.pV],styles:["[_nghost-%COMP%]{width:100%;height:100%;overflow:hidden;box-sizing:border-box}[_nghost-%COMP%]   .composition-container[_ngcontent-%COMP%]{border:1px solid #ccc;min-height:60px;background:#fff;border-radius:4px;overflow:hidden;display:block}[_nghost-%COMP%]   .composition-container[_ngcontent-%COMP%]   .composition-container-header[_ngcontent-%COMP%]{display:flex;padding:12px}[_nghost-%COMP%]   .composition-container[_ngcontent-%COMP%]   .composition-container-column[_ngcontent-%COMP%]{flex:1}[_nghost-%COMP%]   .composition-container[_ngcontent-%COMP%]   .composition-container-column.header[_ngcontent-%COMP%]{font-weight:500}[_nghost-%COMP%]   .composition-container[_ngcontent-%COMP%]   .composition-container-item[_ngcontent-%COMP%]{display:flex;padding:5px 10px;border-bottom:1px solid #ccc;color:#000000de;flex-direction:row;align-items:center;justify-content:space-between;box-sizing:border-box;cursor:move;background:#fff;font-size:14px}[_nghost-%COMP%]   .composition-container[_ngcontent-%COMP%]   .composition-container-item[_ngcontent-%COMP%]:last-child{border:none}[_nghost-%COMP%]   .composition-container[_ngcontent-%COMP%]   .composition-container-item.selected[_ngcontent-%COMP%]{background-color:#f5f5ff}[_nghost-%COMP%]   .composition-container[_ngcontent-%COMP%]   .composition-container-item.selected.dragging[_ngcontent-%COMP%]{opacity:.5}[_nghost-%COMP%]   table[_ngcontent-%COMP%]{border-spacing:0;width:100%;border:1px solid #e0e0e0}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{min-width:30px;width:30px}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:first-child, [_nghost-%COMP%]   table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]:first-child{padding-left:2px}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:last-child, [_nghost-%COMP%]   table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]:last-child{padding-right:2px}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]{height:45px}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   td[_ngcontent-%COMP%], [_nghost-%COMP%]   table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{text-align:center;border-right:1px solid #e0e0e0;border-bottom:1px solid #e0e0e0;font-weight:500;color:#000}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{position:sticky;top:0;background:#fff;z-index:1;box-shadow:0 3px 5px 0 #0000001a!important}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:last-child{border-right:0}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]:last-child{box-shadow:0 3px 5px 0 #0000001a!important}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]:last-child   td[_ngcontent-%COMP%]{border-bottom:0}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:12px;border-right:1px solid #e0e0e0;border-bottom:1px solid #e0e0e0;vertical-align:top}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]   .cell[_ngcontent-%COMP%]{min-height:45px;line-height:45px}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]   .part[_ngcontent-%COMP%]{display:flex}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]   .part[_ngcontent-%COMP%]   .part-toggle[_ngcontent-%COMP%]{flex:0 1;display:inline-block;vertical-align:top;padding:5px 0 0 20px}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]   .part[_ngcontent-%COMP%]   .part-container[_ngcontent-%COMP%]{flex:1;display:inline-block;width:100%;padding-top:12px}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:last-child{border-right:0}[_nghost-%COMP%]   table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]:last-child   td[_ngcontent-%COMP%]{border-bottom:0}.drag-preview[_ngcontent-%COMP%]{padding-left:20px}.drag-preview[_ngcontent-%COMP%]   .drag-preview-inner[_ngcontent-%COMP%]{background:#ff4081;color:#fff;font-weight:700;padding:5px;border-radius:50%;width:30px;height:30px;text-align:center;display:inline-block}.cdk-drop-list-dragging[_ngcontent-%COMP%]   .cdk-drag[_ngcontent-%COMP%]{transition:transform .25s cubic-bezier(0,0,.2,1)}"]}),t})();function mn(t,n){1&t&&c._UZ(0,"mat-spinner")}function _n(t,n){if(1&t&&c._UZ(0,"booking-composition-lines",14),2&t){const t=c.oxw();c.Q6J("composition_id",t.booking.composition_id)}}function fn(t,n){if(1&t){const t=c.EpF();c.TgZ(0,"span",15),c.NdJ("click",function(){return c.CHM(t),c.oxw().viewFullList()}),c._uU(1,"Listing complet"),c.qZA()}}const vn=function(t){return{hidden:t}};class Zn{constructor(t=0,n="",i=0){this.id=t,this.name=n,this.composition_id=i}}let Cn=(()=>{class t{constructor(t,n,i,o,e){this.dialog=t,this.api=n,this.route=i,this.context=o,this.zone=e,this.showSbContainer=!1,this.selectedTabIndex=0,this.loading=!0,this.booking=new Zn}ngAfterContentInit(){this.loading=!1,$("#sb-composition-container").on("_close",(t,n)=>{this.zone.run(()=>{console.log("hiding container"),this.showSbContainer=!1,this.selectedTabIndex=0})}),$("#sb-composition-container").on("_open",(t,n)=>{this.zone.run(()=>{console.log("showing container"),this.showSbContainer=!0})})}ngOnInit(){this.route.params.subscribe(t=>(0,p.mG)(this,void 0,void 0,function*(){if(t&&t.hasOwnProperty("id"))try{this.booking_id=t.id;const n=yield this.load(Object.getOwnPropertyNames(new Zn));this.booking=new Zn(n.id,n.name,n.composition_id)}catch(n){console.warn(n)}}))}load(t){return(0,p.mG)(this,void 0,void 0,function*(){const n=yield this.api.read("lodging\\sale\\booking\\Booking",[this.booking_id],t);return n&&n.length?n[0]:{}})}viewFullList(){this.selectedTabIndex=1,this.context.change({context:{entity:"sale\\booking\\CompositionItem",type:"list",name:"default",domain:["composition_id","=",this.booking.composition_id],mode:"view",purpose:"view",target:"#sb-composition-container",callback:t=>{}}})}onGenerate(){this.dialog.open(kn,{width:"50vw",data:{booking:this.booking}}).afterClosed().subscribe(t=>{t?console.log("answer is yes"):console.log("answer is no")})}}return t.\u0275fac=function(n){return new(n||t)(c.Y36(l.uw),c.Y36(r.sM),c.Y36(a.gz),c.Y36(r.Ob),c.Y36(c.R0b))},t.\u0275cmp=c.Xpm({type:t,selectors:[["booking-composition"]],decls:20,vars:7,consts:[[1,"container",3,"ngClass"],[1,"booking-header"],[1,"booking-body"],[2,"display","flex"],[2,"flex","0 1 20%"],[2,"margin-left","auto"],["mat-stroked-button","","color","primary",3,"click"],[3,"selectedIndex"],["label","Listing par Unit\xe9 locative"],[2,"margin-top","20px"],[4,"ngIf"],[3,"composition_id",4,"ngIf"],["mat-tab-label",""],["id","sb-composition-container",1,"sb-container"],[3,"composition_id"],[3,"click"]],template:function(t,n){1&t&&(c.TgZ(0,"div",0),c.TgZ(1,"div",1),c._uU(2,"Composition "),c.TgZ(3,"span"),c._uU(4," \u203a "),c.qZA(),c._uU(5),c.qZA(),c.TgZ(6,"div",2),c.TgZ(7,"div",3),c._UZ(8,"div",4),c.TgZ(9,"div",5),c.TgZ(10,"button",6),c.NdJ("click",function(){return n.onGenerate()}),c._uU(11,"G\xe9n\xe9rer la composition"),c.qZA(),c.qZA(),c.qZA(),c.TgZ(12,"mat-tab-group",7),c.TgZ(13,"mat-tab",8),c.TgZ(14,"div",9),c.YNc(15,mn,1,0,"mat-spinner",10),c.YNc(16,_n,1,1,"booking-composition-lines",11),c.qZA(),c.qZA(),c.TgZ(17,"mat-tab"),c.YNc(18,fn,2,0,"ng-template",12),c.qZA(),c.qZA(),c.qZA(),c.qZA(),c._UZ(19,"div",13)),2&t&&(c.Q6J("ngClass",c.VKq(5,vn,n.showSbContainer)),c.xp6(5),c.hij(" R\xe9servation ",n.booking.name,""),c.xp6(7),c.Q6J("selectedIndex",n.selectedTabIndex),c.xp6(3),c.Q6J("ngIf",n.loading),c.xp6(1),c.Q6J("ngIf",!n.loading))},directives:[f.mk,m.lW,Kt.SP,Kt.uX,f.O5,Kt.uD,tn.$g,hn],styles:["[_nghost-%COMP%]{width:100%;height:100%;overflow:hidden;box-sizing:border-box}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]{height:100%;width:100%}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{text-transform:uppercase}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]   .booking-header[_ngcontent-%COMP%]{width:100%;padding-left:12px;height:48px;line-height:48px;border-bottom:1px solid #d3d3d3;font-size:22px}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]   .booking-body[_ngcontent-%COMP%]{height:calc(100vh - 123px);width:100%;overflow-y:scroll;padding:12px}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]   .booking-body[_ngcontent-%COMP%]::-webkit-scrollbar{width:6px;overflow-y:scroll;background:#0000}[_nghost-%COMP%]   .container[_ngcontent-%COMP%]   .booking-body[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:var(--mdc-theme-primary,#6200ee);border-radius:10px}[_nghost-%COMP%]   .container.hidden[_ngcontent-%COMP%]{display:none}"]}),t})(),kn=(()=>{class t{constructor(t,n){this.dialogRef=t,this.data=n}}return t.\u0275fac=function(n){return new(n||t)(c.Y36(l.so),c.Y36(l.WI))},t.\u0275cmp=c.Xpm({type:t,selectors:[["dialog-booking-composition-generate-confirm-dialog"]],decls:18,vars:3,consts:[["mat-dialog-title",""],["mat-dialog-content",""],["mat-dialog-actions",""],["mat-button","",3,"mat-dialog-close"],["mat-button","","cdkFocusInitial","",3,"mat-dialog-close"]],template:function(t,n){1&t&&(c.TgZ(0,"h1",0),c._uU(1,"G\xe9n\xe9rer la composition"),c.qZA(),c.TgZ(2,"div",1),c.TgZ(3,"p"),c._uU(4,"Cet assistant g\xe9n\xe9rera une composition sur base de la r\xe9servation "),c.TgZ(5,"b"),c._uU(6),c.qZA(),c._uU(7,"."),c.qZA(),c.TgZ(8,"p"),c._uU(9,"Les d\xe9tails de la composition existante seront remplac\xe9s et les \xe9ventuels changements effectu\xe9s seront perdus."),c.qZA(),c.TgZ(10,"p"),c.TgZ(11,"b"),c._uU(12,"Confirmez-vous la (re)g\xe9n\xe9ration ?"),c.qZA(),c.qZA(),c.qZA(),c.TgZ(13,"div",2),c.TgZ(14,"button",3),c._uU(15,"Annuler"),c.qZA(),c.TgZ(16,"button",4),c._uU(17,"Cr\xe9er"),c.qZA(),c.qZA()),2&t&&(c.xp6(6),c.Oqu(n.data.booking.name),c.xp6(8),c.Q6J("mat-dialog-close",!1),c.xp6(2),c.Q6J("mat-dialog-close",!0))},directives:[l.uh,l.xY,l.H8,m.lW,l.ZT],encapsulation:2}),t})();const bn=[{path:"",component:d},{path:"edit/:id",component:Xt},{path:"edit",component:Xt},{path:"composition/:id",component:Cn}];let xn=(()=>{class t{}return t.\u0275fac=function(n){return new(n||t)},t.\u0275mod=c.oAB({type:t}),t.\u0275inj=c.cJS({imports:[[a.Bz.forChild(bn)],a.Bz]}),t})(),On=(()=>{class t{}return t.\u0275fac=function(n){return new(n||t)},t.\u0275mod=c.oAB({type:t}),t.\u0275inj=c.cJS({providers:[{provide:o._A,useClass:s.e,deps:[o.Ad,e.t4]}],imports:[[r._e,xn]]}),t})()}}]);